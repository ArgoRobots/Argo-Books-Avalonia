<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:controls="using:ArgoBooks.Controls"
             xmlns:loc="using:ArgoBooks.Localization"
             xmlns:converters="using:ArgoBooks.Converters"
             xmlns:local="using:ArgoBooks"
             mc:Ignorable="d" d:DesignWidth="300" d:DesignHeight="300"
             x:Class="ArgoBooks.Controls.SearchableDropdown"
             x:DataType="controls:SearchableDropdown"
             Focusable="True">

    <UserControl.Resources>
        <converters:HighlightBrushMultiConverter x:Key="HighlightBrushMultiConverter" />
        <converters:HighlightBorderBrushMultiConverter x:Key="HighlightBorderBrushMultiConverter" />
        <converters:HighlightBorderThicknessMultiConverter x:Key="HighlightBorderThicknessMultiConverter" />
        <converters:DisplayMemberMultiConverter x:Key="DisplayMemberMultiConverter" />
    </UserControl.Resources>

    <StackPanel Spacing="4">
        <!-- Label -->
        <StackPanel Orientation="Horizontal" Spacing="4"
                    IsVisible="{Binding Label, RelativeSource={RelativeSource AncestorType=controls:SearchableDropdown}, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
            <TextBlock Text="{Binding Label, RelativeSource={RelativeSource AncestorType=controls:SearchableDropdown}}"
                       FontSize="{StaticResource FontSizeSm}"
                       FontWeight="Medium"
                       Foreground="{DynamicResource TextSecondaryBrush}" />
            <TextBlock Text="*"
                       FontSize="{StaticResource FontSizeSm}"
                       Foreground="{DynamicResource ErrorBrush}"
                       IsVisible="{Binding IsRequired, RelativeSource={RelativeSource AncestorType=controls:SearchableDropdown}}" />
        </StackPanel>

        <!-- Empty State Container (shown when no items available) -->
        <Border x:Name="EmptyStateBorder"
                CornerRadius="{StaticResource RadiusMd}"
                BorderThickness="1"
                Background="{DynamicResource SurfaceAltBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                Padding="8,6"
                MinHeight="{StaticResource FormControlHeightCompact}"
                IsVisible="{Binding ShowEmptyCreate, RelativeSource={RelativeSource AncestorType=controls:SearchableDropdown}}">
            <StackPanel Orientation="Horizontal" Spacing="8">
                <TextBlock Text="{Binding EmptyMessage, RelativeSource={RelativeSource AncestorType=controls:SearchableDropdown}}"
                           FontSize="13"
                           Foreground="{DynamicResource TextTertiaryBrush}"
                           VerticalAlignment="Center" />
                <Button Classes="link-button"
                        Content="{Binding EmptyCreateLinkText, RelativeSource={RelativeSource AncestorType=controls:SearchableDropdown}}"
                        Command="{Binding EmptyCreateCommand, RelativeSource={RelativeSource AncestorType=controls:SearchableDropdown}}"
                        VerticalAlignment="Center" />
            </StackPanel>
        </Border>

        <!-- Dropdown Container (hidden when no items available) -->
        <Border x:Name="DropdownBorder"
                CornerRadius="{StaticResource RadiusMd}"
                BorderThickness="1"
                Background="{DynamicResource SurfaceBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                MinHeight="{StaticResource FormControlHeightCompact}"
                Classes.error="{Binding HasError, RelativeSource={RelativeSource AncestorType=controls:SearchableDropdown}}"
                Classes.focused="{Binding IsDropdownOpen, RelativeSource={RelativeSource AncestorType=controls:SearchableDropdown}}"
                IsVisible="{Binding !ShowEmptyCreate, RelativeSource={RelativeSource AncestorType=controls:SearchableDropdown}}">
            <Border.Styles>
                <Style Selector="Border.error">
                    <Setter Property="BorderBrush" Value="{DynamicResource ErrorBrush}" />
                </Style>
                <Style Selector="Border.focused:not(.error)">
                    <Setter Property="BorderBrush" Value="{DynamicResource PrimaryBrush}" />
                </Style>
                <Style Selector="Border:pointerover:not(.focused):not(.error)">
                    <Setter Property="BorderBrush" Value="{DynamicResource BorderHoverBrush}" />
                </Style>
            </Border.Styles>

            <Grid ColumnDefinitions="*,Auto">
                <!-- Search TextBox -->
                <TextBox x:Name="SearchTextBox"
                         Grid.Column="0"
                         Text="{Binding SearchText, RelativeSource={RelativeSource AncestorType=controls:SearchableDropdown}, Mode=TwoWay}"
                         Watermark="{Binding Placeholder, RelativeSource={RelativeSource AncestorType=controls:SearchableDropdown}}"
                         Background="Transparent"
                         BorderThickness="0"
                         Padding="8,6"
                         VerticalAlignment="Center" />

                <!-- Dropdown Arrow -->
                <Button Grid.Column="1"
                        Classes="icon"
                        Width="32" Height="32"
                        Margin="0,0,4,0"
                        Command="{Binding ToggleDropdownCommand, RelativeSource={RelativeSource AncestorType=controls:SearchableDropdown}}">
                    <PathIcon Data="M7 10l5 5 5-5z"
                              Width="16" Height="16"
                              Foreground="{DynamicResource TextTertiaryBrush}">
                        <PathIcon.Styles>
                            <Style Selector="PathIcon">
                                <Setter Property="RenderTransform" Value="rotate(0deg)" />
                            </Style>
                        </PathIcon.Styles>
                    </PathIcon>
                </Button>
            </Grid>
        </Border>

        <!-- Dropdown Popup -->
        <Popup x:Name="DropdownPopup"
               IsOpen="{Binding IsDropdownOpen, RelativeSource={RelativeSource AncestorType=controls:SearchableDropdown}, Mode=TwoWay}"
               PlacementTarget="{Binding #DropdownBorder}"
               Placement="Bottom"
               PlacementGravity="BottomLeft"
               IsLightDismissEnabled="True"
               WindowManagerAddShadowHint="True">

            <Border Background="{DynamicResource SurfaceBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1"
                    CornerRadius="{StaticResource RadiusMd}"
                    MinWidth="{Binding #DropdownBorder.Bounds.Width}"
                    MaxHeight="300"
                    Margin="0,4,0,0"
                    BoxShadow="0 4 12 0 #20000000">

                <DockPanel>
                    <!-- Add New Button - use $parent syntax to traverse across Popup boundary -->
                    <Button DockPanel.Dock="Bottom"
                            Classes="ghost"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Left"
                            Padding="12,10"
                            IsVisible="{Binding $parent[controls:SearchableDropdown].ShowAddNew}"
                            Command="{Binding $parent[controls:SearchableDropdown].AddNewCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <PathIcon Data="{x:Static local:Icons.Add}"
                                      Width="16" Height="16"
                                      Foreground="{DynamicResource PrimaryBrush}" />
                            <TextBlock Text="{Binding $parent[controls:SearchableDropdown].AddNewText}"
                                       Foreground="{DynamicResource PrimaryBrush}"
                                       FontWeight="Medium" />
                        </StackPanel>
                    </Button>

                    <!-- Separator when Add New is visible -->
                    <Border DockPanel.Dock="Bottom"
                            Height="1"
                            Background="{DynamicResource BorderLightBrush}"
                            IsVisible="{Binding $parent[controls:SearchableDropdown].ShowAddNew}" />

                    <!-- Items List -->
                    <ScrollViewer x:Name="ItemsScrollViewer"
                                  HorizontalScrollBarVisibility="Disabled"
                                  VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <!-- No Results Message -->
                            <TextBlock Text="{loc:Loc 'No results found'}"
                                       FontSize="{StaticResource FontSizeSm}"
                                       Foreground="{DynamicResource TextTertiaryBrush}"
                                       Padding="12,16"
                                       HorizontalAlignment="Center"
                                       IsVisible="{Binding !$parent[controls:SearchableDropdown].HasAnyFilteredItems}" />

                            <!-- Priority Items -->
                            <ItemsControl ItemsSource="{Binding $parent[controls:SearchableDropdown].FilteredPriorityItems}"
                                          IsVisible="{Binding $parent[controls:SearchableDropdown].HasFilteredPriorityItems}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Classes="ghost"
                                                HorizontalAlignment="Stretch"
                                                HorizontalContentAlignment="Left"
                                                Padding="12,10"
                                                Tag="{Binding}"
                                                Command="{Binding $parent[controls:SearchableDropdown].SelectItemCommand}"
                                                CommandParameter="{Binding}">
                                            <Button.Background>
                                                <MultiBinding Converter="{StaticResource HighlightBrushMultiConverter}">
                                                    <Binding Path="." />
                                                    <Binding Path="$parent[controls:SearchableDropdown].HighlightedItem" />
                                                </MultiBinding>
                                            </Button.Background>
                                            <Button.BorderBrush>
                                                <MultiBinding Converter="{StaticResource HighlightBorderBrushMultiConverter}">
                                                    <Binding Path="." />
                                                    <Binding Path="$parent[controls:SearchableDropdown].HighlightedItem" />
                                                </MultiBinding>
                                            </Button.BorderBrush>
                                            <Button.BorderThickness>
                                                <MultiBinding Converter="{StaticResource HighlightBorderThicknessMultiConverter}">
                                                    <Binding Path="." />
                                                    <Binding Path="$parent[controls:SearchableDropdown].HighlightedItem" />
                                                </MultiBinding>
                                            </Button.BorderThickness>
                                            <TextBlock>
                                                <TextBlock.Text>
                                                    <MultiBinding Converter="{StaticResource DisplayMemberMultiConverter}">
                                                        <Binding Path="." />
                                                        <Binding Path="$parent[controls:SearchableDropdown].DisplayMemberPath" />
                                                    </MultiBinding>
                                                </TextBlock.Text>
                                            </TextBlock>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <!-- Separator between priority and regular items -->
                            <Border Height="1"
                                    Background="{DynamicResource BorderLightBrush}"
                                    Margin="12,4"
                                    IsVisible="{Binding $parent[controls:SearchableDropdown].ShowPrioritySeparator}" />

                            <!-- Filtered Items -->
                            <ItemsControl ItemsSource="{Binding $parent[controls:SearchableDropdown].FilteredItems}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Classes="ghost"
                                                HorizontalAlignment="Stretch"
                                                HorizontalContentAlignment="Left"
                                                Padding="12,10"
                                                Tag="{Binding}"
                                                Command="{Binding $parent[controls:SearchableDropdown].SelectItemCommand}"
                                                CommandParameter="{Binding}">
                                            <Button.Background>
                                                <MultiBinding Converter="{StaticResource HighlightBrushMultiConverter}">
                                                    <Binding Path="." />
                                                    <Binding Path="$parent[controls:SearchableDropdown].HighlightedItem" />
                                                </MultiBinding>
                                            </Button.Background>
                                            <Button.BorderBrush>
                                                <MultiBinding Converter="{StaticResource HighlightBorderBrushMultiConverter}">
                                                    <Binding Path="." />
                                                    <Binding Path="$parent[controls:SearchableDropdown].HighlightedItem" />
                                                </MultiBinding>
                                            </Button.BorderBrush>
                                            <Button.BorderThickness>
                                                <MultiBinding Converter="{StaticResource HighlightBorderThicknessMultiConverter}">
                                                    <Binding Path="." />
                                                    <Binding Path="$parent[controls:SearchableDropdown].HighlightedItem" />
                                                </MultiBinding>
                                            </Button.BorderThickness>
                                            <TextBlock>
                                                <TextBlock.Text>
                                                    <MultiBinding Converter="{StaticResource DisplayMemberMultiConverter}">
                                                        <Binding Path="." />
                                                        <Binding Path="$parent[controls:SearchableDropdown].DisplayMemberPath" />
                                                    </MultiBinding>
                                                </TextBlock.Text>
                                            </TextBlock>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </ScrollViewer>
                </DockPanel>
            </Border>
        </Popup>

        <!-- Helper Text / Error Message -->
        <TextBlock FontSize="12"
                   Margin="0,2,0,0"
                   Foreground="{DynamicResource TextTertiaryBrush}"
                   Text="{Binding HelperText, RelativeSource={RelativeSource AncestorType=controls:SearchableDropdown}}"
                   IsVisible="{Binding HelperText, RelativeSource={RelativeSource AncestorType=controls:SearchableDropdown}, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />

        <TextBlock FontSize="12"
                   Margin="0,2,0,0"
                   Foreground="{DynamicResource ErrorBrush}"
                   Text="{Binding ErrorMessage, RelativeSource={RelativeSource AncestorType=controls:SearchableDropdown}}"
                   IsVisible="{Binding HasError, RelativeSource={RelativeSource AncestorType=controls:SearchableDropdown}}" />
    </StackPanel>

</UserControl>
