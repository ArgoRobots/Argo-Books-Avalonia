<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ArgoBooks.ViewModels"
             xmlns:controls="using:ArgoBooks.Controls"
             xmlns:behaviors="using:ArgoBooks.Behaviors"
             xmlns:local="using:ArgoBooks.Converters"
             xmlns:icons="using:ArgoBooks"
             xmlns:loc="using:ArgoBooks.Localization"
             xmlns:html="clr-namespace:TheArtOfDev.HtmlRenderer.Avalonia;assembly=Avalonia.HtmlRenderer"
             mc:Ignorable="d" d:DesignWidth="1280" d:DesignHeight="800"
             x:Class="ArgoBooks.Modals.InvoiceModals"
             x:DataType="vm:InvoiceModalsViewModel">

    <Design.DataContext>
        <vm:InvoiceModalsViewModel />
    </Design.DataContext>

    <Panel>
        <!-- ======================= CREATE / EDIT INVOICE MODAL ======================= -->
        <controls:ModalOverlay IsOpen="{Binding IsCreateEditModalOpen}">
            <controls:ModalOverlay.ModalContent>
                <Border HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Width="{Binding IsShowingPreview, Converter={x:Static local:BoolConverters.ToWidth}, ConverterParameter='850,750'}"
                    Height="{Binding IsShowingPreview, Converter={x:Static local:BoolConverters.ToHeight}, ConverterParameter='700,700'}"
                    Background="{DynamicResource SurfaceBrush}"
                    CornerRadius="12"
                    BoxShadow="0 8 32 0 #40000000">
                <Grid RowDefinitions="Auto,*,Auto,Auto">
                    <!-- Header - Edit Mode -->
                    <Border Grid.Row="0"
                            Padding="24,16"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="0,0,0,1"
                            IsVisible="{Binding !IsShowingPreview}">
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Grid.Column="0"
                                       Text="{Binding ModalTitle}"
                                       FontSize="18"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                       VerticalAlignment="Center" />
                            <Button Grid.Column="1"
                                    Classes="icon-button"
                                    Command="{Binding CloseCreateEditModalCommand}">
                                <PathIcon Data="{x:Static icons:Icons.Close}"
                                          Width="20" Height="20" />
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Header - Preview Mode -->
                    <Border Grid.Row="0"
                            Padding="24,16"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="0,0,0,1"
                            IsVisible="{Binding IsShowingPreview}">
                        <Grid ColumnDefinitions="*,Auto,Auto">
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="{loc:Loc 'Invoice Preview'}" FontSize="18" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" />
                                <TextBlock Text="{loc:Loc 'Review your invoice before sending'}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" />
                            </StackPanel>
                            <Button Grid.Column="1" Classes="secondary-button" Command="{Binding OpenPreviewInBrowserCommand}" Margin="0,0,12,0">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <PathIcon Data="{x:Static icons:Icons.OpenInNew}" Width="14" Height="14" />
                                    <TextBlock Text="{loc:Loc 'Open in Browser'}" />
                                </StackPanel>
                            </Button>
                            <Button Grid.Column="2" Classes="icon-button" Command="{Binding CloseCreateEditModalCommand}">
                                <PathIcon Data="{x:Static icons:Icons.Close}" Width="20" Height="20" />
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Content - Edit Mode -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" IsVisible="{Binding !IsShowingPreview}">
                        <StackPanel Margin="24" Spacing="20">
                            <!-- Template and Customer Row -->
                            <Grid ColumnDefinitions="*,16,*">
                                <!-- Template Selection (left) -->
                                <StackPanel Grid.Column="0" Spacing="6">
                                    <TextBlock Text="{loc:Loc 'Email Template'}"
                                               FontSize="13"
                                               FontWeight="Medium"
                                               Foreground="{DynamicResource TextSecondaryBrush}" />
                                    <ComboBox ItemsSource="{Binding TemplateOptions}"
                                              SelectedItem="{Binding SelectedTemplate}"
                                              Classes="form-combobox"
                                              HorizontalAlignment="Stretch">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                    <Border Width="16" Height="16"
                                                            CornerRadius="3"
                                                            Background="{Binding PrimaryColor}" />
                                                    <TextBlock Text="{Binding Name}" />
                                                </StackPanel>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </StackPanel>

                                <!-- Customer Selection (right) -->
                                <StackPanel Grid.Column="2" Spacing="6">
                                    <TextBlock FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextSecondaryBrush}">
                                        <Run Text="{loc:Loc Customer}" /><Run Text=" *" Foreground="#dc2626" />
                                    </TextBlock>
                                    <controls:SearchableDropdown ItemsSource="{Binding CustomerOptions}"
                                                                SelectedItem="{Binding SelectedCustomer}"
                                                                DisplayMemberPath="Name"
                                                                Placeholder="{loc:Loc 'Search for a customer...'}"
                                                                IsRequired="True"
                                                                HasError="{Binding HasCustomerError}"
                                                                ErrorMessage="{loc:Loc 'Please select a customer'}"
                                                                ShowAddNew="False"
                                                                EmptyMessage="{loc:Loc 'No customers found.'}"
                                                                EmptyCreateLinkText="{loc:Loc 'Create one'}"
                                                                EmptyCreateCommand="{Binding NavigateToCreateCustomerCommand}" />
                                </StackPanel>
                            </Grid>

                            <!-- Dates Row -->
                            <Grid ColumnDefinitions="*,16,*">
                                <!-- Issue Date -->
                                <StackPanel Grid.Column="0" Spacing="6">
                                    <TextBlock FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextSecondaryBrush}">
                                        <Run Text="{loc:Loc 'Issue Date'}" /><Run Text=" *" Foreground="#dc2626" />
                                    </TextBlock>
                                    <DatePicker SelectedDate="{Binding ModalIssueDate}"
                                                Classes="form-datepicker"
                                                HorizontalAlignment="Stretch" />
                                </StackPanel>

                                <!-- Due Date -->
                                <StackPanel Grid.Column="2" Spacing="6">
                                    <TextBlock FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextSecondaryBrush}">
                                        <Run Text="{loc:Loc 'Due Date'}" /><Run Text=" *" Foreground="#dc2626" />
                                    </TextBlock>
                                    <DatePicker SelectedDate="{Binding ModalDueDate}"
                                                Classes="form-datepicker"
                                                HorizontalAlignment="Stretch" />
                                </StackPanel>
                            </Grid>

                            <!-- Line Items Section -->
                            <StackPanel Spacing="12">
                                <Grid ColumnDefinitions="*,Auto">
                                    <TextBlock Grid.Column="0"
                                               Text="{loc:Loc 'Line Items'}"
                                               FontSize="14"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource TextPrimaryBrush}" />
                                    <Button Grid.Column="1"
                                            Classes="secondary-button"
                                            Command="{Binding AddLineItemCommand}">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <PathIcon Data="{x:Static icons:Icons.Add}"
                                                      Width="14" Height="14" />
                                            <TextBlock Text="{loc:Loc 'Add Item'}" />
                                        </StackPanel>
                                    </Button>
                                </Grid>

                                <!-- Line Items Header -->
                                <Border Background="{DynamicResource SurfaceAltBrush}"
                                        CornerRadius="6"
                                        Padding="12,8"
                                        IsVisible="{Binding LineItems.Count, Converter={x:Static local:IntConverters.IsPositive}}">
                                    <Grid ColumnDefinitions="2*,80,90,70,Auto">
                                        <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="0,0,8,0">
                                            <TextBlock Text="{loc:Loc Product}" FontSize="12" FontWeight="Medium"
                                                       Foreground="{DynamicResource TextTertiaryBrush}" />
                                            <TextBlock Text=" *" FontSize="12" FontWeight="Medium"
                                                       Foreground="{DynamicResource DangerBrush}" />
                                        </StackPanel>
                                        <TextBlock Grid.Column="1" Text="{loc:Loc Qty}" FontSize="12" FontWeight="Medium"
                                                   Foreground="{DynamicResource TextTertiaryBrush}"
                                                   HorizontalAlignment="Center"
                                                   Margin="0,0,8,0" />
                                        <TextBlock Grid.Column="2" Text="{loc:Loc Price}" FontSize="12" FontWeight="Medium"
                                                   Foreground="{DynamicResource TextTertiaryBrush}"
                                                   HorizontalAlignment="Center"
                                                   Margin="0,0,8,0" />
                                        <TextBlock Grid.Column="3" Text="{loc:Loc Amount}" FontSize="12" FontWeight="Medium"
                                                   Foreground="{DynamicResource TextTertiaryBrush}"
                                                   HorizontalAlignment="Right" />
                                        <TextBlock Grid.Column="4" Width="32" />
                                    </Grid>
                                </Border>

                                <!-- Line Items List -->
                                <ItemsControl ItemsSource="{Binding LineItems}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate DataType="vm:LineItemDisplayModel">
                                            <Border Padding="12,8"
                                                    BorderBrush="{DynamicResource BorderBrush}"
                                                    BorderThickness="0,0,0,1">
                                                <Grid ColumnDefinitions="2*,80,90,70,Auto">
                                                    <controls:SearchableDropdown Grid.Column="0"
                                                                 Margin="0,0,8,0"
                                                                 ItemsSource="{Binding $parent[ItemsControl].((vm:InvoiceModalsViewModel)DataContext).ProductOptions}"
                                                                 SelectedItem="{Binding SelectedProduct, Mode=TwoWay}"
                                                                 DisplayMemberPath="Name"
                                                                 Placeholder="{loc:Loc 'Search for a product...'}"
                                                                 ShowAddNew="False"
                                                                 EmptyMessage="{loc:Loc 'No products found.'}"
                                                                 EmptyCreateLinkText="{loc:Loc 'Create one'}"
                                                                 EmptyCreateCommand="{Binding $parent[ItemsControl].((vm:InvoiceModalsViewModel)DataContext).NavigateToCreateProductCommand}"
                                                                 HasError="{Binding HasProductError}"
                                                                 ErrorMessage="{loc:Loc 'Please select a product'}" />
                                                    <NumericUpDown Grid.Column="1"
                                                                   Value="{Binding Quantity, Mode=TwoWay}"
                                                                   Minimum="1"
                                                                   FormatString="0"
                                                                   Classes="line-item-input"
                                                                   ShowButtonSpinner="False"
                                                                   HorizontalAlignment="Stretch"
                                                                   VerticalAlignment="Top"
                                                                   Margin="0,0,8,0" />
                                                    <NumericUpDown Grid.Column="2"
                                                                   Value="{Binding UnitPrice, Mode=TwoWay}"
                                                                   Minimum="0"
                                                                   FormatString="N2"
                                                                   Classes="line-item-input"
                                                                   ShowButtonSpinner="False"
                                                                   HorizontalAlignment="Stretch"
                                                                   VerticalAlignment="Top"
                                                                   Margin="0,0,8,0" />
                                                    <TextBlock Grid.Column="3"
                                                               Text="{Binding AmountFormatted}"
                                                               FontSize="14"
                                                               FontWeight="Medium"
                                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                                               VerticalAlignment="Top"
                                                               HorizontalAlignment="Right"
                                                               Margin="0,10,0,0" />
                                                    <Button Grid.Column="4"
                                                            Classes="icon-button danger"
                                                            VerticalAlignment="Top"
                                                            Command="{Binding $parent[ItemsControl].((vm:InvoiceModalsViewModel)DataContext).RemoveLineItemCommand}"
                                                            CommandParameter="{Binding}"
                                                            ToolTip.Tip="{loc:Loc 'Remove item'}">
                                                        <PathIcon Data="{x:Static icons:Icons.Delete}"
                                                                  Width="14" Height="14" />
                                                    </Button>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                            </StackPanel>

                            <!-- Totals Section -->
                            <Border Background="{DynamicResource SurfaceAltBrush}"
                                    CornerRadius="8"
                                    Padding="16">
                                <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto,Auto">
                                    <TextBlock Grid.Row="0" Grid.Column="0"
                                               Text="{loc:Loc Subtotal}"
                                               FontSize="14"
                                               Foreground="{DynamicResource TextSecondaryBrush}" />
                                    <TextBlock Grid.Row="0" Grid.Column="1"
                                               Text="{Binding SubtotalFormatted}"
                                               FontSize="14"
                                               Foreground="{DynamicResource TextPrimaryBrush}" />

                                    <TextBlock Grid.Row="1" Grid.Column="0"
                                               Text="{loc:Loc Tax}"
                                               FontSize="14"
                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                               Margin="0,8,0,0" />
                                    <StackPanel Grid.Row="1" Grid.Column="1"
                                                Orientation="Horizontal"
                                                Spacing="8"
                                                HorizontalAlignment="Right"
                                                Margin="0,8,0,0">
                                        <NumericUpDown Value="{Binding TaxRate, Mode=TwoWay}"
                                                       Minimum="0"
                                                       Maximum="100"
                                                       FormatString="0.##"
                                                       Width="70"
                                                       ShowButtonSpinner="False"
                                                       Classes="line-item-input" />
                                        <TextBlock Text="%"
                                                   VerticalAlignment="Center"
                                                   Foreground="{DynamicResource TextSecondaryBrush}" />
                                        <TextBlock Text="{Binding TaxAmountFormatted}"
                                                   FontSize="14"
                                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                                   VerticalAlignment="Center"
                                                   Margin="16,0,0,0" />
                                    </StackPanel>

                                    <Border Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                            Height="1"
                                            Background="{DynamicResource BorderBrush}"
                                            Margin="0,12" />

                                    <TextBlock Grid.Row="3" Grid.Column="0"
                                               Text="{loc:Loc Total}"
                                               FontSize="16"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource TextPrimaryBrush}" />
                                    <TextBlock Grid.Row="3" Grid.Column="1"
                                               Text="{Binding TotalFormatted}"
                                               FontSize="16"
                                               FontWeight="Bold"
                                               Foreground="{DynamicResource PrimaryBrush}" />
                                </Grid>
                            </Border>

                            <!-- Status (only for Edit) -->
                            <StackPanel Spacing="6" IsVisible="{Binding IsEditMode}">
                                <TextBlock Text="{loc:Loc Status}" FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextSecondaryBrush}" />
                                <ComboBox ItemsSource="{Binding StatusOptions}"
                                          SelectedItem="{Binding ModalStatus}"
                                          Classes="form-combobox"
                                          HorizontalAlignment="Stretch">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Converter={StaticResource TranslateConverter}}" />
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </StackPanel>

                            <!-- Notes -->
                            <StackPanel Spacing="6">
                                <TextBlock Text="{loc:Loc Notes}" FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextSecondaryBrush}" />
                                <TextBox Text="{Binding ModalNotes, Mode=TwoWay}"
                                         Classes="form-input"
                                         AcceptsReturn="True"
                                         TextWrapping="Wrap"
                                         MinHeight="80"
                                         MaxHeight="120"
                                         Watermark="{loc:Loc 'Additional notes for this invoice...'}" />
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>

                    <!-- Content - Preview Mode (HTML Preview) -->
                    <Border Grid.Row="1" Margin="0" Background="#f3f4f6" ClipToBounds="True" IsVisible="{Binding IsShowingPreview}">
                        <ScrollViewer x:Name="PreviewScrollViewer"
                                      HorizontalScrollBarVisibility="Auto"
                                      VerticalScrollBarVisibility="Auto"
                                      HorizontalContentAlignment="Center"
                                      Padding="0">
                            <LayoutTransformControl x:Name="PreviewZoomTransformControl"
                                                    HorizontalAlignment="Center"
                                                    VerticalAlignment="Center">
                                <html:HtmlLabel x:Name="InvoiceHtmlPreview"
                                                Text="{Binding PreviewHtml}"
                                                Background="White"
                                                MinWidth="640"
                                                MaxWidth="700" />
                            </LayoutTransformControl>
                        </ScrollViewer>
                    </Border>

                    <!-- Zoom Controls - Preview Mode Only -->
                    <Border Grid.Row="2" Padding="16,8" Background="{DynamicResource SurfaceAltBrush}" IsVisible="{Binding IsShowingPreview}">
                        <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                            <Button Classes="icon-button" Click="PreviewZoomOut_Click" ToolTip.Tip="{loc:Loc 'Zoom Out'}">
                                <PathIcon Data="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zM7 9h5v1H7z" Width="16" Height="16" />
                            </Button>
                            <Slider x:Name="PreviewZoomSlider"
                                    Minimum="0.25"
                                    Maximum="3.0"
                                    Value="1.0"
                                    Width="120"
                                    ValueChanged="PreviewZoomSlider_ValueChanged" />
                            <Button Classes="icon-button" Click="PreviewZoomIn_Click" ToolTip.Tip="{loc:Loc 'Zoom In'}">
                                <PathIcon Data="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zm.5-7H9v2H7v1h2v2h1v-2h2V9h-2z" Width="16" Height="16" />
                            </Button>
                            <TextBlock x:Name="PreviewZoomPercentText" Text="100%" Width="45" TextAlignment="Center" VerticalAlignment="Center" Foreground="{DynamicResource TextSecondaryBrush}" />
                            <Button Classes="icon-button" Click="PreviewFitToWindow_Click" ToolTip.Tip="{loc:Loc 'Fit to Window'}">
                                <PathIcon Data="M5 15H3v4c0 1.1.9 2 2 2h4v-2H5v-4zM5 5h4V3H5c-1.1 0-2 .9-2 2v4h2V5zm14-2h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm0 16h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zM12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z" Width="16" Height="16" />
                            </Button>
                        </StackPanel>
                    </Border>

                    <!-- Footer - Edit Mode -->
                    <Border Grid.Row="3"
                            Padding="24,16"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="0,1,0,0"
                            IsVisible="{Binding !IsShowingPreview}">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <TextBlock Grid.Column="0"
                                       Text="{loc:Loc 'Please enter all required fields'}"
                                       Foreground="#DC2626"
                                       FontSize="13"
                                       VerticalAlignment="Center"
                                       IsVisible="{Binding HasValidationMessage}" />
                            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="12">
                                <Button Classes="secondary-button"
                                        Content="{loc:Loc Cancel}"
                                        Command="{Binding CloseCreateEditModalCommand}" />
                                <Button Classes="secondary-button"
                                        Content="{loc:Loc 'Save as Draft'}"
                                        Command="{Binding SaveAsDraftCommand}"
                                        IsVisible="{Binding !IsEditMode}" />
                                <!-- Preview button for new invoices -->
                                <Button Classes="primary-button"
                                        Content="{loc:Loc Preview}"
                                        Command="{Binding OpenPreviewModalCommand}"
                                        IsVisible="{Binding !IsEditMode}" />
                                <!-- Save Changes button for editing -->
                                <Button Classes="primary-button"
                                        Content="{loc:Loc 'Save Changes'}"
                                        Command="{Binding SaveInvoiceCommand}"
                                        IsVisible="{Binding IsEditMode}" />
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- Footer - Preview Mode -->
                    <Border Grid.Row="3" Padding="24,16" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0" IsVisible="{Binding IsShowingPreview}">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <TextBlock Grid.Column="0"
                                       Text="{loc:Loc 'An email will be sent to the customer'}"
                                       FontSize="13"
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       VerticalAlignment="Center" />
                            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="12">
                                <Button Classes="secondary-button" Content="{loc:Loc 'Back to Edit'}" Command="{Binding ClosePreviewModalCommand}" />
                                <Button Classes="primary-button" Content="{loc:Loc 'Create &amp; Send'}" Command="{Binding CreateAndSendInvoiceCommand}" />
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </Border>
            </controls:ModalOverlay.ModalContent>
        </controls:ModalOverlay>

        <!-- ======================= FILTER MODAL ======================= -->
        <controls:ModalOverlay IsOpen="{Binding IsFilterModalOpen}">
            <controls:ModalOverlay.ModalContent>
                <Border HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Width="700"
                        Background="{DynamicResource SurfaceBrush}"
                        CornerRadius="12"
                        BoxShadow="0 8 32 0 #40000000">
                <Grid RowDefinitions="Auto,*,Auto">
                    <!-- Header -->
                    <Border Grid.Row="0"
                            Padding="24,16"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="0,0,0,1">
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Grid.Column="0"
                                       Text="{loc:Loc 'Filter Invoices'}"
                                       FontSize="18"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                       VerticalAlignment="Center" />
                            <Button Grid.Column="1"
                                    Classes="icon-button"
                                    Command="{Binding CloseFilterModalCommand}">
                                <PathIcon Data="{x:Static icons:Icons.Close}"
                                          Width="20" Height="20" />
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Content -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="24" Spacing="20">
                            <!-- Status and Customer Row -->
                            <Grid ColumnDefinitions="*,16,*">
                                <!-- Status Filter -->
                                <StackPanel Grid.Column="0" Spacing="6">
                                    <TextBlock Text="{loc:Loc Status}" FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextSecondaryBrush}" />
                                    <ComboBox ItemsSource="{Binding StatusFilterOptions}"
                                              SelectedItem="{Binding FilterStatus}"
                                              Classes="form-combobox"
                                              HorizontalAlignment="Stretch">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource TranslateConverter}}" />
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </StackPanel>

                                <!-- Customer Filter -->
                                <StackPanel Grid.Column="2" Spacing="6">
                                    <TextBlock Text="{loc:Loc Customer}" FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextSecondaryBrush}" />
                                    <controls:SearchableDropdown ItemsSource="{Binding CustomerOptions}"
                                                                SelectedItem="{Binding FilterSelectedCustomer}"
                                                                DisplayMemberPath="Name"
                                                                Placeholder="{loc:Loc 'All customers'}"
                                                                ShowAddNew="False" />
                                </StackPanel>
                            </Grid>

                            <!-- Issue Date Range -->
                            <StackPanel Spacing="6">
                                <TextBlock Text="{loc:Loc 'Issue Date'}" FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextSecondaryBrush}" />
                                <Grid ColumnDefinitions="*,Auto,*">
                                    <DatePicker Grid.Column="0"
                                                SelectedDate="{Binding FilterIssueDateFrom}"
                                                Classes="form-datepicker"
                                                HorizontalAlignment="Stretch" />
                                    <TextBlock Grid.Column="1" Text="{loc:Loc to}" FontSize="13"
                                               Foreground="{DynamicResource TextTertiaryBrush}"
                                               VerticalAlignment="Center" Margin="12,0" />
                                    <DatePicker Grid.Column="2"
                                                SelectedDate="{Binding FilterIssueDateTo}"
                                                Classes="form-datepicker"
                                                HorizontalAlignment="Stretch" />
                                </Grid>
                            </StackPanel>

                            <!-- Due Date Range -->
                            <StackPanel Spacing="6">
                                <TextBlock Text="{loc:Loc 'Due Date'}" FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextSecondaryBrush}" />
                                <Grid ColumnDefinitions="*,Auto,*">
                                    <DatePicker Grid.Column="0"
                                                SelectedDate="{Binding FilterDueDateFrom}"
                                                Classes="form-datepicker"
                                                HorizontalAlignment="Stretch" />
                                    <TextBlock Grid.Column="1" Text="{loc:Loc to}" FontSize="13"
                                               Foreground="{DynamicResource TextTertiaryBrush}"
                                               VerticalAlignment="Center" Margin="12,0" />
                                    <DatePicker Grid.Column="2"
                                                SelectedDate="{Binding FilterDueDateTo}"
                                                Classes="form-datepicker"
                                                HorizontalAlignment="Stretch" />
                                </Grid>
                            </StackPanel>

                            <!-- Amount Range -->
                            <StackPanel Spacing="6">
                                <TextBlock Text="{loc:Loc 'Amount Range'}" FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextSecondaryBrush}" />
                                <Grid ColumnDefinitions="*,Auto,*">
                                    <TextBox Grid.Column="0"
                                             Text="{Binding FilterAmountMin, Mode=TwoWay}"
                                             Classes="form-input"
                                             Watermark="{loc:Loc Min}"
                                             behaviors:NumericInputBehavior.IsDecimalOnly="True" />
                                    <TextBlock Grid.Column="1" Text="{loc:Loc to}" FontSize="13"
                                               Foreground="{DynamicResource TextTertiaryBrush}"
                                               VerticalAlignment="Center" Margin="12,0" />
                                    <TextBox Grid.Column="2"
                                             Text="{Binding FilterAmountMax, Mode=TwoWay}"
                                             Classes="form-input"
                                             Watermark="{loc:Loc Max}"
                                             behaviors:NumericInputBehavior.IsDecimalOnly="True" />
                                </Grid>
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>

                    <!-- Footer -->
                    <Border Grid.Row="2"
                            Padding="24,16"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="0,1,0,0">
                        <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                            <Button Grid.Column="0"
                                    Classes="secondary-button"
                                    Content="{loc:Loc 'Clear Filters'}"
                                    Command="{Binding ClearFiltersCommand}" />
                            <Button Grid.Column="2"
                                    Classes="secondary-button"
                                    Content="{loc:Loc Cancel}"
                                    Margin="0,0,12,0"
                                    Command="{Binding CloseFilterModalCommand}" />
                            <Button Grid.Column="3"
                                    Classes="primary-button"
                                    Content="{loc:Loc 'Apply Filters'}"
                                    Command="{Binding ApplyFiltersCommand}" />
                        </Grid>
                    </Border>
                </Grid>
            </Border>
            </controls:ModalOverlay.ModalContent>
        </controls:ModalOverlay>

        <!-- ======================= HISTORY MODAL ======================= -->
        <controls:ModalOverlay IsOpen="{Binding IsHistoryModalOpen}">
            <controls:ModalOverlay.ModalContent>
                <Border HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Width="600"
                        MaxHeight="500"
                        Background="{DynamicResource SurfaceBrush}"
                        CornerRadius="12"
                        BoxShadow="0 8 32 0 #40000000">
                <Grid RowDefinitions="Auto,*">
                    <!-- Header -->
                    <Border Grid.Row="0"
                            Padding="24,16"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="0,0,0,1">
                        <Grid ColumnDefinitions="*,Auto">
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="{Binding HistoryInvoiceId}"
                                           FontSize="18"
                                           FontWeight="SemiBold"
                                           Foreground="{DynamicResource TextPrimaryBrush}" />
                                <TextBlock Text="{loc:Loc 'Invoice History'}"
                                           FontSize="13"
                                           Foreground="{DynamicResource TextSecondaryBrush}" />
                            </StackPanel>
                            <Button Grid.Column="1"
                                    Classes="icon-button"
                                    Command="{Binding CloseHistoryModalCommand}">
                                <PathIcon Data="{x:Static icons:Icons.Close}"
                                          Width="20" Height="20" />
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Content -->
                    <ScrollViewer Grid.Row="1" Padding="24">
                        <Panel>
                            <!-- Timeline -->
                            <ItemsControl ItemsSource="{Binding HistoryItems}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="vm:InvoiceHistoryDisplayItem">
                                        <Grid ColumnDefinitions="Auto,16,*" Margin="0,0,0,24">
                                            <!-- Timeline dot and line -->
                                            <StackPanel Grid.Column="0" Width="16">
                                                <Border Width="12" Height="12"
                                                        CornerRadius="6"
                                                        Background="{Binding ActionType, Converter={x:Static local:StringConverters.ToHistoryTypeBadgeBackground}}"
                                                        BorderBrush="{Binding ActionType, Converter={x:Static local:StringConverters.ToHistoryTypeBadgeForeground}}"
                                                        BorderThickness="2" />
                                                <Border Width="2"
                                                        Height="40"
                                                        Background="{DynamicResource BorderBrush}"
                                                        HorizontalAlignment="Center"
                                                        IsVisible="{Binding !IsLast}" />
                                            </StackPanel>

                                            <!-- Content -->
                                            <StackPanel Grid.Column="2" Spacing="4">
                                                <TextBlock Text="{Binding Description}"
                                                           FontSize="14"
                                                           Foreground="{DynamicResource TextPrimaryBrush}" />
                                                <TextBlock Text="{Binding DateTimeFormatted}"
                                                           FontSize="12"
                                                           Foreground="{DynamicResource TextTertiaryBrush}" />
                                            </StackPanel>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <!-- Empty State -->
                            <StackPanel HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        Spacing="8"
                                        IsVisible="{Binding HistoryItems.Count, Converter={x:Static local:IntConverters.IsZero}}">
                                <PathIcon Data="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"
                                          Width="32" Height="32"
                                          Foreground="{DynamicResource TextTertiaryBrush}" />
                                <TextBlock Text="{loc:Loc 'No history yet'}"
                                           FontSize="14"
                                           Foreground="{DynamicResource TextSecondaryBrush}" />
                            </StackPanel>
                        </Panel>
                    </ScrollViewer>
                </Grid>
            </Border>
            </controls:ModalOverlay.ModalContent>
        </controls:ModalOverlay>
    </Panel>

    <UserControl.Styles>
        <!-- NumericUpDown in forms -->
        <Style Selector="NumericUpDown.form-input">
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="MinHeight" Value="36" />
        </Style>

        <!-- Line Item NumericUpDown -->
        <Style Selector="NumericUpDown.line-item-input">
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="MinHeight" Value="36" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />
        </Style>
        <Style Selector="NumericUpDown.line-item-input /template/ TextBox#PART_TextBox">
            <Setter Property="Padding" Value="8,6" />
            <Setter Property="TextAlignment" Value="Center" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
        </Style>
        <Style Selector="NumericUpDown.line-item-input:focus">
            <Setter Property="BorderBrush" Value="{DynamicResource PrimaryBrush}" />
        </Style>
    </UserControl.Styles>
</UserControl>
