<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ArgoBooks.ViewModels"
             xmlns:controls="using:ArgoBooks.Controls"
             xmlns:loc="using:ArgoBooks.Localization"
             xmlns:local="using:ArgoBooks"
             mc:Ignorable="d" d:DesignWidth="550" d:DesignHeight="400"
             x:Class="ArgoBooks.Modals.PasswordPromptModal"
             x:DataType="vm:PasswordPromptModalViewModel">

    <Design.DataContext>
        <vm:PasswordPromptModalViewModel />
    </Design.DataContext>

    <Panel>
        <!-- Modal Overlay -->
        <controls:ModalOverlay IsOpen="{Binding IsOpen}">
            <controls:ModalOverlay.ModalContent>
                <!-- Modal Content -->
                <Border Background="{DynamicResource SurfaceBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="1"
                CornerRadius="12"
                Width="420"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Padding="32"
                BoxShadow="0 8 32 0 #40000000">

            <Panel>
                <!-- Normal Password Entry View -->
                <StackPanel Spacing="24" IsVisible="{Binding !ShowWindowsHelloSuccess}">
                    <!-- Header -->
                    <StackPanel Spacing="8"
                                HorizontalAlignment="Center">
                        <!-- Lock Icon -->
                        <Border Width="56" Height="56"
                                CornerRadius="28"
                                Background="{DynamicResource PrimaryLightBrush}"
                                HorizontalAlignment="Center">
                            <PathIcon Data="{x:Static local:Icons.Lock}"
                                      Width="28" Height="28"
                                      Foreground="{DynamicResource PrimaryBrush}" />
                        </Border>

                        <TextBlock Text="{loc:Loc 'Password Required'}"
                                   FontSize="20"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                   HorizontalAlignment="Center" />

                        <TextBlock Text="{Binding CompanyName, StringFormat='Enter password for {0}'}"
                                   FontSize="14"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   HorizontalAlignment="Center"
                                   TextWrapping="Wrap"
                                   TextAlignment="Center" />
                    </StackPanel>

                    <!-- Windows Hello Button (shown when available) -->
                    <Button Classes="windows-hello-button"
                            Command="{Binding UseWindowsHelloCommand}"
                            IsVisible="{Binding WindowsHelloAvailable}"
                            IsEnabled="{Binding !IsWindowsHelloAuthenticating}"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Center">
                        <StackPanel Orientation="Horizontal" Spacing="12" HorizontalAlignment="Center">
                            <!-- Windows Hello / Fingerprint Icon -->
                            <PathIcon Data="{x:Static local:Icons.Fingerprint}"
                                      Width="24" Height="24"
                                      IsVisible="{Binding !IsWindowsHelloAuthenticating}" />
                            <!-- Loading spinner when authenticating -->
                            <controls:LoadingSpinner SizePreset="Small"
                                                     IsVisible="{Binding IsWindowsHelloAuthenticating}" />
                            <TextBlock Text="{loc:Loc 'Use Windows Hello'}"
                                       IsVisible="{Binding !IsWindowsHelloAuthenticating}"
                                       VerticalAlignment="Center" />
                            <TextBlock Text="{loc:Loc 'Authenticating...'}"
                                       IsVisible="{Binding IsWindowsHelloAuthenticating}"
                                       VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>

                    <!-- Divider with "or" (shown when Windows Hello is available) -->
                    <Grid ColumnDefinitions="*,Auto,*"
                          IsVisible="{Binding WindowsHelloAvailable}"
                          Margin="0,-8,0,-8">
                        <Border Grid.Column="0"
                                Height="1"
                                Background="{DynamicResource BorderBrush}"
                                VerticalAlignment="Center"
                                Margin="0,0,16,0" />
                        <TextBlock Grid.Column="1"
                                   Text="{loc:Loc 'or enter password'}"
                                   FontSize="12"
                                   Foreground="{DynamicResource TextTertiaryBrush}"
                                   VerticalAlignment="Center" />
                        <Border Grid.Column="2"
                                Height="1"
                                Background="{DynamicResource BorderBrush}"
                                VerticalAlignment="Center"
                                Margin="16,0,0,0" />
                    </Grid>

                    <!-- Password Input -->
                    <StackPanel Spacing="8">
                        <Border Background="{DynamicResource SurfaceBrush}"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="1"
                                CornerRadius="8"
                                Padding="0">
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBox Grid.Column="0"
                                         x:Name="PasswordTextBox"
                                         Text="{Binding Password, Mode=TwoWay}"
                                         Watermark="{loc:Loc 'Enter password'}"
                                         RevealPassword="{Binding IsPasswordVisible}"
                                         Classes="password-input"
                                         IsEnabled="{Binding !IsLoading}"
                                         KeyDown="PasswordTextBox_KeyDown"
                                         MaxLength="128" />
                                <Button Grid.Column="1"
                                        Classes="eye-button"
                                        Command="{Binding TogglePasswordVisibilityCommand}"
                                        ToolTip.Tip="{loc:Loc 'Toggle password visibility'}">
                                    <PathIcon Data="{Binding PasswordVisibilityIcon}"
                                              Width="18" Height="18" />
                                </Button>
                            </Grid>
                        </Border>

                        <!-- Error Message -->
                        <TextBlock Text="{Binding ErrorMessage}"
                                   FontSize="13"
                                   Foreground="{DynamicResource ErrorBrush}"
                                   IsVisible="{Binding HasError}"
                                   TextWrapping="Wrap" />
                    </StackPanel>

                    <!-- Buttons -->
                    <Grid ColumnDefinitions="*,*"
                          Margin="0,8,0,0">
                        <Button Grid.Column="0"
                                Content="{loc:Loc Cancel}"
                                Classes="secondary"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Center"
                                Margin="0,0,8,0"
                                Command="{Binding CancelCommand}"
                                IsEnabled="{Binding !IsLoading}" />
                        <Button Grid.Column="1"
                                Classes="primary"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Center"
                                Margin="8,0,0,0"
                                Command="{Binding SubmitCommand}"
                                IsEnabled="{Binding !IsLoading}">
                            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                                <!-- Loading spinner icon (static) -->
                                <PathIcon IsVisible="{Binding IsLoading}"
                                          Data="{x:Static local:Icons.Refresh}"
                                          Width="16" Height="16"
                                          Foreground="White" />
                                <TextBlock Text="{loc:Loc Unlock}"
                                           IsVisible="{Binding !IsLoading}" />
                                <TextBlock Text="{loc:Loc 'Unlocking...'}"
                                           IsVisible="{Binding IsLoading}" />
                            </StackPanel>
                        </Button>
                    </Grid>

                    <!-- File Path Hint -->
                    <TextBlock Text="{Binding FilePath}"
                               FontSize="11"
                               Foreground="{DynamicResource TextTertiaryBrush}"
                               HorizontalAlignment="Center"
                               TextTrimming="CharacterEllipsis"
                               MaxWidth="400"
                               ToolTip.Tip="{Binding FilePath}" />
                </StackPanel>

                <!-- Windows Hello Success Animation View -->
                <controls:SuccessAnimation x:Name="SuccessAnimationControl"
                                           IsVisible="{Binding ShowWindowsHelloSuccess}"
                                           Title="{loc:Loc 'Identity Verified!'}"
                                           Message="{loc:Loc 'Windows Hello authentication successful'}"
                                           ContinueButtonText="{loc:Loc Continue}"
                                           ContinueCommand="{Binding ContinueAfterSuccessCommand}"
                                           ShowContinueButton="True"
                                           ContinueButtonDelayMs="1000" />
            </Panel>
                </Border>
            </controls:ModalOverlay.ModalContent>
        </controls:ModalOverlay>
    </Panel>

    <UserControl.Styles>
        <Style Selector="TextBox.password-input">
            <Setter Property="FontSize" Value="14" />
            <Setter Property="Padding" Value="12" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="PasswordChar" Value="*" />
        </Style>
        <Style Selector="TextBox.password-input /template/ Border#PART_BorderElement">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
        </Style>

        <Style Selector="Button.eye-button">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Width" Value="44" />
            <Setter Property="Height" Value="44" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="CornerRadius" Value="0,8,8,0" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Margin" Value="0" />
        </Style>
        <Style Selector="Button.eye-button /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="Transparent" />
        </Style>
        <Style Selector="Button.eye-button:pointerover /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SurfaceHoverBrush}" />
        </Style>
        <Style Selector="Button.eye-button PathIcon">
            <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}" />
        </Style>

        <Style Selector="Button.primary">
            <Setter Property="Background" Value="{DynamicResource PrimaryBrush}" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="FontWeight" Value="Medium" />
            <Setter Property="Padding" Value="16,12" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Cursor" Value="Hand" />
        </Style>
        <Style Selector="Button.primary /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource PrimaryBrush}" />
        </Style>
        <Style Selector="Button.primary:pointerover /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource PrimaryHoverBrush}" />
        </Style>

        <Style Selector="Button.secondary">
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}" />
            <Setter Property="FontWeight" Value="Medium" />
            <Setter Property="Padding" Value="16,12" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Cursor" Value="Hand" />
        </Style>
        <Style Selector="Button.secondary /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}" />
        </Style>
        <Style Selector="Button.secondary:pointerover /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SurfaceHoverBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource BorderHoverBrush}" />
        </Style>
        <Style Selector="Button.secondary:pointerover">
            <Setter Property="BorderBrush" Value="{DynamicResource BorderHoverBrush}" />
        </Style>

        <!-- Windows Hello Button Style -->
        <Style Selector="Button.windows-hello-button">
            <Setter Property="Background" Value="{DynamicResource SurfaceAltBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}" />
            <Setter Property="FontWeight" Value="Medium" />
            <Setter Property="Padding" Value="16,14" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Cursor" Value="Hand" />
        </Style>
        <Style Selector="Button.windows-hello-button /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SurfaceAltBrush}" />
        </Style>
        <Style Selector="Button.windows-hello-button:pointerover /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SurfaceHoverBrush}" />
        </Style>
        <Style Selector="Button.windows-hello-button PathIcon">
            <Setter Property="Foreground" Value="{DynamicResource PrimaryBrush}" />
        </Style>
    </UserControl.Styles>
</UserControl>
