<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ArgoBooks.ViewModels"
             xmlns:controls="using:ArgoBooks.Controls"
             xmlns:local="using:ArgoBooks"
             xmlns:loc="using:ArgoBooks.Localization"
             xmlns:icons="using:ArgoBooks"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="ArgoBooks.Views.InsightsPage"
             x:DataType="vm:InsightsPageViewModel">

    <Design.DataContext>
        <vm:InsightsPageViewModel />
    </Design.DataContext>

    <UserControl.Styles>
        <Style Selector="Border.insight-item">
            <Setter Property="BorderThickness" Value="0,0,0,1" />
        </Style>
        <Style Selector="Border.insight-item.last-item">
            <Setter Property="BorderThickness" Value="0" />
        </Style>
    </UserControl.Styles>

    <Panel>
    <!-- Main Content -->
    <ScrollViewer VerticalScrollBarVisibility="Auto"
                  HorizontalScrollBarVisibility="Disabled">
        <Grid RowDefinitions="Auto,Auto,*" Margin="24">
            <!-- Statistics Cards Row -->
            <controls:StatCardsRow Grid.Row="0" Margin="0,0,0,24">
                <controls:StatCard Label="{loc:Loc 'AI Insights'}"
                                   Value="{Binding TotalInsights}"
                                   Icon="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6C7.8 12.16 7 10.63 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"
                                   IconColor="Info" />
                <controls:StatCard Label="{loc:Loc 'Trends Detected'}"
                                   Value="{Binding TrendsDetected}"
                                   Icon="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"
                                   IconColor="Success" />
                <controls:StatCard Label="{loc:Loc Anomalies}"
                                   Value="{Binding AnomaliesDetected}"
                                   Icon="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"
                                   IconColor="Warning" />
                <controls:StatCard Label="{loc:Loc Opportunities}"
                                   Value="{Binding Opportunities}"
                                   Icon="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"
                                   IconColor="Primary" />
            </controls:StatCardsRow>

            <!-- Forecasted Growth Section (Row 1) -->
            <Border Grid.Row="1"
                    Background="{DynamicResource SurfaceBrush}"
                    CornerRadius="12"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1"
                    Padding="24"
                    Margin="0,0,0,24">
                <StackPanel Spacing="20">
                    <!-- Section Header -->
                    <Grid ColumnDefinitions="Auto,*,Auto">
                        <Border Grid.Column="0"
                                Width="32" Height="32"
                                CornerRadius="8"
                                Background="{DynamicResource PrimaryLightBrush}"
                                Margin="0,0,12,0">
                            <PathIcon Data="{x:Static local:Icons.TrendUp}"
                                      Width="16" Height="16"
                                      Foreground="{DynamicResource PrimaryBrush}" />
                        </Border>
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="{loc:Loc 'Forecasted Growth'}"
                                           FontSize="16"
                                           FontWeight="SemiBold"
                                           Foreground="{DynamicResource TextPrimaryBrush}" />
                                <!-- Info Button -->
                                <Button Classes="icon-button"
                                        Width="28" Height="28"
                                        Padding="0"
                                        Margin="0,-5,0,0"
                                        VerticalAlignment="Center"
                                        Command="{Binding ShowPredictionInfoCommand}"
                                        ToolTip.Tip="How predictions are calculated">
                                    <PathIcon Data="{x:Static local:Icons.Info}"
                                              Width="18" Height="18"
                                              Foreground="{DynamicResource TextSecondaryBrush}" />
                                </Button>
                            </StackPanel>
                            <TextBlock Text="{Binding ForecastDateRangeLabel}"
                                       FontSize="14"
                                       FontWeight="Medium"
                                       Foreground="{DynamicResource TextSecondaryBrush}" />
                        </StackPanel>
                        <!-- Date Range Selector -->
                        <controls:DateRangeSelector Grid.Column="2" VerticalAlignment="Top" />
                    </Grid>

                    <!-- Forecast Cards Row (visible when data is available) -->
                    <controls:StatCardsRow IsVisible="{Binding !HasInsufficientData}">
                        <controls:StatCard Label="{Binding RevenueLabel}"
                                           Value="{Binding ForecastedRevenue}"
                                           ChangeValue="{Binding RevenueGrowthValue}"
                                           ChangeText="{Binding RevenueGrowth}"
                                           ChangeLabel="{Binding ComparisonLabel}"
                                           UseAltBackground="True" />
                        <controls:StatCard Label="{Binding ExpensesLabel}"
                                           Value="{Binding ForecastedExpenses}"
                                           ChangeValue="{Binding ExpenseGrowthValue}"
                                           ChangeText="{Binding ExpenseGrowth}"
                                           ChangeLabel="{Binding ComparisonLabel}"
                                           UseAltBackground="True" />
                        <controls:StatCard Label="{Binding ProfitLabel}"
                                           Value="{Binding ForecastedProfit}"
                                           ChangeValue="{Binding ProfitGrowthValue}"
                                           ChangeText="{Binding ProfitGrowth}"
                                           ChangeLabel="{Binding ComparisonLabel}"
                                           ValueColor="Success"
                                           UseAltBackground="True" />
                        <controls:StatCard Label="{Binding CustomersLabel}"
                                           Value="{Binding ForecastedCustomers}"
                                           ChangeValue="{Binding CustomerGrowthValue}"
                                           ChangeText="{Binding CustomerGrowth}"
                                           ChangeLabel="{Binding ComparisonLabel}"
                                           UseAltBackground="True" />
                    </controls:StatCardsRow>

                    <!-- Insufficient Data Message (visible when no data) -->
                    <Border IsVisible="{Binding HasInsufficientData}"
                            Background="{DynamicResource SurfaceAltBrush}"
                            CornerRadius="8"
                            Padding="32">
                        <StackPanel HorizontalAlignment="Center" Spacing="12">
                            <Border Width="56" Height="56"
                                    CornerRadius="28"
                                    Background="{DynamicResource BackgroundBrush}"
                                    HorizontalAlignment="Center">
                                <PathIcon Data="{x:Static icons:Icons.WarningCircle}"
                                          Width="28" Height="28"
                                          Foreground="{DynamicResource TextTertiaryBrush}" />
                            </Border>
                            <TextBlock Text="Insufficient Data"
                                       FontSize="16"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                       HorizontalAlignment="Center" />
                            <TextBlock Text="{Binding InsufficientDataMessage}"
                                       FontSize="13"
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       HorizontalAlignment="Center"
                                       TextAlignment="Center"
                                       MaxWidth="400"
                                       TextWrapping="Wrap" />
                        </StackPanel>
                    </Border>

                    <!-- Confidence Indicator (visible when data is available) -->
                    <Border IsVisible="{Binding !HasInsufficientData}"
                            Background="{DynamicResource SurfaceAltBrush}"
                            CornerRadius="8"
                            Padding="16">
                        <StackPanel Spacing="12">
                            <!-- Main confidence row -->
                            <Grid ColumnDefinitions="Auto,*,Auto">
                                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                    <PathIcon Data="{x:Static local:Icons.CircleCheck}"
                                              Width="16" Height="16"
                                              Foreground="{DynamicResource SuccessBrush}" />
                                    <TextBlock Text="{loc:Loc 'Prediction Confidence:'}"
                                               FontSize="13"
                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                               VerticalAlignment="Center" />
                                    <TextBlock Text="{Binding PredictionConfidence}"
                                               FontSize="13"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource SuccessBrush}"
                                               VerticalAlignment="Center" />
                                </StackPanel>
                                <TextBlock Grid.Column="2"
                                           Text="{Binding DataMonthsNote}"
                                           FontSize="12"
                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                           VerticalAlignment="Center" />
                            </Grid>

                            <!-- Revenue range row (visible when bounds exist) -->
                            <StackPanel Orientation="Horizontal" Spacing="8"
                                        IsVisible="{Binding RevenueRange, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                <PathIcon Data="{x:Static icons:Icons.BarChart}"
                                          Width="14" Height="14"
                                          Foreground="{DynamicResource TextPrimaryBrush}" />
                                <TextBlock Text="Revenue Forecast:"
                                           FontSize="12"
                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                           VerticalAlignment="Center" />
                                <TextBlock Text="{Binding RevenueRange}"
                                           FontSize="12"
                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                           VerticalAlignment="Center" />
                            </StackPanel>

                            <!-- Historical accuracy row (visible when data exists) -->
                            <Grid ColumnDefinitions="Auto,*,Auto"
                                  IsVisible="{Binding HasAccuracyData}">
                                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                    <PathIcon Data="{x:Static local:Icons.Check}"
                                              Width="14" Height="14"
                                              Foreground="{DynamicResource PrimaryBrush}" />
                                    <TextBlock Text="Historical Accuracy:"
                                               FontSize="12"
                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                               VerticalAlignment="Center" />
                                    <TextBlock Text="{Binding HistoricalAccuracy}"
                                               FontSize="12"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource PrimaryBrush}"
                                               VerticalAlignment="Center" />
                                    <!-- View Past Predictions Button -->
                                    <Button Classes="link-button"
                                            Padding="4,0"
                                            Margin="4,0,0,0"
                                            VerticalAlignment="Center"
                                            Command="{Binding ShowPastPredictionsCommand}"
                                            ToolTip.Tip="View past predictions and their accuracy">
                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                            <TextBlock Text="View Details"
                                                       FontSize="11"
                                                       Foreground="{DynamicResource PrimaryBrush}"
                                                       TextDecorations="Underline"
                                                       VerticalAlignment="Center" />
                                            <PathIcon Data="{x:Static icons:Icons.ChevronRightNav}"
                                                      Width="12" Height="12"
                                                      Foreground="{DynamicResource PrimaryBrush}" />
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                                <TextBlock Grid.Column="2"
                                           Text="{Binding ValidatedForecastsNote}"
                                           FontSize="12"
                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                           VerticalAlignment="Center" />
                            </Grid>

                            <!-- Seasonal pattern row (visible when pattern detected) -->
                            <Grid ColumnDefinitions="Auto,*"
                                  IsVisible="{Binding HasSeasonalPattern}">
                                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                    <PathIcon Data="{x:Static local:Icons.Clock}"
                                              Width="14" Height="14"
                                              Foreground="{DynamicResource VioletBrush}" />
                                    <TextBlock Text="Seasonal Pattern:"
                                               FontSize="12"
                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                               VerticalAlignment="Center" />
                                </StackPanel>
                                <TextBlock Grid.Column="1"
                                           Text="{Binding SeasonalPatternDescription}"
                                           FontSize="12"
                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                           Margin="8,0,0,0"
                                           TextWrapping="Wrap"
                                           VerticalAlignment="Center" />
                            </Grid>

                            <!-- Accuracy description (visible when no accuracy data yet) -->
                            <TextBlock IsVisible="{Binding !HasAccuracyData}"
                                       Text="{Binding AccuracyDescription}"
                                       FontSize="11"
                                       FontStyle="Italic"
                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                       TextWrapping="Wrap" />
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Border>

            <!-- Insights Content (Row 2) - hidden when insufficient data -->
            <Grid Grid.Row="2" RowDefinitions="Auto,*" IsVisible="{Binding !HasInsufficientData}">
                <!-- Insights Period Header -->
                <Border Grid.Row="0"
                        Background="{DynamicResource SurfaceAltBrush}"
                        CornerRadius="8"
                        Padding="16"
                        Margin="0,0,0,16">
                    <Grid ColumnDefinitions="*,Auto">
                        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                            <PathIcon Data="{x:Static local:Icons.Clock}"
                                      Width="16" Height="16"
                                      Foreground="{DynamicResource TextTertiaryBrush}" />
                            <TextBlock Text="{loc:Loc 'Business Insights'}"
                                       FontSize="14"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                       VerticalAlignment="Center" />
                            <TextBlock Text="â€¢"
                                       FontSize="14"
                                       Foreground="{DynamicResource TextTertiaryBrush}"
                                       VerticalAlignment="Center" />
                            <TextBlock Text="{Binding InsightsAnalysisPeriod}"
                                       FontSize="13"
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       VerticalAlignment="Center" />
                        </StackPanel>
                        <!-- Date Range Selector for Insights -->
                        <ComboBox Grid.Column="1"
                                  ItemsSource="{Binding InsightsDateRangeOptions}"
                                  SelectedIndex="{Binding SelectedInsightsDateRangeIndex}"
                                  MinWidth="130"
                                  VerticalAlignment="Center" />
                    </Grid>
                </Border>

                <!-- Insights Grid -->
                <Grid Grid.Row="1" ColumnDefinitions="*,*">
                <!-- Left Column -->
                <StackPanel Grid.Column="0" Spacing="16" Margin="0,0,12,0">
                    <!-- Revenue Trends Section -->
                    <Border Background="{DynamicResource SurfaceBrush}"
                            CornerRadius="12"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1">
                        <StackPanel>
                            <Border Padding="20"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="0,0,0,1"
                                    IsVisible="{Binding !HasNoRevenueTrends}">
                                <Grid ColumnDefinitions="Auto,*">
                                    <Border Grid.Column="0"
                                            Width="32" Height="32"
                                            CornerRadius="8"
                                            Background="{DynamicResource SuccessLightBrush}"
                                            Margin="0,0,12,0">
                                        <PathIcon Data="{x:Static local:Icons.TrendUp}"
                                                  Width="16" Height="16"
                                                  Foreground="{DynamicResource SuccessBrush}" />
                                    </Border>
                                    <TextBlock Grid.Column="1"
                                               Text="{loc:Loc 'Revenue Trends'}"
                                               FontSize="16"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                               VerticalAlignment="Center" />
                                </Grid>
                            </Border>
                            <!-- Empty state header (no bottom border) -->
                            <Border Padding="20"
                                    IsVisible="{Binding HasNoRevenueTrends}">
                                <Grid ColumnDefinitions="Auto,*">
                                    <Border Grid.Column="0"
                                            Width="32" Height="32"
                                            CornerRadius="8"
                                            Background="{DynamicResource SuccessLightBrush}"
                                            Margin="0,0,12,0">
                                        <PathIcon Data="{x:Static local:Icons.TrendUp}"
                                                  Width="16" Height="16"
                                                  Foreground="{DynamicResource SuccessBrush}" />
                                    </Border>
                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <TextBlock Text="{loc:Loc 'Revenue Trends'}"
                                                   FontSize="16"
                                                   FontWeight="SemiBold"
                                                   Foreground="{DynamicResource TextPrimaryBrush}" />
                                        <TextBlock Text="No revenue trends detected"
                                                   FontSize="13"
                                                   Foreground="{DynamicResource TextTertiaryBrush}" />
                                    </StackPanel>
                                </Grid>
                            </Border>
                            <ItemsControl ItemsSource="{Binding RevenueTrends}" Margin="0">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="vm:InsightItemViewModel">
                                        <Border Padding="20"
                                                BorderBrush="{DynamicResource BorderBrush}"
                                                Classes="insight-item"
                                                Classes.last-item="{Binding IsLastItem}">
                                            <Grid ColumnDefinitions="Auto,*">
                                                <Border Grid.Column="0"
                                                        Width="8" Height="8"
                                                        CornerRadius="4"
                                                        Background="{Binding StatusColor}"
                                                        Margin="0,6,12,0"
                                                        VerticalAlignment="Top" />
                                                <StackPanel Grid.Column="1" Spacing="4">
                                                    <TextBlock Text="{Binding Title}"
                                                               FontSize="14"
                                                               FontWeight="Medium"
                                                               Foreground="{DynamicResource TextPrimaryBrush}" />
                                                    <TextBlock Text="{Binding Description}"
                                                               FontSize="13"
                                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                                               TextWrapping="Wrap" />
                                                    <TextBlock Text="{Binding Recommendation}"
                                                               FontSize="12"
                                                               Foreground="{DynamicResource PrimaryBrush}"
                                                               TextWrapping="Wrap"
                                                               Margin="0,4,0,0"
                                                               IsVisible="{Binding HasRecommendation}" />
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- Right Column -->
                <StackPanel Grid.Column="1" Spacing="16" Margin="12,0,0,0">
                    <!-- Anomalies Section -->
                    <Border Background="{DynamicResource SurfaceBrush}"
                            CornerRadius="12"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1">
                        <StackPanel>
                            <Border Padding="20"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="0,0,0,1"
                                    IsVisible="{Binding !HasNoAnomalies}">
                                <Grid ColumnDefinitions="Auto,*">
                                    <Border Grid.Column="0"
                                            Width="32" Height="32"
                                            CornerRadius="8"
                                            Background="{DynamicResource WarningLightBrush}"
                                            Margin="0,0,12,0">
                                        <PathIcon Data="{x:Static local:Icons.LostDamaged}"
                                                  Width="16" Height="16"
                                                  Foreground="{DynamicResource WarningBrush}" />
                                    </Border>
                                    <TextBlock Grid.Column="1"
                                               Text="{loc:Loc 'Anomaly Detection'}"
                                               FontSize="16"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                               VerticalAlignment="Center" />
                                </Grid>
                            </Border>
                            <!-- Empty state header (no bottom border) -->
                            <Border Padding="20"
                                    IsVisible="{Binding HasNoAnomalies}">
                                <Grid ColumnDefinitions="Auto,*">
                                    <Border Grid.Column="0"
                                            Width="32" Height="32"
                                            CornerRadius="8"
                                            Background="{DynamicResource WarningLightBrush}"
                                            Margin="0,0,12,0">
                                        <PathIcon Data="{x:Static local:Icons.LostDamaged}"
                                                  Width="16" Height="16"
                                                  Foreground="{DynamicResource WarningBrush}" />
                                    </Border>
                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <TextBlock Text="{loc:Loc 'Anomaly Detection'}"
                                                   FontSize="16"
                                                   FontWeight="SemiBold"
                                                   Foreground="{DynamicResource TextPrimaryBrush}" />
                                        <TextBlock Text="No anomalies detected"
                                                   FontSize="13"
                                                   Foreground="{DynamicResource TextTertiaryBrush}" />
                                    </StackPanel>
                                </Grid>
                            </Border>
                            <ItemsControl ItemsSource="{Binding Anomalies}" Margin="0">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="vm:InsightItemViewModel">
                                        <Border Padding="20"
                                                BorderBrush="{DynamicResource BorderBrush}"
                                                Classes="insight-item"
                                                Classes.last-item="{Binding IsLastItem}">
                                            <Grid ColumnDefinitions="Auto,*">
                                                <Border Grid.Column="0"
                                                        Width="8" Height="8"
                                                        CornerRadius="4"
                                                        Background="{Binding StatusColor}"
                                                        Margin="0,6,12,0"
                                                        VerticalAlignment="Top" />
                                                <StackPanel Grid.Column="1" Spacing="4">
                                                    <TextBlock Text="{Binding Title}"
                                                               FontSize="14"
                                                               FontWeight="Medium"
                                                               Foreground="{DynamicResource TextPrimaryBrush}" />
                                                    <TextBlock Text="{Binding Description}"
                                                               FontSize="13"
                                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                                               TextWrapping="Wrap" />
                                                    <TextBlock Text="{Binding Recommendation}"
                                                               FontSize="12"
                                                               Foreground="{DynamicResource PrimaryBrush}"
                                                               TextWrapping="Wrap"
                                                               Margin="0,4,0,0"
                                                               IsVisible="{Binding HasRecommendation}" />
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>

                    <!-- Recommendations Section -->
                    <Border Background="{DynamicResource SurfaceBrush}"
                            CornerRadius="12"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1">
                        <StackPanel>
                            <Border Padding="20"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="0,0,0,1"
                                    IsVisible="{Binding !HasNoRecommendations}">
                                <Grid ColumnDefinitions="Auto,*">
                                    <Border Grid.Column="0"
                                            Width="32" Height="32"
                                            CornerRadius="8"
                                            Background="{DynamicResource PrimaryLightBrush}"
                                            Margin="0,0,12,0">
                                        <PathIcon Data="{x:Static local:Icons.Star}"
                                                  Width="16" Height="16"
                                                  Foreground="{DynamicResource PrimaryBrush}" />
                                    </Border>
                                    <TextBlock Grid.Column="1"
                                               Text="{loc:Loc Recommendations}"
                                               FontSize="16"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                               VerticalAlignment="Center" />
                                </Grid>
                            </Border>
                            <!-- Empty state header (no bottom border) -->
                            <Border Padding="20"
                                    IsVisible="{Binding HasNoRecommendations}">
                                <Grid ColumnDefinitions="Auto,*">
                                    <Border Grid.Column="0"
                                            Width="32" Height="32"
                                            CornerRadius="8"
                                            Background="{DynamicResource PrimaryLightBrush}"
                                            Margin="0,0,12,0">
                                        <PathIcon Data="{x:Static local:Icons.Star}"
                                                  Width="16" Height="16"
                                                  Foreground="{DynamicResource PrimaryBrush}" />
                                    </Border>
                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <TextBlock Text="{loc:Loc Recommendations}"
                                                   FontSize="16"
                                                   FontWeight="SemiBold"
                                                   Foreground="{DynamicResource TextPrimaryBrush}" />
                                        <TextBlock Text="No recommendations at this time"
                                                   FontSize="13"
                                                   Foreground="{DynamicResource TextTertiaryBrush}" />
                                    </StackPanel>
                                </Grid>
                            </Border>
                            <ItemsControl ItemsSource="{Binding Recommendations}" Margin="0">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="vm:InsightItemViewModel">
                                        <Border Padding="20"
                                                BorderBrush="{DynamicResource BorderBrush}"
                                                Classes="insight-item"
                                                Classes.last-item="{Binding IsLastItem}">
                                            <Grid ColumnDefinitions="Auto,*">
                                                <Border Grid.Column="0"
                                                        Width="8" Height="8"
                                                        CornerRadius="4"
                                                        Background="{Binding StatusColor}"
                                                        Margin="0,6,12,0"
                                                        VerticalAlignment="Top" />
                                                <StackPanel Grid.Column="1" Spacing="4">
                                                    <TextBlock Text="{Binding Title}"
                                                               FontSize="14"
                                                               FontWeight="Medium"
                                                               Foreground="{DynamicResource TextPrimaryBrush}" />
                                                    <TextBlock Text="{Binding Description}"
                                                               FontSize="13"
                                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                                               TextWrapping="Wrap" />
                                                    <TextBlock Text="{Binding Recommendation}"
                                                               FontSize="12"
                                                               Foreground="{DynamicResource PrimaryBrush}"
                                                               TextWrapping="Wrap"
                                                               Margin="0,4,0,0"
                                                               IsVisible="{Binding HasRecommendation}" />
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>
                </StackPanel>
                </Grid>
            </Grid>
        </Grid>
    </ScrollViewer>

    <!-- Backtest Loading Overlay -->
    <Border IsVisible="{Binding IsRunningBacktest}"
            Background="{DynamicResource OverlayBrush}"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Stretch">
        <Border Background="{DynamicResource SurfaceBrush}"
                CornerRadius="16"
                Padding="48"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                MinWidth="400"
                BoxShadow="0 8 32 0 #40000000">
            <StackPanel Spacing="24" HorizontalAlignment="Center">
                <!-- Animated Icon -->
                <Border Width="72" Height="72"
                        CornerRadius="36"
                        Background="{DynamicResource PrimaryLightBrush}"
                        HorizontalAlignment="Center">
                    <PathIcon Data="{x:Static icons:Icons.BarChart}"
                              Width="32" Height="32"
                              Foreground="{DynamicResource PrimaryBrush}" />
                </Border>

                <!-- Title -->
                <TextBlock Text="Analyzing Historical Data"
                           FontSize="20"
                           FontWeight="SemiBold"
                           Foreground="{DynamicResource TextPrimaryBrush}"
                           HorizontalAlignment="Center" />

                <!-- Progress Message -->
                <TextBlock Text="{Binding BacktestProgressMessage}"
                           FontSize="14"
                           Foreground="{DynamicResource TextSecondaryBrush}"
                           HorizontalAlignment="Center" />

                <!-- Progress Bar -->
                <StackPanel Spacing="8" MinWidth="300">
                    <ProgressBar Value="{Binding BacktestProgressPercent}"
                                 Minimum="0"
                                 Maximum="100"
                                 Height="8"
                                 Foreground="{DynamicResource PrimaryBrush}"
                                 IsIndeterminate="{Binding !BacktestProgressTotal}" />
                    <TextBlock HorizontalAlignment="Center"
                               FontSize="12"
                               Foreground="{DynamicResource TextTertiaryBrush}">
                        <TextBlock.Text>
                            <MultiBinding StringFormat="{}{0} of {1} months processed">
                                <Binding Path="BacktestProgressCurrent" />
                                <Binding Path="BacktestProgressTotal" />
                            </MultiBinding>
                        </TextBlock.Text>
                        <TextBlock.IsVisible>
                            <Binding Path="BacktestProgressTotal"
                                     Converter="{x:Static ObjectConverters.IsNotNull}" />
                        </TextBlock.IsVisible>
                    </TextBlock>
                </StackPanel>

                <!-- Description -->
                <TextBlock Text="Testing predictions against historical outcomes to measure accuracy..."
                           FontSize="12"
                           Foreground="{DynamicResource TextTertiaryBrush}"
                           HorizontalAlignment="Center"
                           TextAlignment="Center"
                           MaxWidth="350"
                           TextWrapping="Wrap" />
            </StackPanel>
        </Border>
    </Border>
    </Panel>
</UserControl>
