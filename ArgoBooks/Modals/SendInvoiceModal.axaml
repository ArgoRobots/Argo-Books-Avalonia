<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ArgoBooks.ViewModels"
             xmlns:controls="using:ArgoBooks.Controls"
             xmlns:icons="using:ArgoBooks"
             xmlns:loc="using:ArgoBooks.Localization"
             mc:Ignorable="d" d:DesignWidth="900" d:DesignHeight="700"
             x:Class="ArgoBooks.Modals.SendInvoiceModal"
             x:DataType="vm:SendInvoiceModalViewModel">

    <Design.DataContext>
        <vm:SendInvoiceModalViewModel />
    </Design.DataContext>

    <Panel>
        <controls:ModalOverlay IsOpen="{Binding IsOpen}">
            <controls:ModalOverlay.ModalContent>
                <Border HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Width="850"
                        MaxHeight="700"
                        Background="{DynamicResource SurfaceBrush}"
                        CornerRadius="12"
                        BoxShadow="0 8 32 0 #40000000">
                    <Grid RowDefinitions="Auto,*,Auto">
                        <!-- Header -->
                        <Border Grid.Row="0"
                                Padding="24,16"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="0,0,0,1">
                            <Grid ColumnDefinitions="*,Auto">
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="{loc:Loc 'Send Invoice'}"
                                               FontSize="18"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource TextPrimaryBrush}" />
                                    <TextBlock FontSize="13"
                                               Foreground="{DynamicResource TextSecondaryBrush}">
                                        <Run Text="{Binding InvoiceNumber}" />
                                        <Run Text=" â€¢ " />
                                        <Run Text="{Binding CustomerName}" />
                                    </TextBlock>
                                </StackPanel>
                                <Button Grid.Column="1"
                                        Classes="icon-button"
                                        Command="{Binding CloseCommand}"
                                        IsEnabled="{Binding !IsSending}">
                                    <PathIcon Data="{x:Static icons:Icons.Close}"
                                              Width="20" Height="20" />
                                </Button>
                            </Grid>
                        </Border>

                        <!-- Content -->
                        <Grid Grid.Row="1" ColumnDefinitions="320,*">
                            <!-- Left Panel: Settings -->
                            <Border Grid.Column="0"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="0,0,1,0">
                                <ScrollViewer VerticalScrollBarVisibility="Auto">
                                    <StackPanel Margin="20" Spacing="20">
                                        <!-- Email Configuration Warning -->
                                        <Border Background="#fef3c7"
                                                BorderBrush="#f59e0b"
                                                BorderThickness="1"
                                                CornerRadius="6"
                                                Padding="12"
                                                IsVisible="{Binding !IsEmailConfigured}">
                                            <StackPanel Spacing="8">
                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                    <PathIcon Data="{x:Static icons:Icons.Warning}"
                                                              Width="16" Height="16"
                                                              Foreground="#b45309" />
                                                    <TextBlock Text="{loc:Loc 'Email not configured'}"
                                                               FontSize="13"
                                                               FontWeight="SemiBold"
                                                               Foreground="#92400e" />
                                                </StackPanel>
                                                <TextBlock Text="{loc:Loc 'Configure your email API in Settings to send invoices.'}"
                                                           FontSize="12"
                                                           Foreground="#92400e"
                                                           TextWrapping="Wrap" />
                                                <Button Classes="secondary-button"
                                                        Content="{loc:Loc 'Configure Email'}"
                                                        Command="{Binding OpenEmailSettingsCommand}"
                                                        HorizontalAlignment="Left"
                                                        Margin="0,4,0,0" />
                                            </StackPanel>
                                        </Border>

                                        <!-- No Customer Email Warning -->
                                        <Border Background="#fee2e2"
                                                BorderBrush="#ef4444"
                                                BorderThickness="1"
                                                CornerRadius="6"
                                                Padding="12"
                                                IsVisible="{Binding !HasCustomerEmail}">
                                            <StackPanel Spacing="4">
                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                    <PathIcon Data="{x:Static icons:Icons.Warning}"
                                                              Width="16" Height="16"
                                                              Foreground="#dc2626" />
                                                    <TextBlock Text="{loc:Loc 'No email address'}"
                                                               FontSize="13"
                                                               FontWeight="SemiBold"
                                                               Foreground="#991b1b" />
                                                </StackPanel>
                                                <TextBlock Text="{loc:Loc 'This customer does not have an email address.'}"
                                                           FontSize="12"
                                                           Foreground="#991b1b"
                                                           TextWrapping="Wrap" />
                                            </StackPanel>
                                        </Border>

                                        <!-- Invoice Summary -->
                                        <Border Background="{DynamicResource SurfaceAltBrush}"
                                                CornerRadius="8"
                                                Padding="16">
                                            <StackPanel Spacing="12">
                                                <TextBlock Text="{loc:Loc 'Invoice Summary'}"
                                                           FontSize="13"
                                                           FontWeight="SemiBold"
                                                           Foreground="{DynamicResource TextSecondaryBrush}" />

                                                <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto,Auto">
                                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="{loc:Loc 'Invoice #'}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" />
                                                    <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding InvoiceNumber}" FontSize="13" Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="Medium" />

                                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="{loc:Loc 'Send To'}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,8,0,0" />
                                                    <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding CustomerEmail}" FontSize="13" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,8,0,0" />

                                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="{loc:Loc 'Due Date'}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,8,0,0" />
                                                    <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding DueDate}" FontSize="13" Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,8,0,0" />

                                                    <TextBlock Grid.Row="3" Grid.Column="0" Text="{loc:Loc 'Amount Due'}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,8,0,0" />
                                                    <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding InvoiceBalance}" FontSize="15" Foreground="{DynamicResource PrimaryBrush}" FontWeight="Bold" Margin="0,8,0,0" />
                                                </Grid>
                                            </StackPanel>
                                        </Border>

                                        <!-- Template Selection -->
                                        <StackPanel Spacing="8">
                                            <TextBlock Text="{loc:Loc 'Email Template'}"
                                                       FontSize="13"
                                                       FontWeight="SemiBold"
                                                       Foreground="{DynamicResource TextSecondaryBrush}" />

                                            <ItemsControl ItemsSource="{Binding TemplateOptions}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate DataType="vm:InvoiceTemplateOption">
                                                        <Button Classes="template-option"
                                                                Margin="0,2"
                                                                HorizontalAlignment="Stretch"
                                                                HorizontalContentAlignment="Stretch"
                                                                Command="{Binding $parent[ItemsControl].((vm:SendInvoiceModalViewModel)DataContext).SelectTemplateCommand}"
                                                                CommandParameter="{Binding Template}">
                                                            <Border Padding="12"
                                                                    Background="{DynamicResource SurfaceBrush}"
                                                                    BorderBrush="{DynamicResource BorderBrush}"
                                                                    BorderThickness="1"
                                                                    CornerRadius="6">
                                                                <Grid ColumnDefinitions="*,Auto">
                                                                    <StackPanel Grid.Column="0">
                                                                        <TextBlock Text="{Binding Name}"
                                                                                   FontSize="14"
                                                                                   FontWeight="Medium"
                                                                                   Foreground="{DynamicResource TextPrimaryBrush}" />
                                                                        <TextBlock Text="{Binding BaseType}"
                                                                                   FontSize="12"
                                                                                   Foreground="{DynamicResource TextTertiaryBrush}" />
                                                                    </StackPanel>
                                                                    <Border Grid.Column="1"
                                                                            Background="{DynamicResource PrimaryBrush}"
                                                                            CornerRadius="4"
                                                                            Padding="6,2"
                                                                            VerticalAlignment="Center"
                                                                            IsVisible="{Binding IsDefault}">
                                                                        <TextBlock Text="{loc:Loc Default}"
                                                                                   FontSize="10"
                                                                                   Foreground="White" />
                                                                    </Border>
                                                                </Grid>
                                                            </Border>
                                                        </Button>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>

                                        <!-- Email Subject -->
                                        <StackPanel Spacing="6" IsVisible="{Binding IsEmailConfigured}">
                                            <TextBlock Text="{loc:Loc 'Email Subject'}"
                                                       FontSize="13"
                                                       FontWeight="Medium"
                                                       Foreground="{DynamicResource TextSecondaryBrush}" />
                                            <TextBox Text="{Binding Subject, Mode=TwoWay}"
                                                     Classes="form-input"
                                                     IsReadOnly="True" />
                                        </StackPanel>
                                    </StackPanel>
                                </ScrollViewer>
                            </Border>

                            <!-- Right Panel: Preview -->
                            <Grid Grid.Column="1" RowDefinitions="Auto,*">
                                <Border Grid.Row="0" Padding="20,15" Background="{DynamicResource SurfaceAltBrush}">
                                    <Grid ColumnDefinitions="*,Auto">
                                        <TextBlock Grid.Column="0"
                                                   Text="{loc:Loc 'Email Preview'}"
                                                   FontSize="14"
                                                   FontWeight="SemiBold"
                                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                                   VerticalAlignment="Center" />
                                        <Button Grid.Column="1"
                                                Classes="secondary-button"
                                                Command="{Binding PreviewInBrowserCommand}">
                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                <PathIcon Data="{x:Static icons:Icons.OpenInNew}" Width="14" Height="14" />
                                                <TextBlock Text="{loc:Loc 'Open in Browser'}" />
                                            </StackPanel>
                                        </Button>
                                    </Grid>
                                </Border>

                                <!-- Preview container -->
                                <Border Grid.Row="1" Margin="20" Background="#f3f4f6" CornerRadius="8">
                                    <ScrollViewer HorizontalScrollBarVisibility="Auto"
                                                  VerticalScrollBarVisibility="Auto">
                                        <Border Margin="20"
                                                Background="White"
                                                CornerRadius="4"
                                                BoxShadow="0 2px 8px #20000000"
                                                MinWidth="400"
                                                HorizontalAlignment="Center">
                                            <StackPanel Margin="30" Spacing="15" MaxWidth="450">
                                                <PathIcon Data="{x:Static icons:Icons.Email}"
                                                          Width="32" Height="32"
                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                          HorizontalAlignment="Center" />

                                                <TextBlock Text="{loc:Loc 'Invoice Email Preview'}"
                                                           FontSize="14"
                                                           FontWeight="SemiBold"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                                           HorizontalAlignment="Center" />

                                                <TextBlock Text="{loc:Loc 'The invoice will be sent as a beautifully formatted HTML email.'}"
                                                           FontSize="13"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"
                                                           TextWrapping="Wrap"
                                                           TextAlignment="Center" />

                                                <Border Height="1" Background="{DynamicResource BorderBrush}" Margin="0,10" />

                                                <StackPanel Spacing="8">
                                                    <Grid ColumnDefinitions="80,*">
                                                        <TextBlock Grid.Column="0" Text="{loc:Loc 'To:'}" FontSize="12" Foreground="{DynamicResource TextTertiaryBrush}" />
                                                        <TextBlock Grid.Column="1" Text="{Binding CustomerEmail}" FontSize="12" Foreground="{DynamicResource TextPrimaryBrush}" />
                                                    </Grid>
                                                    <Grid ColumnDefinitions="80,*">
                                                        <TextBlock Grid.Column="0" Text="{loc:Loc 'From:'}" FontSize="12" Foreground="{DynamicResource TextTertiaryBrush}" />
                                                        <TextBlock Grid.Column="1" Text="{Binding FromEmail}" FontSize="12" Foreground="{DynamicResource TextPrimaryBrush}" />
                                                    </Grid>
                                                    <Grid ColumnDefinitions="80,*">
                                                        <TextBlock Grid.Column="0" Text="{loc:Loc 'Subject:'}" FontSize="12" Foreground="{DynamicResource TextTertiaryBrush}" />
                                                        <TextBlock Grid.Column="1" Text="{Binding Subject}" FontSize="12" Foreground="{DynamicResource TextPrimaryBrush}" TextWrapping="Wrap" />
                                                    </Grid>
                                                </StackPanel>

                                                <Border Height="1" Background="{DynamicResource BorderBrush}" Margin="0,10" />

                                                <TextBlock Text="{loc:Loc 'Click &quot;Open in Browser&quot; to see exactly how the invoice email will look.'}"
                                                           FontSize="12"
                                                           Foreground="{DynamicResource TextTertiaryBrush}"
                                                           TextWrapping="Wrap"
                                                           TextAlignment="Center"
                                                           FontStyle="Italic" />
                                            </StackPanel>
                                        </Border>
                                    </ScrollViewer>
                                </Border>
                            </Grid>
                        </Grid>

                        <!-- Footer -->
                        <Border Grid.Row="2"
                                Padding="24,16"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="0,1,0,0">
                            <Grid ColumnDefinitions="*,Auto">
                                <!-- Status Message -->
                                <StackPanel Grid.Column="0"
                                            Orientation="Horizontal"
                                            Spacing="8"
                                            VerticalAlignment="Center"
                                            IsVisible="{Binding HasStatusMessage}">
                                    <TextBlock Text="{Binding StatusMessage}"
                                               FontSize="13"
                                               VerticalAlignment="Center"
                                               Foreground="{DynamicResource TextSecondaryBrush}">
                                        <TextBlock.Styles>
                                            <Style Selector="TextBlock">
                                                <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}" />
                                            </Style>
                                        </TextBlock.Styles>
                                    </TextBlock>
                                </StackPanel>

                                <!-- Buttons -->
                                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="12">
                                    <Button Classes="secondary-button"
                                            Content="{loc:Loc Cancel}"
                                            Command="{Binding CloseCommand}"
                                            IsEnabled="{Binding !IsSending}" />
                                    <Button Classes="primary-button"
                                            Command="{Binding SendCommand}"
                                            IsEnabled="{Binding !IsSending}">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <PathIcon Data="{x:Static icons:Icons.Send}" Width="14" Height="14" />
                                            <TextBlock Text="{loc:Loc 'Send Invoice'}" />
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </Grid>
                </Border>
            </controls:ModalOverlay.ModalContent>
        </controls:ModalOverlay>
    </Panel>

    <UserControl.Styles>
        <Style Selector="Button.template-option">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="Cursor" Value="Hand" />
        </Style>
        <Style Selector="Button.template-option:pointerover Border">
            <Setter Property="BorderBrush" Value="{DynamicResource PrimaryBrush}" />
        </Style>
    </UserControl.Styles>
</UserControl>
