<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:controls="using:ArgoBooks.Controls"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="500"
             x:Class="ArgoBooks.Controls.DataTable"
             x:DataType="controls:DataTable">

    <Border Background="{DynamicResource SurfaceBrush}"
            BorderBrush="{DynamicResource BorderBrush}"
            BorderThickness="1"
            CornerRadius="{StaticResource RadiusMd}">
        <DockPanel>
            <!-- Header with Search and Actions -->
            <Border DockPanel.Dock="Top"
                    Padding="16,12"
                    BorderBrush="{DynamicResource BorderLightBrush}"
                    BorderThickness="0,0,0,1"
                    IsVisible="{Binding ShowHeader, RelativeSource={RelativeSource AncestorType=controls:DataTable}}">
                <Grid ColumnDefinitions="*,Auto">
                    <!-- Search Box -->
                    <Border Grid.Column="0"
                            CornerRadius="{StaticResource RadiusMd}"
                            BorderThickness="1"
                            BorderBrush="{DynamicResource BorderBrush}"
                            Background="{DynamicResource BackgroundBrush}"
                            Padding="10,8"
                            MaxWidth="300"
                            HorizontalAlignment="Left"
                            IsVisible="{Binding ShowSearch, RelativeSource={RelativeSource AncestorType=controls:DataTable}}">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <PathIcon Grid.Column="0"
                                      Data="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
                                      Width="16" Height="16"
                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                      Margin="0,0,8,0" />
                            <TextBox Grid.Column="1"
                                     Text="{Binding SearchText, RelativeSource={RelativeSource AncestorType=controls:DataTable}, Mode=TwoWay}"
                                     Watermark="{Binding SearchPlaceholder, RelativeSource={RelativeSource AncestorType=controls:DataTable}}"
                                     Background="Transparent"
                                     BorderThickness="0"
                                     Padding="0"
                                     VerticalAlignment="Center" />
                            <Button Grid.Column="2"
                                    Classes="icon"
                                    Width="20" Height="20"
                                    Padding="2"
                                    IsVisible="{Binding SearchText, RelativeSource={RelativeSource AncestorType=controls:DataTable}, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                    Command="{Binding ClearSearchCommand, RelativeSource={RelativeSource AncestorType=controls:DataTable}}">
                                <PathIcon Data="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                                          Width="12" Height="12"
                                          Foreground="{DynamicResource TextTertiaryBrush}" />
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Action Buttons Slot -->
                    <ContentPresenter Grid.Column="1"
                                      Content="{Binding HeaderActions, RelativeSource={RelativeSource AncestorType=controls:DataTable}}" />
                </Grid>
            </Border>

            <!-- Footer with Pagination -->
            <Border DockPanel.Dock="Bottom"
                    Padding="16,12"
                    BorderBrush="{DynamicResource BorderLightBrush}"
                    BorderThickness="0,1,0,0"
                    IsVisible="{Binding ShowPagination, RelativeSource={RelativeSource AncestorType=controls:DataTable}}">
                <Grid ColumnDefinitions="Auto,*,Auto">
                    <!-- Items Info -->
                    <TextBlock Grid.Column="0"
                               FontSize="{StaticResource FontSizeSm}"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               VerticalAlignment="Center">
                        <Run Text="Showing " />
                        <Run Text="{Binding DisplayedItemsStart, RelativeSource={RelativeSource AncestorType=controls:DataTable}}" />
                        <Run Text=" - " />
                        <Run Text="{Binding DisplayedItemsEnd, RelativeSource={RelativeSource AncestorType=controls:DataTable}}" />
                        <Run Text=" of " />
                        <Run Text="{Binding TotalItemCount, RelativeSource={RelativeSource AncestorType=controls:DataTable}}" />
                    </TextBlock>

                    <!-- Pagination Controls -->
                    <StackPanel Grid.Column="2"
                                Orientation="Horizontal"
                                Spacing="4">
                        <!-- Page Size Selector -->
                        <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,0,16,0">
                            <TextBlock Text="Rows:"
                                       FontSize="{StaticResource FontSizeSm}"
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       VerticalAlignment="Center" />
                            <ComboBox ItemsSource="{Binding PageSizeOptions, RelativeSource={RelativeSource AncestorType=controls:DataTable}}"
                                      SelectedItem="{Binding PageSize, RelativeSource={RelativeSource AncestorType=controls:DataTable}, Mode=TwoWay}"
                                      MinWidth="70"
                                      Padding="8,4" />
                        </StackPanel>

                        <!-- Page Navigation -->
                        <Button Classes="icon"
                                Command="{Binding FirstPageCommand, RelativeSource={RelativeSource AncestorType=controls:DataTable}}"
                                IsEnabled="{Binding CanGoToPreviousPage, RelativeSource={RelativeSource AncestorType=controls:DataTable}}"
                                ToolTip.Tip="First page">
                            <PathIcon Data="M18.41 16.59L13.82 12l4.59-4.59L17 6l-6 6 6 6zM6 6h2v12H6z"
                                      Width="16" Height="16" />
                        </Button>
                        <Button Classes="icon"
                                Command="{Binding PreviousPageCommand, RelativeSource={RelativeSource AncestorType=controls:DataTable}}"
                                IsEnabled="{Binding CanGoToPreviousPage, RelativeSource={RelativeSource AncestorType=controls:DataTable}}"
                                ToolTip.Tip="Previous page">
                            <PathIcon Data="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"
                                      Width="16" Height="16" />
                        </Button>

                        <TextBlock VerticalAlignment="Center"
                                   FontSize="{StaticResource FontSizeSm}"
                                   Margin="8,0">
                            <Run Text="Page " />
                            <Run Text="{Binding CurrentPage, RelativeSource={RelativeSource AncestorType=controls:DataTable}}" />
                            <Run Text=" of " />
                            <Run Text="{Binding TotalPages, RelativeSource={RelativeSource AncestorType=controls:DataTable}}" />
                        </TextBlock>

                        <Button Classes="icon"
                                Command="{Binding NextPageCommand, RelativeSource={RelativeSource AncestorType=controls:DataTable}}"
                                IsEnabled="{Binding CanGoToNextPage, RelativeSource={RelativeSource AncestorType=controls:DataTable}}"
                                ToolTip.Tip="Next page">
                            <PathIcon Data="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"
                                      Width="16" Height="16" />
                        </Button>
                        <Button Classes="icon"
                                Command="{Binding LastPageCommand, RelativeSource={RelativeSource AncestorType=controls:DataTable}}"
                                IsEnabled="{Binding CanGoToNextPage, RelativeSource={RelativeSource AncestorType=controls:DataTable}}"
                                ToolTip.Tip="Last page">
                            <PathIcon Data="M5.59 7.41L10.18 12l-4.59 4.59L7 18l6-6-6-6zM16 6h2v12h-2z"
                                      Width="16" Height="16" />
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Table Content -->
            <ScrollViewer HorizontalScrollBarVisibility="Auto"
                          VerticalScrollBarVisibility="Auto">
                <DockPanel>
                    <!-- Column Headers -->
                    <Border DockPanel.Dock="Top"
                            Background="{DynamicResource TableHeaderBackgroundBrush}"
                            BorderBrush="{DynamicResource BorderLightBrush}"
                            BorderThickness="0,0,0,1">
                        <ItemsControl ItemsSource="{Binding Columns, RelativeSource={RelativeSource AncestorType=controls:DataTable}}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="controls:DataTableColumn">
                                    <Button Classes="ghost"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Left"
                                            Padding="16,12"
                                            Width="{Binding Width}"
                                            MinWidth="{Binding MinWidth}"
                                            IsEnabled="{Binding IsSortable}"
                                            Command="{Binding SortCommand, RelativeSource={RelativeSource AncestorType=controls:DataTable}}"
                                            CommandParameter="{Binding}">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <TextBlock Text="{Binding Header}"
                                                       FontWeight="SemiBold"
                                                       FontSize="{StaticResource FontSizeSm}"
                                                       Foreground="{DynamicResource TextSecondaryBrush}" />
                                            <!-- Sort Indicator -->
                                            <PathIcon Width="12" Height="12"
                                                      IsVisible="{Binding IsSorted}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}">
                                                <PathIcon.Styles>
                                                    <Style Selector="PathIcon">
                                                        <Setter Property="Data" Value="M7 14l5-5 5 5z" />
                                                    </Style>
                                                    <Style Selector="PathIcon.descending">
                                                        <Setter Property="Data" Value="M7 10l5 5 5-5z" />
                                                    </Style>
                                                </PathIcon.Styles>
                                            </PathIcon>
                                        </StackPanel>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Border>

                    <!-- Data Rows -->
                    <ItemsControl x:Name="RowsContainer"
                                  ItemsSource="{Binding DisplayedItems, RelativeSource={RelativeSource AncestorType=controls:DataTable}}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border x:Name="RowBorder"
                                        BorderBrush="{DynamicResource BorderLightBrush}"
                                        BorderThickness="0,0,0,1"
                                        Cursor="Hand">
                                    <Border.Styles>
                                        <Style Selector="Border#RowBorder">
                                            <Setter Property="Background" Value="Transparent" />
                                        </Style>
                                        <Style Selector="Border#RowBorder:pointerover">
                                            <Setter Property="Background" Value="{DynamicResource TableRowHoverBrush}" />
                                        </Style>
                                        <Style Selector="Border#RowBorder.alternate">
                                            <Setter Property="Background" Value="{DynamicResource TableRowAlternateBrush}" />
                                        </Style>
                                        <Style Selector="Border#RowBorder.selected">
                                            <Setter Property="Background" Value="{DynamicResource TableRowSelectedBrush}" />
                                        </Style>
                                    </Border.Styles>

                                    <ContentPresenter Content="{Binding}"
                                                      ContentTemplate="{Binding RowTemplate, RelativeSource={RelativeSource AncestorType=controls:DataTable}}" />
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Empty State -->
                    <Border IsVisible="{Binding !HasItems, RelativeSource={RelativeSource AncestorType=controls:DataTable}}"
                            Padding="32">
                        <StackPanel HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    Spacing="8">
                            <PathIcon Data="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"
                                      Width="48" Height="48"
                                      Foreground="{DynamicResource TextTertiaryBrush}" />
                            <TextBlock Text="{Binding EmptyMessage, RelativeSource={RelativeSource AncestorType=controls:DataTable}}"
                                       FontSize="{StaticResource FontSizeMd}"
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       HorizontalAlignment="Center" />
                        </StackPanel>
                    </Border>
                </DockPanel>
            </ScrollViewer>
        </DockPanel>
    </Border>
</UserControl>
