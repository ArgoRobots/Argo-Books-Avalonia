<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ArgoBooks.ViewModels"
             xmlns:controls="using:ArgoBooks.Controls"
             xmlns:icons="using:ArgoBooks"
             xmlns:loc="using:ArgoBooks.Localization"
             xmlns:local="using:ArgoBooks.Converters"
             xmlns:colorPicker="clr-namespace:ColorPicker;assembly=ColorPicker.AvaloniaUI"
             xmlns:html="clr-namespace:TheArtOfDev.HtmlRenderer.Avalonia;assembly=Avalonia.HtmlRenderer"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="ArgoBooks.Modals.InvoiceTemplateDesignerModal"
             x:DataType="vm:InvoiceTemplateDesignerViewModel">

    <Design.DataContext>
        <vm:InvoiceTemplateDesignerViewModel />
    </Design.DataContext>

    <Panel>
        <controls:ModalOverlay IsOpen="{Binding IsOpen}">
            <controls:ModalOverlay.ModalContent>
                <Border Width="{Binding IsFullscreen, Converter={x:Static local:BoolConverters.ToFullscreenWidth}, ConverterParameter=1000}"
                        Height="{Binding IsFullscreen, Converter={x:Static local:BoolConverters.ToFullscreenHeight}, ConverterParameter=750}"
                        MinWidth="1000"
                        Margin="{Binding IsFullscreen, Converter={x:Static local:BoolConverters.ToFullscreenMargin}}"
                        HorizontalAlignment="{Binding IsFullscreen, Converter={x:Static local:BoolConverters.ToFullscreenHorizontalAlignment}}"
                        VerticalAlignment="{Binding IsFullscreen, Converter={x:Static local:BoolConverters.ToFullscreenVerticalAlignment}}"
                        Background="{DynamicResource SurfaceBrush}"
                        CornerRadius="12"
                        ClipToBounds="True"
                        BoxShadow="0 8 32 0 #40000000">
                    <Grid RowDefinitions="Auto,*,Auto">
                        <!-- Header -->
                        <Border Grid.Row="0"
                                Padding="24,16"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="0,0,0,1">
                            <Grid ColumnDefinitions="*,Auto">
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="{Binding ModalTitle}"
                                               FontSize="18"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource TextPrimaryBrush}" />
                                    <TextBlock Text="{loc:Loc 'Customize your invoice template'}"
                                               FontSize="13"
                                               Foreground="{DynamicResource TextSecondaryBrush}" />
                                </StackPanel>
                                <Button Grid.Column="1"
                                        Classes="icon-button"
                                        Command="{Binding CloseCommand}">
                                    <PathIcon Data="{x:Static icons:Icons.Close}"
                                              Width="20" Height="20" />
                                </Button>
                            </Grid>
                        </Border>

                        <!-- Content -->
                        <Grid Grid.Row="1" ColumnDefinitions="350,*">
                            <!-- Left Panel: Settings -->
                            <Border Grid.Column="0"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="0,0,1,0">
                                <ScrollViewer VerticalScrollBarVisibility="Auto"
                                              HorizontalScrollBarVisibility="Disabled">
                                    <StackPanel Margin="20" Spacing="16">
                                        <!-- Template Name -->
                                        <StackPanel Spacing="6">
                                            <TextBlock Text="{loc:Loc 'Template Name'}" FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextSecondaryBrush}" />
                                            <TextBox Text="{Binding TemplateName, Mode=TwoWay}"
                                                     Classes="form-input"
                                                     BorderBrush="{Binding HasValidationMessage, Converter={x:Static local:BoolConverters.ToErrorBorderBrush}}"
                                                     Watermark="{loc:Loc 'Enter template name...'}" />
                                            <TextBlock Text="{Binding ValidationMessage}"
                                                       FontSize="13"
                                                       Foreground="#DC2626"
                                                       IsVisible="{Binding HasValidationMessage}" />
                                        </StackPanel>

                                        <!-- Base Template -->
                                        <StackPanel Spacing="6">
                                            <TextBlock Text="{loc:Loc 'Base Template'}" FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextSecondaryBrush}" />
                                            <ComboBox ItemsSource="{Binding BaseTemplateOptions}"
                                                      SelectedItem="{Binding SelectedBaseTemplate}"
                                                      Classes="form-combobox"
                                                      HorizontalAlignment="Stretch" />
                                        </StackPanel>

                                        <!-- Default Template -->
                                        <CheckBox IsChecked="{Binding IsDefault}"
                                                  Content="{loc:Loc 'Set as default template'}" />

                                        <Border Height="1" Background="{DynamicResource BorderBrush}" />

                                        <!-- Colors Section -->
                                        <StackPanel Spacing="10">
                                            <TextBlock Text="{loc:Loc Colors}" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" />

                                            <!-- Primary Color -->
                                            <Grid ColumnDefinitions="*,150">
                                                <TextBlock Grid.Column="0" Text="{loc:Loc 'Primary Color'}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center" />
                                                <controls:ColorPickerInput Grid.Column="1" ColorValue="{Binding PrimaryColor, Mode=TwoWay}" />
                                            </Grid>

                                            <!-- Secondary Color -->
                                            <Grid ColumnDefinitions="*,150">
                                                <TextBlock Grid.Column="0" Text="{loc:Loc 'Secondary Color'}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center" />
                                                <controls:ColorPickerInput Grid.Column="1" ColorValue="{Binding SecondaryColor, Mode=TwoWay}" />
                                            </Grid>

                                            <!-- Accent Color -->
                                            <Grid ColumnDefinitions="*,150">
                                                <TextBlock Grid.Column="0" Text="{loc:Loc 'Accent Color'}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center" />
                                                <controls:ColorPickerInput Grid.Column="1" ColorValue="{Binding AccentColor, Mode=TwoWay}" />
                                            </Grid>

                                            <!-- Text Color -->
                                            <Grid ColumnDefinitions="*,150">
                                                <TextBlock Grid.Column="0" Text="{loc:Loc 'Text Color'}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center" />
                                                <controls:ColorPickerInput Grid.Column="1" ColorValue="{Binding TextColor, Mode=TwoWay}" />
                                            </Grid>
                                        </StackPanel>

                                        <Border Height="1" Background="{DynamicResource BorderBrush}" />

                                        <!-- Logo Section -->
                                        <StackPanel Spacing="10">
                                            <TextBlock Text="{loc:Loc Logo}" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" />

                                            <CheckBox IsChecked="{Binding ShowLogo}"
                                                      Content="{loc:Loc 'Show logo on invoice'}" />

                                            <StackPanel Spacing="4">
                                                <TextBlock Text="{loc:Loc 'Image Path'}" FontSize="11" Foreground="{DynamicResource TextTertiaryBrush}" />
                                                <Grid ColumnDefinitions="*,Auto">
                                                    <TextBox Grid.Column="0"
                                                             Text="{Binding LogoPath}"
                                                             Watermark="{loc:Loc 'Path to logo image...'}"
                                                             IsReadOnly="True"
                                                             TextWrapping="NoWrap" />
                                                    <Button Grid.Column="1"
                                                            Margin="4,0,0,0"
                                                            Padding="8,6"
                                                            Command="{Binding SelectLogoCommand}"
                                                            ToolTip.Tip="{loc:Loc 'Browse...'}">
                                                        <PathIcon Data="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"
                                                                  Width="14" Height="14"
                                                                  Foreground="{DynamicResource TextSecondaryBrush}" />
                                                    </Button>
                                                </Grid>
                                            </StackPanel>

                                            <!-- Remove Button -->
                                            <Button Classes="secondary-button danger"
                                                    Content="{loc:Loc 'Remove Logo'}"
                                                    Command="{Binding RemoveLogoCommand}"
                                                    IsVisible="{Binding HasLogo}"
                                                    HorizontalAlignment="Left" />

                                            <Grid ColumnDefinitions="*,80" IsVisible="{Binding ShowLogo}">
                                                <TextBlock Grid.Column="0" Text="{loc:Loc 'Logo Width (px)'}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center" />
                                                <NumericUpDown Grid.Column="1"
                                                               Value="{Binding LogoWidth}"
                                                               Minimum="50"
                                                               Maximum="300"
                                                               FormatString="0"
                                                               ShowButtonSpinner="False"
                                                               Classes="form-input" />
                                            </Grid>
                                        </StackPanel>

                                        <Border Height="1" Background="{DynamicResource BorderBrush}" />

                                        <!-- Text Content Section -->
                                        <StackPanel Spacing="10">
                                            <TextBlock Text="{loc:Loc 'Text Content'}" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" />

                                            <StackPanel Spacing="4">
                                                <TextBlock Text="{loc:Loc 'Header Text'}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" />
                                                <TextBox Text="{Binding HeaderText, Mode=TwoWay}" Classes="form-input" />
                                            </StackPanel>

                                            <StackPanel Spacing="4">
                                                <TextBlock Text="{loc:Loc 'Footer Text'}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" />
                                                <TextBox Text="{Binding FooterText, Mode=TwoWay}" Classes="form-input" />
                                            </StackPanel>

                                            <StackPanel Spacing="4">
                                                <TextBlock Text="{loc:Loc 'Payment Instructions'}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" />
                                                <TextBox Text="{Binding PaymentInstructions, Mode=TwoWay}"
                                                         Classes="form-input"
                                                         AcceptsReturn="True"
                                                         TextWrapping="Wrap"
                                                         MinHeight="60"
                                                         Watermark="{loc:Loc 'Bank details, payment methods, etc.'}" />
                                            </StackPanel>
                                        </StackPanel>

                                        <Border Height="1" Background="{DynamicResource BorderBrush}" />

                                        <!-- Display Options Section -->
                                        <StackPanel Spacing="8">
                                            <TextBlock Text="{loc:Loc 'Display Options'}" FontSize="14" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" />

                                            <CheckBox IsChecked="{Binding ShowCompanyAddress}"
                                                      Content="{loc:Loc 'Show company address'}" />
                                            <CheckBox IsChecked="{Binding ShowTaxBreakdown}"
                                                      Content="{loc:Loc 'Show tax breakdown'}" />
                                            <CheckBox IsChecked="{Binding ShowItemDescriptions}"
                                                      Content="{loc:Loc 'Show item descriptions'}" />
                                            <CheckBox IsChecked="{Binding ShowNotes}"
                                                      Content="{loc:Loc 'Show notes section'}" />
                                            <CheckBox IsChecked="{Binding ShowPaymentInstructions}"
                                                      Content="{loc:Loc 'Show payment instructions'}" />
                                            <CheckBox IsChecked="{Binding ShowDueDateProminent}"
                                                      Content="{loc:Loc 'Highlight due date'}" />
                                        </StackPanel>

                                        <Border Height="1" Background="{DynamicResource BorderBrush}" />

                                        <!-- Font -->
                                        <StackPanel Spacing="6">
                                            <TextBlock Text="{loc:Loc 'Font Family'}" FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextSecondaryBrush}" />
                                            <ComboBox ItemsSource="{Binding FontFamilyOptions}"
                                                      SelectedItem="{Binding SelectedFontFamily}"
                                                      Classes="form-combobox"
                                                      HorizontalAlignment="Stretch" />
                                        </StackPanel>
                                    </StackPanel>
                                </ScrollViewer>
                            </Border>

                            <!-- Right Panel: Preview -->
                            <Grid Grid.Column="1" RowDefinitions="Auto,*,Auto">
                                <Border Grid.Row="0" Padding="20,15" Background="{DynamicResource SurfaceAltBrush}">
                                    <Grid ColumnDefinitions="*,Auto">
                                        <TextBlock Grid.Column="0"
                                                   Text="{loc:Loc Preview}"
                                                   FontSize="14"
                                                   FontWeight="SemiBold"
                                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                                   VerticalAlignment="Center" />
                                        <Button Grid.Column="1"
                                                Classes="secondary-button"
                                                Command="{Binding PreviewInBrowserCommand}">
                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                <PathIcon Data="{x:Static icons:Icons.OpenInNew}" Width="14" Height="14" />
                                                <TextBlock Text="{loc:Loc 'Open in Browser'}" />
                                            </StackPanel>
                                        </Button>
                                    </Grid>
                                </Border>

                                <!-- Preview container with zoom - uses same HTML as browser preview -->
                                <Border Grid.Row="1" Margin="0" Background="#f3f4f6" ClipToBounds="True">
                                    <ScrollViewer x:Name="PreviewScrollViewer"
                                                  HorizontalScrollBarVisibility="Auto"
                                                  VerticalScrollBarVisibility="Auto"
                                                  HorizontalContentAlignment="Center"
                                                  Padding="0">
                                        <LayoutTransformControl x:Name="ZoomTransformControl"
                                                                HorizontalAlignment="Center"
                                                                VerticalAlignment="Center">
                                            <!-- HtmlLabel renders the same HTML that the browser preview uses -->
                                            <html:HtmlLabel x:Name="HtmlPreviewPanel"
                                                            Text="{Binding PreviewHtml}"
                                                            Background="White"
                                                            MinWidth="640"
                                                            MaxWidth="700" />
                                        </LayoutTransformControl>
                                    </ScrollViewer>
                                </Border>

                                <!-- Zoom Controls -->
                                <Border Grid.Row="2" Padding="20,10" Background="{DynamicResource SurfaceAltBrush}">
                                    <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                                        <Button Classes="icon-button" Click="ZoomOut_Click" ToolTip.Tip="{loc:Loc 'Zoom Out'}">
                                            <PathIcon Data="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zM7 9h5v1H7z" Width="16" Height="16" />
                                        </Button>
                                        <Slider x:Name="ZoomSlider"
                                                Minimum="0.25"
                                                Maximum="3.0"
                                                Value="1.0"
                                                Width="120"
                                                ValueChanged="ZoomSlider_ValueChanged" />
                                        <Button Classes="icon-button" Click="ZoomIn_Click" ToolTip.Tip="{loc:Loc 'Zoom In'}">
                                            <PathIcon Data="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zm.5-7H9v2H7v1h2v2h1v-2h2V9h-2z" Width="16" Height="16" />
                                        </Button>
                                        <TextBlock x:Name="ZoomPercentText" Text="100%" Width="45" TextAlignment="Center" VerticalAlignment="Center" Foreground="{DynamicResource TextSecondaryBrush}" />
                                        <Button Classes="icon-button" Click="FitToWindow_Click" ToolTip.Tip="{loc:Loc 'Fit to Window'}">
                                            <!-- Fit to window icon: corners with center focus dot -->
                                            <PathIcon Data="M5 15H3v4c0 1.1.9 2 2 2h4v-2H5v-4zM5 5h4V3H5c-1.1 0-2 .9-2 2v4h2V5zm14-2h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm0 16h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zM12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z" Width="16" Height="16" />
                                        </Button>
                                    </StackPanel>
                                </Border>
                            </Grid>
                        </Grid>

                        <!-- Footer -->
                        <Border Grid.Row="2"
                                Padding="24,16"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="0,1,0,0">
                            <Grid ColumnDefinitions="Auto,Auto,*,Auto">
                                <!-- Fullscreen toggle -->
                                <Button Grid.Column="0"
                                        Classes="icon-button"
                                        ToolTip.Tip="{loc:Loc 'Toggle Fullscreen (F)'}"
                                        Command="{Binding ToggleFullscreenCommand}">
                                    <PathIcon Data="{Binding IsFullscreen, Converter={x:Static local:BoolConverters.ToFullscreenIcon}}"
                                              Width="16" Height="16" />
                                </Button>
                                <TextBlock Grid.Column="1"
                                           Text="{Binding ValidationMessage}"
                                           Foreground="#DC2626"
                                           FontSize="13"
                                           Margin="12,0,0,0"
                                           VerticalAlignment="Center"
                                           IsVisible="{Binding HasValidationMessage}" />
                                <StackPanel Grid.Column="3" Orientation="Horizontal" Spacing="12">
                                    <Button Classes="secondary-button"
                                            Content="{loc:Loc Cancel}"
                                            Command="{Binding CloseCommand}" />
                                    <Button Classes="primary-button"
                                            Content="{loc:Loc 'Save Template'}"
                                            Command="{Binding SaveCommand}" />
                                </StackPanel>
                            </Grid>
                        </Border>
                    </Grid>
                </Border>
            </controls:ModalOverlay.ModalContent>
        </controls:ModalOverlay>
    </Panel>
</UserControl>
