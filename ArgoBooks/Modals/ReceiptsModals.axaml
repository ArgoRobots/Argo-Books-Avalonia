<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ArgoBooks.ViewModels"
             xmlns:loc="using:ArgoBooks.Localization"
             xmlns:controls="using:ArgoBooks.Controls"
             xmlns:behaviors="using:ArgoBooks.Behaviors"
             xmlns:local="using:ArgoBooks.Converters"
             xmlns:icons="using:ArgoBooks"
             mc:Ignorable="d" d:DesignWidth="1280" d:DesignHeight="800"
             x:Class="ArgoBooks.Modals.ReceiptsModals"
             x:DataType="vm:ReceiptsModalsViewModel">

    <Panel>
        <!-- Filter Modal -->
        <controls:ModalOverlay IsOpen="{Binding IsFilterModalOpen}"
                               ClosingCommand="{Binding RequestCloseFilterModalCommand}">
            <controls:ModalOverlay.ModalContent>
                <Border HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Width="480"
                        MaxHeight="620"
                        Background="{DynamicResource SurfaceBrush}"
                        CornerRadius="12"
                        BoxShadow="0 8 32 0 #40000000">
                <Grid RowDefinitions="Auto,*,Auto">
                    <!-- Modal Header -->
                    <Border Grid.Row="0"
                            Padding="24,16"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="0,0,0,1">
                        <Grid ColumnDefinitions="*,Auto">
                            <TextBlock Text="{loc:Loc 'Filter Receipts'}"
                                       FontSize="18"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextPrimaryBrush}" />
                            <Button Grid.Column="1"
                                    Classes="icon-button"
                                    Command="{Binding CloseFilterModalCommand}">
                                <PathIcon Data="{x:Static icons:Icons.Close}"
                                          Width="20" Height="20" />
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Modal Content -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                        <StackPanel Margin="24" Spacing="16">
                            <!-- Receipt Type -->
                            <StackPanel Spacing="8">
                                <TextBlock Text="{loc:Loc 'Receipt Type'}"
                                           FontSize="13"
                                           FontWeight="Medium"
                                           Foreground="{DynamicResource TextSecondaryBrush}" />
                                <ComboBox ItemsSource="{Binding TypeOptions}"
                                          SelectedItem="{Binding FilterType}"
                                          HorizontalAlignment="Stretch">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Converter={StaticResource TranslateConverter}}" />
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </StackPanel>

                            <!-- From Date -->
                            <StackPanel Spacing="8">
                                <TextBlock Text="{loc:Loc 'From Date'}"
                                           FontSize="13"
                                           FontWeight="Medium"
                                           Foreground="{DynamicResource TextSecondaryBrush}" />
                                <DatePicker SelectedDate="{Binding FilterDateFrom}"
                                            Classes="form-datepicker"
                                            HorizontalAlignment="Stretch" />
                            </StackPanel>

                            <!-- To Date -->
                            <StackPanel Spacing="8">
                                <TextBlock Text="{loc:Loc 'To Date'}"
                                           FontSize="13"
                                           FontWeight="Medium"
                                           Foreground="{DynamicResource TextSecondaryBrush}" />
                                <DatePicker SelectedDate="{Binding FilterDateTo}"
                                            Classes="form-datepicker"
                                            HorizontalAlignment="Stretch" />
                            </StackPanel>

                            <!-- Amount Range -->
                            <Grid ColumnDefinitions="*,16,*">
                                <StackPanel Grid.Column="0" Spacing="8">
                                    <TextBlock Text="{loc:Loc 'Min Amount'}"
                                               FontSize="13"
                                               FontWeight="Medium"
                                               Foreground="{DynamicResource TextSecondaryBrush}" />
                                    <TextBox Text="{Binding FilterAmountMin}"
                                             Watermark="{loc:Loc '$0.00'}"
                                             behaviors:NumericInputBehavior.IsDecimalOnly="True"
                                             MaxLength="20" />
                                </StackPanel>
                                <StackPanel Grid.Column="2" Spacing="8">
                                    <TextBlock Text="{loc:Loc 'Max Amount'}"
                                               FontSize="13"
                                               FontWeight="Medium"
                                               Foreground="{DynamicResource TextSecondaryBrush}" />
                                    <TextBox Text="{Binding FilterAmountMax}"
                                             Watermark="{loc:Loc '$0.00'}"
                                             behaviors:NumericInputBehavior.IsDecimalOnly="True"
                                             MaxLength="20" />
                                </StackPanel>
                            </Grid>

                            <!-- Source Filter -->
                            <StackPanel Spacing="8">
                                <TextBlock Text="{loc:Loc Source}"
                                           FontSize="13"
                                           FontWeight="Medium"
                                           Foreground="{DynamicResource TextSecondaryBrush}" />
                                <ComboBox ItemsSource="{Binding SourceOptions}"
                                          SelectedItem="{Binding FilterSource}"
                                          HorizontalAlignment="Stretch">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Converter={StaticResource TranslateConverter}}" />
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </StackPanel>

                            <!-- File Type Filter -->
                            <StackPanel Spacing="8">
                                <TextBlock Text="{loc:Loc 'File Type'}"
                                           FontSize="13"
                                           FontWeight="Medium"
                                           Foreground="{DynamicResource TextSecondaryBrush}" />
                                <ComboBox ItemsSource="{Binding FileTypeOptions}"
                                          SelectedItem="{Binding FilterFileType}"
                                          HorizontalAlignment="Stretch">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Converter={StaticResource TranslateConverter}}" />
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>

                    <!-- Modal Footer -->
                    <Border Grid.Row="2"
                            Padding="24,16"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="0,1,0,0">
                        <Grid ColumnDefinitions="*,Auto,Auto">
                            <Button Grid.Column="0"
                                    Content="{loc:Loc 'Clear Filters'}"
                                    Classes="secondary-button"
                                    HorizontalAlignment="Left"
                                    Command="{Binding ClearFiltersCommand}" />
                            <Button Grid.Column="1"
                                    Content="{loc:Loc Cancel}"
                                    Classes="secondary-button"
                                    Margin="0,0,12,0"
                                    Command="{Binding CloseFilterModalCommand}" />
                            <Button Grid.Column="2"
                                    Content="{loc:Loc 'Apply Filters'}"
                                    Classes="primary-button"
                                    Command="{Binding ApplyFiltersCommand}" />
                        </Grid>
                    </Border>
                </Grid>
            </Border>
            </controls:ModalOverlay.ModalContent>
        </controls:ModalOverlay>

        <!-- ======================= AI SCAN REVIEW MODAL ======================= -->
        <controls:ModalOverlay IsOpen="{Binding IsScanReviewModalOpen}"
                               ClosingCommand="{Binding RequestCloseScanReviewModalCommand}">
            <controls:ModalOverlay.ModalContent>
                <Border HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Width="{Binding ModalWidth}"
                    MaxHeight="850"
                    Background="{DynamicResource SurfaceBrush}"
                    CornerRadius="12"
                    BoxShadow="0 8 32 0 #40000000">
                    <Border.Transitions>
                        <Transitions>
                            <DoubleTransition Property="Width" Duration="0:0:0.2" Easing="CubicEaseInOut" />
                        </Transitions>
                    </Border.Transitions>
                <Grid RowDefinitions="Auto,*,Auto">
                    <!-- Header -->
                    <Border Grid.Row="0"
                            Padding="24,16"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="0,0,0,1">
                        <Grid ColumnDefinitions="*,Auto,Auto">
                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                                <PathIcon Data="{x:Static icons:Icons.ScanReceipt}"
                                          Width="24" Height="24"
                                          Foreground="{DynamicResource PrimaryBrush}" />
                                <TextBlock Text="{loc:Loc 'AI Receipt Scanner'}"
                                           FontSize="18"
                                           FontWeight="SemiBold"
                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                           VerticalAlignment="Center" />
                            </StackPanel>
                            <!-- Usage Indicator (only show when results are displayed) -->
                            <Border Grid.Column="1"
                                    IsVisible="{Binding HasScanResult}"
                                    Background="{DynamicResource SurfaceAltBrush}"
                                    CornerRadius="6"
                                    Padding="12,6"
                                    Margin="0,0,16,0"
                                    VerticalAlignment="Center">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <PathIcon Data="{x:Static icons:Icons.DocumentNotes}"
                                              Width="14" Height="14"
                                              Foreground="{DynamicResource TextTertiaryBrush}" />
                                    <TextBlock FontSize="12"
                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                               VerticalAlignment="Center">
                                        <Run Text="{Binding ScansUsed}" />
                                        <Run Text="/" />
                                        <Run Text="{Binding ScansLimit}" />
                                        <Run Text="{loc:Loc ' scans this month'}" />
                                    </TextBlock>
                                    <!-- Warning icon when near limit -->
                                    <PathIcon Data="{x:Static icons:Icons.LostDamaged}"
                                              Width="14" Height="14"
                                              Foreground="#CA8A04"
                                              IsVisible="{Binding IsNearLimit}"
                                              ToolTip.Tip="{loc:Loc 'Running low on scans this month'}" />
                                </StackPanel>
                            </Border>
                            <Button Grid.Column="2"
                                    Classes="icon-button"
                                    Command="{Binding RequestCloseScanReviewModalCommand}">
                                <PathIcon Data="{x:Static icons:Icons.Close}"
                                          Width="20" Height="20" />
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Content -->
                    <Panel Grid.Row="1">
                            <!-- Loading State -->
                            <StackPanel IsVisible="{Binding IsScanning}"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        Spacing="16"
                                        Margin="48">
                                <controls:LoadingSpinner SizePreset="Large" />
                                <TextBlock Text="{Binding ScanningMessage}"
                                           FontSize="16"
                                           Foreground="{DynamicResource TextSecondaryBrush}"
                                           HorizontalAlignment="Center" />
                                <TextBlock Text="{loc:Loc 'This may take a few seconds...'}"
                                           FontSize="13"
                                           Foreground="{DynamicResource TextTertiaryBrush}"
                                           HorizontalAlignment="Center" />
                            </StackPanel>

                            <!-- Error State -->
                            <StackPanel IsVisible="{Binding HasScanError}"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        Spacing="16"
                                        Margin="48"
                                        MaxWidth="400">
                                <Border Background="{DynamicResource ErrorLightBrush}"
                                        CornerRadius="50"
                                        Padding="16"
                                        HorizontalAlignment="Center">
                                    <PathIcon Data="{x:Static icons:Icons.WarningCircle}"
                                              Width="32" Height="32"
                                              Foreground="{DynamicResource ErrorBrush}" />
                                </Border>
                                <TextBlock Text="{loc:Loc 'Scan Failed'}"
                                           FontSize="18"
                                           FontWeight="SemiBold"
                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                           HorizontalAlignment="Center" />
                                <TextBlock Text="{Binding ScanErrorMessage}"
                                           FontSize="14"
                                           Foreground="{DynamicResource TextSecondaryBrush}"
                                           TextWrapping="Wrap"
                                           TextAlignment="Center"
                                           HorizontalAlignment="Center" />
                                <StackPanel Orientation="Horizontal" Spacing="12" HorizontalAlignment="Center" Margin="0,8,0,0">
                                    <Button Classes="secondary-button"
                                            Command="{Binding RetryScanCommand}">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <PathIcon Data="{x:Static icons:Icons.RefreshCircle}"
                                                      Width="16" Height="16" />
                                            <TextBlock Text="{loc:Loc 'Retry'}" />
                                        </StackPanel>
                                    </Button>
                                    <Button Classes="secondary-button"
                                            Command="{Binding CloseScanReviewModalCommand}"
                                            Content="{loc:Loc 'Cancel'}" />
                                </StackPanel>
                            </StackPanel>

                            <!-- Results State -->
                            <Grid IsVisible="{Binding HasScanResult}"
                                  ColumnDefinitions="2*,3*"
                                  Margin="24">
                                <!-- Left: Receipt Preview (zoomable/pannable) -->
                                <Border Grid.Column="0"
                                        Background="{DynamicResource SurfaceAltBrush}"
                                        CornerRadius="8"
                                        Margin="0,0,24,0"
                                        ClipToBounds="True">
                                    <Grid RowDefinitions="Auto,*,Auto">
                                        <TextBlock Grid.Row="0"
                                                   Text="{loc:Loc 'Receipt Preview'}"
                                                   FontSize="13"
                                                   FontWeight="Medium"
                                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                                   Margin="16,12" />
                                        <Border Grid.Row="1"
                                                Background="#1A000000"
                                                Margin="8,0,8,4"
                                                CornerRadius="4"
                                                ClipToBounds="True">
                                            <ScrollViewer x:Name="ScanPreviewScrollViewer"
                                                          HorizontalScrollBarVisibility="Auto"
                                                          VerticalScrollBarVisibility="Auto">
                                                <LayoutTransformControl x:Name="ScanPreviewZoomTransform"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center">
                                                    <Image x:Name="ScanPreviewImage"
                                                           Source="{Binding ReceiptImagePath, Converter={x:Static local:BoolConverters.ToImageSource}}"
                                                           Stretch="Uniform" />
                                                </LayoutTransformControl>
                                            </ScrollViewer>
                                        </Border>
                                        <!-- Zoom Controls -->
                                        <StackPanel Grid.Row="2"
                                                    Orientation="Horizontal"
                                                    Spacing="2"
                                                    HorizontalAlignment="Center"
                                                    Margin="4,0,4,8">
                                            <Button Classes="icon-button"
                                                    Click="ScanPreviewZoomOut_Click"
                                                    ToolTip.Tip="{loc:Loc 'Zoom Out'}">
                                                <PathIcon Data="{x:Static icons:Icons.ZoomOut}"
                                                          Width="14" Height="14" />
                                            </Button>
                                            <Slider x:Name="ScanPreviewZoomSlider"
                                                    Minimum="0.25"
                                                    Maximum="4.0"
                                                    Width="80"
                                                    VerticalAlignment="Center"
                                                    ValueChanged="ScanPreviewZoomSlider_ValueChanged" />
                                            <Button Classes="icon-button"
                                                    Click="ScanPreviewZoomIn_Click"
                                                    ToolTip.Tip="{loc:Loc 'Zoom In'}">
                                                <PathIcon Data="{x:Static icons:Icons.ZoomIn}"
                                                          Width="14" Height="14" />
                                            </Button>
                                            <TextBlock x:Name="ScanPreviewZoomText"
                                                       Text="100%"
                                                       VerticalAlignment="Center"
                                                       FontSize="11"
                                                       Width="38"
                                                       TextAlignment="Center"
                                                       Foreground="{DynamicResource TextSecondaryBrush}" />
                                            <Button Classes="icon-button"
                                                    Click="ScanPreviewFitToWindow_Click"
                                                    ToolTip.Tip="{loc:Loc 'Fit to Window'}">
                                                <PathIcon Data="{x:Static icons:Icons.ScanFocus}"
                                                          Width="14" Height="14" />
                                            </Button>
                                        </StackPanel>
                                    </Grid>
                                </Border>

                                <!-- Right: Extracted Data -->
                                <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                                <StackPanel Spacing="20">
                                    <!-- Confidence Score -->
                                    <Border Background="{DynamicResource SurfaceAltBrush}"
                                            CornerRadius="8"
                                            Padding="16">
                                        <Grid ColumnDefinitions="*,Auto">
                                            <StackPanel Grid.Column="0">
                                                <TextBlock Text="{loc:Loc 'Extraction Confidence'}"
                                                           FontSize="13"
                                                           Foreground="{DynamicResource TextSecondaryBrush}" />
                                                <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,4,0,0">
                                                    <TextBlock Text="{Binding ConfidenceText}"
                                                               FontSize="24"
                                                               FontWeight="Bold"
                                                               Foreground="{DynamicResource TextPrimaryBrush}" />
                                                    <Border Background="{DynamicResource SuccessLightBrush}"
                                                            CornerRadius="4"
                                                            Padding="8,4"
                                                            VerticalAlignment="Center"
                                                            IsVisible="{Binding IsHighConfidence}">
                                                        <TextBlock Text="{loc:Loc 'High'}"
                                                                   FontSize="12"
                                                                   FontWeight="Medium"
                                                                   Foreground="#16A34A" />
                                                    </Border>
                                                    <Border Background="{DynamicResource WarningLightBrush}"
                                                            CornerRadius="4"
                                                            Padding="8,4"
                                                            VerticalAlignment="Center"
                                                            IsVisible="{Binding IsMediumConfidence}">
                                                        <TextBlock Text="{loc:Loc 'Medium'}"
                                                                   FontSize="12"
                                                                   FontWeight="Medium"
                                                                   Foreground="#CA8A04" />
                                                    </Border>
                                                    <Border Background="{DynamicResource ErrorLightBrush}"
                                                            CornerRadius="4"
                                                            Padding="8,4"
                                                            VerticalAlignment="Center"
                                                            IsVisible="{Binding IsLowConfidence}">
                                                        <TextBlock Text="{loc:Loc 'Low - Review Carefully'}"
                                                                   FontSize="12"
                                                                   FontWeight="Medium"
                                                                   Foreground="{DynamicResource ErrorBrush}" />
                                                    </Border>
                                                </StackPanel>
                                            </StackPanel>
                                            <PathIcon Grid.Column="1"
                                                      Data="{x:Static icons:Icons.Check}"
                                                      Width="24" Height="24"
                                                      Foreground="#16A34A"
                                                      VerticalAlignment="Center"
                                                      IsVisible="{Binding IsHighConfidence}" />
                                        </Grid>
                                    </Border>

                                    <!-- Basic Info -->
                                    <StackPanel Spacing="12">
                                        <TextBlock Text="{loc:Loc 'Extracted Information'}"
                                                   FontSize="14"
                                                   FontWeight="SemiBold"
                                                   Foreground="{DynamicResource TextPrimaryBrush}" />

                                        <!-- Date and Total Row -->
                                        <Grid ColumnDefinitions="*,16,*">
                                            <StackPanel Grid.Column="0" Spacing="6">
                                                <TextBlock Text="{loc:Loc 'Date'}"
                                                           FontSize="13"
                                                           FontWeight="Medium"
                                                           Foreground="{DynamicResource TextSecondaryBrush}" />
                                                <DatePicker SelectedDate="{Binding ExtractedDate}"
                                                            Classes="form-datepicker"
                                                            HorizontalAlignment="Stretch" />
                                            </StackPanel>
                                            <StackPanel Grid.Column="2" Spacing="6">
                                                <TextBlock FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextSecondaryBrush}">
                                                    <Run Text="{loc:Loc 'Total'}" /><Run Text=" *" Foreground="{DynamicResource ErrorBrush}" />
                                                </TextBlock>
                                                <TextBox Text="{Binding ExtractedTotal}"
                                                         Watermark="0.00"
                                                         Classes="form-input"
                                                         BorderBrush="{Binding HasTotalError, Converter={x:Static local:BoolConverters.ToErrorBorderBrush}}"
                                                         behaviors:NumericInputBehavior.IsDecimalOnly="True"
                                                         MaxLength="20" />
                                                <TextBlock Text="{Binding TotalErrorMessage}"
                                                           FontSize="12"
                                                           Foreground="{DynamicResource ErrorBrush}"
                                                           IsVisible="{Binding HasTotalError}" />
                                            </StackPanel>
                                        </Grid>

                                        <!-- Subtotal and Tax Row -->
                                        <Grid ColumnDefinitions="*,16,*">
                                            <StackPanel Grid.Column="0" Spacing="6">
                                                <TextBlock Text="{loc:Loc 'Subtotal'}"
                                                           FontSize="13"
                                                           FontWeight="Medium"
                                                           Foreground="{DynamicResource TextSecondaryBrush}" />
                                                <TextBox Text="{Binding ExtractedSubtotal}"
                                                         Watermark="0.00"
                                                         Classes="form-input"
                                                         behaviors:NumericInputBehavior.IsDecimalOnly="True"
                                                         MaxLength="20" />
                                            </StackPanel>
                                            <StackPanel Grid.Column="2" Spacing="6">
                                                <TextBlock Text="{loc:Loc 'Tax'}"
                                                           FontSize="13"
                                                           FontWeight="Medium"
                                                           Foreground="{DynamicResource TextSecondaryBrush}" />
                                                <TextBox Text="{Binding ExtractedTax}"
                                                         Watermark="0.00"
                                                         Classes="form-input"
                                                         behaviors:NumericInputBehavior.IsDecimalOnly="True"
                                                         MaxLength="20" />
                                            </StackPanel>
                                        </Grid>
                                    </StackPanel>

                                    <!-- Line Items Section -->
                                    <StackPanel Spacing="12">
                                        <Grid ColumnDefinitions="*,Auto">
                                            <TextBlock Grid.Column="0"
                                                       Text="{loc:Loc 'Line Items'}"
                                                       FontSize="14"
                                                       FontWeight="SemiBold"
                                                       Foreground="{DynamicResource TextPrimaryBrush}" />
                                            <Button Grid.Column="1"
                                                    Classes="secondary-button"
                                                    Command="{Binding AddLineItemCommand}">
                                                <StackPanel Orientation="Horizontal" Spacing="6">
                                                    <PathIcon Data="{x:Static icons:Icons.Add}"
                                                              Width="14" Height="14" />
                                                    <TextBlock Text="{loc:Loc 'Add Item'}" />
                                                </StackPanel>
                                            </Button>
                                        </Grid>

                                        <!-- Line Items Header -->
                                        <Border Background="{DynamicResource SurfaceAltBrush}"
                                                CornerRadius="6"
                                                Padding="12,8"
                                                IsVisible="{Binding LineItems.Count}">
                                            <Grid ColumnDefinitions="*,70,80,80,32">
                                                <TextBlock Grid.Column="0" Text="{loc:Loc 'Product'}" FontSize="12" FontWeight="Medium"
                                                           Foreground="{DynamicResource TextTertiaryBrush}" />
                                                <TextBlock Grid.Column="1" Text="{loc:Loc 'Quantity'}" FontSize="12" FontWeight="Medium"
                                                           Foreground="{DynamicResource TextTertiaryBrush}"
                                                           HorizontalAlignment="Center" />
                                                <TextBlock Grid.Column="2" Text="{loc:Loc 'Unit Price'}" FontSize="12" FontWeight="Medium"
                                                           Foreground="{DynamicResource TextTertiaryBrush}"
                                                           HorizontalAlignment="Center" />
                                                <TextBlock Grid.Column="3" Text="{loc:Loc 'Total'}" FontSize="12" FontWeight="Medium"
                                                           Foreground="{DynamicResource TextTertiaryBrush}"
                                                           HorizontalAlignment="Right" />
                                            </Grid>
                                        </Border>

                                        <!-- Line Items List -->
                                        <ItemsControl ItemsSource="{Binding LineItems}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate DataType="vm:ScannedLineItemViewModel">
                                                    <Border Padding="12,8"
                                                            BorderBrush="{DynamicResource BorderBrush}"
                                                            BorderThickness="0,0,0,1">
                                                        <Grid ColumnDefinitions="*,70,80,80,32" RowDefinitions="Auto,Auto">
                                                            <StackPanel Grid.Column="0" Grid.Row="0" Margin="0,0,8,0">
                                                                <controls:SearchableDropdown
                                                                    ItemsSource="{Binding $parent[ItemsControl].((vm:ReceiptsModalsViewModel)DataContext).ProductOptions}"
                                                                    SelectedItem="{Binding SelectedProduct, Mode=TwoWay}"
                                                                    DisplayMemberPath="Name"
                                                                    Placeholder="{loc:Loc 'Search for a product...'}"
                                                                    ShowAddNew="False"
                                                                    EmptyMessage="{loc:Loc 'No products found.'}"
                                                                    EmptyCreateLinkText="{loc:Loc 'Create one'}"
                                                                    EmptyCreateCommand="{Binding $parent[ItemsControl].((vm:ReceiptsModalsViewModel)DataContext).NavigateToCreateProductCommand}"
                                                                    HasError="{Binding HasProductError}"
                                                                    ErrorMessage="{Binding ProductErrorMessage}" />
                                                                <!-- Create Product Suggestion -->
                                                                <Border IsVisible="{Binding ShowCreateProductSuggestion}"
                                                                        Background="{DynamicResource WarningLightBrush}"
                                                                        CornerRadius="6"
                                                                        Padding="8"
                                                                        Margin="0,4,0,0">
                                                                    <Grid ColumnDefinitions="*,Auto,Auto">
                                                                        <StackPanel Grid.Column="0" Spacing="2">
                                                                            <TextBlock Text="{loc:Loc 'Suggested product:'}"
                                                                                       FontSize="11"
                                                                                       Foreground="#92400E" />
                                                                            <TextBlock Text="{Binding SuggestedProductName}"
                                                                                       FontSize="12"
                                                                                       FontWeight="SemiBold"
                                                                                       Foreground="#78350F" />
                                                                        </StackPanel>
                                                                        <Button Grid.Column="1"
                                                                                Content="{loc:Loc 'Create'}"
                                                                                Command="{Binding $parent[ItemsControl].((vm:ReceiptsModalsViewModel)DataContext).CreateSuggestedProductCommand}"
                                                                                CommandParameter="{Binding}"
                                                                                Classes="primary-button"
                                                                                Padding="10,4"
                                                                                Margin="8,0,0,0"
                                                                                FontSize="11" />
                                                                        <Button Grid.Column="2"
                                                                                Command="{Binding $parent[ItemsControl].((vm:ReceiptsModalsViewModel)DataContext).DismissProductSuggestionCommand}"
                                                                                CommandParameter="{Binding}"
                                                                                Background="Transparent"
                                                                                BorderThickness="0"
                                                                                Padding="8,4"
                                                                                Margin="4,0,0,0"
                                                                                Cursor="Hand">
                                                                            <PathIcon Data="{x:Static icons:Icons.Close}"
                                                                                      Width="14" Height="14"
                                                                                      Foreground="#92400E" />
                                                                        </Button>
                                                                    </Grid>
                                                                </Border>
                                                            </StackPanel>
                                                            <TextBox Grid.Column="1" Grid.Row="0"
                                                                     Text="{Binding Quantity}"
                                                                     HorizontalContentAlignment="Center"
                                                                     VerticalAlignment="Top"
                                                                     Margin="0,0,8,0"
                                                                     behaviors:NumericInputBehavior.IsIntegerOnly="True"
                                                                     MaxLength="10" />
                                                            <TextBox Grid.Column="2" Grid.Row="0"
                                                                     Text="{Binding UnitPrice}"
                                                                     HorizontalContentAlignment="Center"
                                                                     VerticalAlignment="Top"
                                                                     Margin="0,0,8,0"
                                                                     behaviors:NumericInputBehavior.IsDecimalOnly="True"
                                                                     MaxLength="20" />
                                                            <TextBlock Grid.Column="3" Grid.Row="0"
                                                                       Text="{Binding TotalPrice, StringFormat='${0}'}"
                                                                       FontSize="14"
                                                                       FontWeight="Medium"
                                                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                                                       HorizontalAlignment="Right"
                                                                       VerticalAlignment="Top"
                                                                       Margin="0,10,10,0" />
                                                            <Button Grid.Column="4" Grid.Row="0"
                                                                    Classes="icon-button danger"
                                                                    VerticalAlignment="Top"
                                                                    Command="{Binding $parent[ItemsControl].((vm:ReceiptsModalsViewModel)DataContext).RemoveLineItemCommand}"
                                                                    CommandParameter="{Binding}"
                                                                    ToolTip.Tip="{loc:Loc 'Remove item'}">
                                                                <PathIcon Data="{x:Static icons:Icons.Delete}"
                                                                          Width="14" Height="14" />
                                                            </Button>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>

                                        <!-- No Line Items Message -->
                                        <Border Background="{DynamicResource SurfaceAltBrush}"
                                                CornerRadius="8"
                                                Padding="24,16"
                                                IsVisible="{Binding !LineItems.Count}">
                                            <TextBlock Text="{loc:Loc 'No line items detected. Click Add Item to manually add items.'}"
                                                       FontSize="13"
                                                       Foreground="{DynamicResource TextTertiaryBrush}"
                                                       HorizontalAlignment="Center" />
                                        </Border>
                                    </StackPanel>

                                    <!-- Additional Options -->
                                    <StackPanel Spacing="12">
                                        <TextBlock Text="{loc:Loc 'Additional Options'}"
                                                   FontSize="14"
                                                   FontWeight="SemiBold"
                                                   Foreground="{DynamicResource TextPrimaryBrush}" />

                                        <!-- AI Loading Indicator -->
                                        <Border IsVisible="{Binding IsLoadingAiSuggestions}"
                                                Background="#EBF5FF"
                                                CornerRadius="6"
                                                Padding="12"
                                                Margin="0,0,0,8">
                                            <StackPanel Orientation="Horizontal" Spacing="10">
                                                <controls:LoadingSpinner SizePreset="Small" />
                                                <TextBlock Text="{loc:Loc 'AI is suggesting supplier...'}"
                                                           FontSize="13"
                                                           Foreground="#1E40AF"
                                                           VerticalAlignment="Center" />
                                            </StackPanel>
                                        </Border>

                                        <!-- Transaction Type Tabs (Expense/Revenue) -->
                                        <StackPanel Spacing="8" Margin="0,0,0,12">
                                            <TextBlock Text="{loc:Loc 'Transaction Type'}"
                                                       FontSize="13"
                                                       FontWeight="Medium"
                                                       Foreground="{DynamicResource TextSecondaryBrush}" />
                                            <Grid ColumnDefinitions="*,*">
                                                <Grid.Styles>
                                                    <Style Selector="Button.transaction-type-tab">
                                                        <Setter Property="Background" Value="{DynamicResource SurfaceAltBrush}" />
                                                        <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
                                                        <Setter Property="BorderThickness" Value="1" />
                                                        <Setter Property="Padding" Value="16,12" />
                                                        <Setter Property="Cursor" Value="Hand" />
                                                        <Setter Property="HorizontalAlignment" Value="Stretch" />
                                                        <Setter Property="HorizontalContentAlignment" Value="Center" />
                                                        <Setter Property="FontSize" Value="13" />
                                                        <Setter Property="FontWeight" Value="Medium" />
                                                        <Setter Property="CornerRadius" Value="8,0,0,8" />
                                                    </Style>
                                                    <Style Selector="Button.transaction-type-tab /template/ ContentPresenter#PART_ContentPresenter">
                                                        <Setter Property="Background" Value="{DynamicResource SurfaceAltBrush}" />
                                                    </Style>
                                                    <Style Selector="Button.transaction-type-tab:pointerover /template/ ContentPresenter#PART_ContentPresenter">
                                                        <Setter Property="Background" Value="{DynamicResource SurfaceHoverBrush}" />
                                                    </Style>
                                                    <Style Selector="Button.transaction-type-tab.selected">
                                                        <Setter Property="Background" Value="{DynamicResource PrimaryBrush}" />
                                                        <Setter Property="BorderBrush" Value="{DynamicResource PrimaryBrush}" />
                                                        <Setter Property="Foreground" Value="White" />
                                                    </Style>
                                                    <Style Selector="Button.transaction-type-tab.selected /template/ ContentPresenter#PART_ContentPresenter">
                                                        <Setter Property="Background" Value="{DynamicResource PrimaryBrush}" />
                                                    </Style>
                                                    <Style Selector="Button.transaction-type-tab.right">
                                                        <Setter Property="CornerRadius" Value="0,8,8,0" />
                                                    </Style>
                                                </Grid.Styles>
                                                <!-- Expense Tab -->
                                                <Button Grid.Column="0"
                                                        Content="{loc:Loc 'Expense'}"
                                                        Classes="transaction-type-tab"
                                                        Classes.selected="{Binding !IsRevenue}"
                                                        Command="{Binding SetTransactionTypeCommand}"
                                                        CommandParameter="Expense"
                                                        IsEnabled="{Binding !IsLoadingAiSuggestions}" />
                                                <!-- Revenue Tab -->
                                                <Button Grid.Column="1"
                                                        Content="{loc:Loc 'Revenue'}"
                                                        Classes="transaction-type-tab right"
                                                        Classes.selected="{Binding IsRevenue}"
                                                        Command="{Binding SetTransactionTypeCommand}"
                                                        CommandParameter="Revenue"
                                                        IsEnabled="{Binding !IsLoadingAiSuggestions}" />
                                            </Grid>
                                        </StackPanel>

                                        <!-- Supplier Row -->
                                        <Grid>
                                            <StackPanel Spacing="6"
                                                        IsVisible="{Binding !IsRevenue}">
                                                <TextBlock FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextSecondaryBrush}">
                                                    <Run Text="{loc:Loc 'Supplier'}" /><Run Text=" *" Foreground="{DynamicResource ErrorBrush}" />
                                                </TextBlock>
                                                <controls:SearchableDropdown
                                                    ItemsSource="{Binding SupplierOptions}"
                                                    SelectedItem="{Binding SelectedSupplier, Mode=TwoWay}"
                                                    DisplayMemberPath="Name"
                                                    Placeholder="{loc:Loc 'Search for a supplier...'}"
                                                    ShowAddNew="False"
                                                    EmptyMessage="{loc:Loc 'No suppliers found.'}"
                                                    EmptyCreateLinkText="{loc:Loc 'Create one'}"
                                                    EmptyCreateCommand="{Binding NavigateToCreateSupplierCommand}"
                                                    HasError="{Binding HasSupplierError}"
                                                    ErrorMessage="{Binding SupplierErrorMessage}"
                                                    IsEnabled="{Binding !IsLoadingAiSuggestions}" />
                                                <!-- AI Create Supplier Suggestion -->
                                                <Border IsVisible="{Binding ShowCreateSupplierSuggestion}"
                                                        Background="{DynamicResource WarningLightBrush}"
                                                        CornerRadius="6"
                                                        Padding="10">
                                                    <Grid ColumnDefinitions="*,Auto,Auto">
                                                        <StackPanel Grid.Column="0" Spacing="2">
                                                            <TextBlock Text="{loc:Loc 'Suggested supplier:'}"
                                                                       FontSize="11"
                                                                       Foreground="#92400E" />
                                                            <TextBlock Text="{Binding SuggestedSupplierName}"
                                                                       FontSize="12"
                                                                       FontWeight="SemiBold"
                                                                       Foreground="#78350F" />
                                                        </StackPanel>
                                                        <Button Grid.Column="1"
                                                                Content="{loc:Loc 'Create'}"
                                                                Command="{Binding CreateSuggestedSupplierCommand}"
                                                                Classes="primary-button"
                                                                Padding="10,4"
                                                                Margin="8,0,0,0"
                                                                FontSize="11" />
                                                        <Button Grid.Column="2"
                                                                Command="{Binding DismissSupplierSuggestionCommand}"
                                                                Background="Transparent"
                                                                BorderThickness="0"
                                                                Padding="8,4"
                                                                Margin="4,0,0,0"
                                                                Cursor="Hand">
                                                            <PathIcon Data="{x:Static icons:Icons.Close}"
                                                                      Width="14" Height="14"
                                                                      Foreground="#92400E" />
                                                        </Button>
                                                    </Grid>
                                                </Border>
                                            </StackPanel>
                                        </Grid>

                                        <!-- Payment Method -->
                                        <StackPanel Spacing="6">
                                            <TextBlock Text="{loc:Loc 'Payment Method'}"
                                                       FontSize="13"
                                                       FontWeight="Medium"
                                                       Foreground="{DynamicResource TextSecondaryBrush}" />
                                            <ComboBox ItemsSource="{Binding PaymentMethodOptions}"
                                                      SelectedItem="{Binding SelectedPaymentMethod}"
                                                      Classes="form-combobox"
                                                      HorizontalAlignment="Stretch">
                                                <ComboBox.ItemTemplate>
                                                    <DataTemplate>
                                                        <TextBlock Text="{Binding Converter={StaticResource TranslateConverter}}" />
                                                    </DataTemplate>
                                                </ComboBox.ItemTemplate>
                                            </ComboBox>
                                        </StackPanel>

                                        <!-- Notes -->
                                        <StackPanel Spacing="6">
                                            <TextBlock Text="{loc:Loc 'Notes'}"
                                                       FontSize="13"
                                                       FontWeight="Medium"
                                                       Foreground="{DynamicResource TextSecondaryBrush}" />
                                            <TextBox Text="{Binding Notes}"
                                                     Watermark="{loc:Loc 'Add any additional notes...'}"
                                                     Classes="form-input"
                                                     AcceptsReturn="True"
                                                     TextWrapping="Wrap"
                                                     Height="60"
                                                     MaxLength="500" />
                                        </StackPanel>
                                    </StackPanel>
                                </StackPanel>
                                </ScrollViewer>
                            </Grid>
                    </Panel>

                    <!-- Footer -->
                    <Border Grid.Row="2"
                            Padding="24,16"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="0,1,0,0"
                            IsVisible="{Binding HasScanResult}">
                        <Grid ColumnDefinitions="*,Auto,Auto">
                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                <PathIcon Data="{x:Static icons:Icons.Info}"
                                          Width="16" Height="16"
                                          Foreground="{DynamicResource TextTertiaryBrush}" />
                                <TextBlock Text="{loc:Loc 'Review the extracted data before creating the transaction.'}"
                                           FontSize="13"
                                           Foreground="{DynamicResource TextTertiaryBrush}"
                                           VerticalAlignment="Center" />
                            </StackPanel>
                            <Button Grid.Column="1"
                                    Content="{loc:Loc Cancel}"
                                    Classes="secondary-button"
                                    Margin="0,0,12,0"
                                    Command="{Binding RequestCloseScanReviewModalCommand}" />
                            <Button Grid.Column="2"
                                    Classes="primary-button"
                                    Command="{Binding CreateTransactionCommand}">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <PathIcon Data="{x:Static icons:Icons.Check}"
                                              Width="16" Height="16" />
                                    <!-- Show "Create Revenue" when IsRevenue, otherwise "Create Expense" -->
                                    <TextBlock IsVisible="{Binding IsRevenue}" Text="{loc:Loc 'Create Revenue'}" />
                                    <TextBlock IsVisible="{Binding !IsRevenue}" Text="{loc:Loc 'Create Expense'}" />
                                </StackPanel>
                            </Button>
                        </Grid>
                    </Border>
                </Grid>
            </Border>
            </controls:ModalOverlay.ModalContent>
        </controls:ModalOverlay>
    </Panel>
</UserControl>
