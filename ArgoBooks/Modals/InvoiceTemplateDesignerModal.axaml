<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ArgoBooks.ViewModels"
             xmlns:controls="using:ArgoBooks.Controls"
             xmlns:icons="using:ArgoBooks"
             xmlns:loc="using:ArgoBooks.Localization"
             xmlns:local="using:ArgoBooks.Converters"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="ArgoBooks.Modals.InvoiceTemplateDesignerModal"
             x:DataType="vm:InvoiceTemplateDesignerViewModel">

    <Design.DataContext>
        <vm:InvoiceTemplateDesignerViewModel />
    </Design.DataContext>

    <UserControl.Resources>
        <local:EqualConverter x:Key="EqualConverter" />
    </UserControl.Resources>

    <UserControl.Styles>
        <Style Selector="Button.property-tab-button">
            <Setter Property="Background" Value="{DynamicResource SurfaceAltBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Padding" Value="8,6" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="HorizontalAlignment" Value="Stretch" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="FontSize" Value="11" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Margin" Value="1" />
        </Style>
        <Style Selector="Button.property-tab-button /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SurfaceAltBrush}" />
        </Style>
        <Style Selector="Button.property-tab-button:pointerover /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SurfaceHoverBrush}" />
        </Style>
        <Style Selector="Button.property-tab-button.selected">
            <Setter Property="Background" Value="{DynamicResource PrimaryBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource PrimaryBrush}" />
            <Setter Property="Foreground" Value="White" />
        </Style>
        <Style Selector="Button.property-tab-button.selected /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource PrimaryBrush}" />
        </Style>
    </UserControl.Styles>

    <Panel>
        <controls:ModalOverlay IsOpen="{Binding IsOpen}">
            <controls:ModalOverlay.ModalContent>
                <Border Width="{Binding IsFullscreen, Converter={x:Static local:BoolConverters.ToFullscreenWidth}, ConverterParameter='1000,1100'}"
                        Height="{Binding IsFullscreen, Converter={x:Static local:BoolConverters.ToFullscreenHeight}, ConverterParameter=750}"
                        MaxWidth="{Binding IsFullscreen, Converter={x:Static local:BoolConverters.ToFullscreenMaxWidth}, ConverterParameter=1300}"
                        Margin="{Binding IsFullscreen, Converter={x:Static local:BoolConverters.ToFullscreenMargin}}"
                        HorizontalAlignment="{Binding IsFullscreen, Converter={x:Static local:BoolConverters.ToFullscreenHorizontalAlignment}}"
                        VerticalAlignment="{Binding IsFullscreen, Converter={x:Static local:BoolConverters.ToFullscreenVerticalAlignment}}"
                        Background="{DynamicResource SurfaceBrush}"
                        CornerRadius="12"
                        ClipToBounds="True"
                        BoxShadow="0 8 32 0 #40000000">
                    <Grid RowDefinitions="Auto,*,Auto">
                        <!-- Header -->
                        <Border Grid.Row="0"
                                Padding="24,16"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="0,0,0,1">
                            <Grid ColumnDefinitions="*,Auto">
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="{Binding ModalTitle}"
                                               FontSize="18"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource TextPrimaryBrush}" />
                                    <TextBlock Text="{loc:Loc 'Customize your invoice template'}"
                                               FontSize="13"
                                               Foreground="{DynamicResource TextSecondaryBrush}" />
                                </StackPanel>
                                <Button Grid.Column="1"
                                        Classes="icon-button"
                                        Command="{Binding CloseCommand}">
                                    <PathIcon Data="{x:Static icons:Icons.Close}"
                                              Width="20" Height="20" />
                                </Button>
                            </Grid>
                        </Border>

                        <!-- Content -->
                        <Grid Grid.Row="1" ColumnDefinitions="350,*">
                            <!-- Left Panel: Settings -->
                            <Border Grid.Column="0"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="0,0,1,0">
                                <Grid RowDefinitions="Auto,*">
                                    <!-- Fixed Header: Template Name, Base Template, Default -->
                                    <StackPanel Grid.Row="0" Margin="20,20,20,0" Spacing="16">
                                        <!-- Template Name -->
                                        <StackPanel Spacing="6">
                                            <TextBlock Text="{loc:Loc 'Template Name'}" FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextSecondaryBrush}" />
                                            <TextBox Text="{Binding TemplateName, Mode=TwoWay}"
                                                     Classes="form-input"
                                                     BorderBrush="{Binding HasValidationMessage, Converter={x:Static local:BoolConverters.ToErrorBorderBrush}}"
                                                     Watermark="{loc:Loc 'Enter template name...'}"
                                                     MaxLength="100" />
                                            <TextBlock Text="{Binding ValidationMessage}"
                                                       FontSize="13"
                                                       Foreground="{DynamicResource ErrorBrush}"
                                                       IsVisible="{Binding HasValidationMessage}" />
                                        </StackPanel>

                                        <!-- Base Template -->
                                        <StackPanel Spacing="6">
                                            <TextBlock Text="{loc:Loc 'Base Template'}" FontSize="13" FontWeight="Medium" Foreground="{DynamicResource TextSecondaryBrush}" />
                                            <ComboBox ItemsSource="{Binding BaseTemplateOptions}"
                                                      SelectedItem="{Binding SelectedBaseTemplate}"
                                                      Classes="form-combobox"
                                                      HorizontalAlignment="Stretch" />
                                        </StackPanel>

                                        <!-- Default Template -->
                                        <CheckBox IsChecked="{Binding IsDefault}"
                                                  Content="{loc:Loc 'Set as default template'}" />

                                        <Border Height="1" Background="{DynamicResource BorderBrush}" Margin="0,4,0,0" />

                                        <!-- Tab Buttons -->
                                        <Grid ColumnDefinitions="*,*,*,*">
                                            <Button Grid.Column="0"
                                                    Content="{loc:Loc 'Colors'}"
                                                    Classes="property-tab-button"
                                                    Classes.selected="{Binding PropertiesTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=0}"
                                                    Command="{Binding SetPropertiesTabCommand}"
                                                    CommandParameter="0" />
                                            <Button Grid.Column="1"
                                                    Content="{loc:Loc 'Logo'}"
                                                    Classes="property-tab-button"
                                                    Classes.selected="{Binding PropertiesTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=1}"
                                                    Command="{Binding SetPropertiesTabCommand}"
                                                    CommandParameter="1" />
                                            <Button Grid.Column="2"
                                                    Content="{loc:Loc 'Text'}"
                                                    Classes="property-tab-button"
                                                    Classes.selected="{Binding PropertiesTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=2}"
                                                    Command="{Binding SetPropertiesTabCommand}"
                                                    CommandParameter="2" />
                                            <Button Grid.Column="3"
                                                    Content="{loc:Loc 'Display'}"
                                                    Classes="property-tab-button"
                                                    Classes.selected="{Binding PropertiesTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=3}"
                                                    Command="{Binding SetPropertiesTabCommand}"
                                                    CommandParameter="3" />
                                        </Grid>
                                    </StackPanel>

                                    <!-- Scrollable Tab Content -->
                                    <ScrollViewer Grid.Row="1"
                                                  VerticalScrollBarVisibility="Auto"
                                                  HorizontalScrollBarVisibility="Disabled"
                                                  Margin="0,12,0,0">
                                        <StackPanel Margin="20,0,20,20">
                                            <!-- Colors Tab (Index 0) -->
                                            <StackPanel Spacing="10" IsVisible="{Binding PropertiesTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=0}">
                                                <!-- Header Color -->
                                                <Grid ColumnDefinitions="*,150">
                                                    <TextBlock Grid.Column="0" Text="{Binding HeaderColorLabel}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center" />
                                                    <controls:ColorPickerInput Grid.Column="1" ColorValue="{Binding HeaderColor, Mode=TwoWay}" />
                                                </Grid>

                                                <!-- Primary Color -->
                                                <Grid ColumnDefinitions="*,150">
                                                    <TextBlock Grid.Column="0" Text="{Binding PrimaryColorLabel}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center" />
                                                    <controls:ColorPickerInput Grid.Column="1" ColorValue="{Binding PrimaryColor, Mode=TwoWay}" />
                                                </Grid>

                                                <!-- Secondary Color -->
                                                <Grid ColumnDefinitions="*,150">
                                                    <TextBlock Grid.Column="0" Text="{Binding SecondaryColorLabel}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center" />
                                                    <controls:ColorPickerInput Grid.Column="1" ColorValue="{Binding SecondaryColor, Mode=TwoWay}" />
                                                </Grid>

                                                <!-- Accent Color -->
                                                <Grid ColumnDefinitions="*,150">
                                                    <TextBlock Grid.Column="0" Text="{Binding AccentColorLabel}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center" />
                                                    <controls:ColorPickerInput Grid.Column="1" ColorValue="{Binding AccentColor, Mode=TwoWay}" />
                                                </Grid>

                                                <!-- Text Color -->
                                                <Grid ColumnDefinitions="*,150">
                                                    <TextBlock Grid.Column="0" Text="Text Color" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center" />
                                                    <controls:ColorPickerInput Grid.Column="1" ColorValue="{Binding TextColor, Mode=TwoWay}" />
                                                </Grid>

                                                <!-- Background Color -->
                                                <Grid ColumnDefinitions="*,150">
                                                    <TextBlock Grid.Column="0" Text="Background" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center" />
                                                    <controls:ColorPickerInput Grid.Column="1" ColorValue="{Binding BackgroundColor, Mode=TwoWay}" />
                                                </Grid>
                                            </StackPanel>

                                            <!-- Logo Tab (Index 1) -->
                                            <StackPanel Spacing="10" IsVisible="{Binding PropertiesTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=1}">
                                                <CheckBox IsChecked="{Binding ShowLogo}"
                                                          Content="{loc:Loc 'Show logo on invoice'}" />

                                                <!-- No logo selected state -->
                                                <Button Classes="secondary-button"
                                                        Command="{Binding SelectLogoCommand}"
                                                        IsVisible="{Binding !HasLogo}"
                                                        HorizontalAlignment="Stretch"
                                                        HorizontalContentAlignment="Center"
                                                        Padding="12,10">
                                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                                        <PathIcon Data="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"
                                                                  Width="16" Height="16" />
                                                        <TextBlock Text="{loc:Loc 'Select Logo...'}" />
                                                    </StackPanel>
                                                </Button>

                                                <!-- Logo selected state -->
                                                <StackPanel Spacing="8" IsVisible="{Binding HasLogo}">
                                                    <Grid ColumnDefinitions="Auto,*">
                                                        <PathIcon Grid.Column="0"
                                                                  Data="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"
                                                                  Width="16" Height="16"
                                                                  Foreground="{DynamicResource TextSecondaryBrush}"
                                                                  VerticalAlignment="Center"
                                                                  Margin="0,0,8,0" />
                                                        <TextBlock Grid.Column="1"
                                                                   Text="{Binding LogoFileName}"
                                                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                                                   TextTrimming="CharacterEllipsis"
                                                                   VerticalAlignment="Center"
                                                                   ToolTip.Tip="{Binding LogoPath}" />
                                                    </Grid>
                                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                                        <Button Classes="secondary-button"
                                                                Content="{loc:Loc 'Change'}"
                                                                Command="{Binding SelectLogoCommand}"
                                                                Padding="12,6" />
                                                        <Button Classes="secondary-button danger"
                                                                Content="{loc:Loc 'Remove'}"
                                                                Command="{Binding RemoveLogoCommand}"
                                                                Padding="12,6" />
                                                    </StackPanel>
                                                </StackPanel>

                                                <StackPanel Spacing="4" IsVisible="{Binding ShowLogo}">
                                                    <Grid ColumnDefinitions="*,80">
                                                        <TextBlock Grid.Column="0" Text="{loc:Loc 'Logo Width (px)'}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center" />
                                                        <TextBox Grid.Column="1"
                                                                 Text="{Binding LogoWidthText, Mode=TwoWay}"
                                                                 Classes="form-input"
                                                                 HorizontalContentAlignment="Center"
                                                                 MaxLength="5" />
                                                    </Grid>
                                                    <TextBlock Text="{loc:Loc 'Range: 20-300 px'}"
                                                               FontSize="11"
                                                               Foreground="{DynamicResource TextTertiaryBrush}"
                                                               IsVisible="{Binding !HasLogoWidthWarning}" />
                                                    <TextBlock Text="{Binding LogoWidthWarning}"
                                                               FontSize="11"
                                                               Foreground="{DynamicResource ErrorBrush}"
                                                               IsVisible="{Binding HasLogoWidthWarning}" />
                                                    <CheckBox IsChecked="{Binding LockAspectRatio}"
                                                              Content="{loc:Loc 'Lock aspect ratio'}"
                                                              Margin="0,4,0,0" />
                                                </StackPanel>
                                            </StackPanel>

                                            <!-- Text Tab (Index 2) -->
                                            <StackPanel Spacing="10" IsVisible="{Binding PropertiesTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=2}">
                                                <StackPanel Spacing="4">
                                                    <TextBlock Text="{loc:Loc 'Header Text'}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" />
                                                    <TextBox Text="{Binding HeaderText, Mode=TwoWay}" Classes="form-input" MaxLength="200" />
                                                </StackPanel>

                                                <StackPanel Spacing="4">
                                                    <TextBlock Text="{loc:Loc 'Footer Text'}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" />
                                                    <TextBox Text="{Binding FooterText, Mode=TwoWay}" Classes="form-input" MaxLength="500" />
                                                </StackPanel>

                                                <StackPanel Spacing="4">
                                                    <TextBlock Text="{loc:Loc 'Payment Instructions'}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" />
                                                    <TextBox Text="{Binding PaymentInstructions, Mode=TwoWay}"
                                                             Classes="form-input"
                                                             AcceptsReturn="True"
                                                             TextWrapping="Wrap"
                                                             MinHeight="60"
                                                             Watermark="{loc:Loc 'Bank details, payment methods, etc.'}"
                                                             MaxLength="1000" />
                                                </StackPanel>

                                                <StackPanel Spacing="4">
                                                    <TextBlock Text="{loc:Loc 'Default Notes'}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" />
                                                    <TextBox Text="{Binding DefaultNotes, Mode=TwoWay}"
                                                             Classes="form-input"
                                                             AcceptsReturn="True"
                                                             TextWrapping="Wrap"
                                                             MinHeight="60"
                                                             Watermark="{loc:Loc 'Default notes for invoices using this template...'}"
                                                             MaxLength="500" />
                                                </StackPanel>

                                                <Border Height="1" Background="{DynamicResource BorderBrush}" Margin="0,6" />

                                                <StackPanel Spacing="6">
                                                    <TextBlock Text="{loc:Loc 'Font Family'}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" />
                                                    <ComboBox ItemsSource="{Binding FontFamilyOptions}"
                                                              SelectedItem="{Binding SelectedFontFamily}"
                                                              Classes="form-combobox"
                                                              HorizontalAlignment="Stretch" />
                                                </StackPanel>
                                            </StackPanel>

                                            <!-- Display Options Tab (Index 3) -->
                                            <StackPanel Spacing="8" IsVisible="{Binding PropertiesTabIndex, Converter={StaticResource EqualConverter}, ConverterParameter=3}">
                                                <CheckBox IsChecked="{Binding ShowCompanyAddress}"
                                                          Content="{loc:Loc 'Show company address'}" />
                                                <CheckBox IsChecked="{Binding ShowCompanyPhone}"
                                                          Content="{loc:Loc 'Show company phone'}" />
                                                <CheckBox IsChecked="{Binding ShowCompanyCity}"
                                                          Content="{loc:Loc 'Show company city'}" />
                                                <CheckBox IsChecked="{Binding ShowCompanyProvinceState}"
                                                          Content="{loc:Loc 'Show company province / state'}" />
                                                <CheckBox IsChecked="{Binding ShowCompanyCountry}"
                                                          Content="{loc:Loc 'Show company country'}" />
                                                <CheckBox IsChecked="{Binding ShowTaxBreakdown}"
                                                          Content="{loc:Loc 'Show tax breakdown'}" />
                                                <CheckBox IsChecked="{Binding ShowNotes}"
                                                          Content="{loc:Loc 'Show notes section'}" />
                                                <CheckBox IsChecked="{Binding ShowPaymentInstructions}"
                                                          Content="{loc:Loc 'Show payment instructions'}" />
                                            </StackPanel>
                                        </StackPanel>
                                    </ScrollViewer>
                                </Grid>
                            </Border>

                            <!-- Right Panel: Preview -->
                            <Grid Grid.Column="1" RowDefinitions="Auto,*,Auto">
                                <Border Grid.Row="0" Padding="20,15" Background="{DynamicResource SurfaceAltBrush}">
                                    <Grid ColumnDefinitions="*,Auto">
                                        <TextBlock Grid.Column="0"
                                                   Text="{loc:Loc Preview}"
                                                   FontSize="14"
                                                   FontWeight="SemiBold"
                                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                                   VerticalAlignment="Center" />
                                        <Button Grid.Column="1"
                                                Classes="secondary-button"
                                                Command="{Binding PreviewInBrowserCommand}">
                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                <PathIcon Data="{x:Static icons:Icons.OpenInNew}" Width="14" Height="14" />
                                                <TextBlock Text="{loc:Loc 'Open in Browser'}" />
                                            </StackPanel>
                                        </Button>
                                    </Grid>
                                </Border>

                                <!-- Preview container using InvoicePreviewControl -->
                                <!-- IsVisible bound to IsOpen so WebView is destroyed when modal closes -->
                                <controls:InvoicePreviewControl Grid.Row="1"
                                                                Grid.RowSpan="2"
                                                                Html="{Binding PreviewHtml}"
                                                                OpenInBrowserCommand="{Binding PreviewInBrowserCommand}"
                                                                IsVisible="{Binding IsOpen}" />
                            </Grid>
                        </Grid>

                        <!-- Footer -->
                        <Border Grid.Row="2"
                                Padding="24,16"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="0,1,0,0">
                            <Grid ColumnDefinitions="Auto,Auto,*,Auto">
                                <!-- Fullscreen toggle -->
                                <Button Grid.Column="0"
                                        Classes="icon-button"
                                        ToolTip.Tip="{loc:Loc 'Toggle Fullscreen (F)'}"
                                        Command="{Binding ToggleFullscreenCommand}">
                                    <PathIcon Data="{Binding IsFullscreen, Converter={x:Static local:BoolConverters.ToFullscreenIcon}}"
                                              Width="16" Height="16" />
                                </Button>
                                <TextBlock Grid.Column="1"
                                           Text="{Binding ValidationMessage}"
                                           Foreground="{DynamicResource ErrorBrush}"
                                           FontSize="13"
                                           Margin="12,0,0,0"
                                           VerticalAlignment="Center"
                                           IsVisible="{Binding HasValidationMessage}" />
                                <StackPanel Grid.Column="3" Orientation="Horizontal" Spacing="12">
                                    <Button Classes="secondary-button"
                                            Content="{loc:Loc Cancel}"
                                            Command="{Binding CloseCommand}" />
                                    <Button Classes="primary-button"
                                            Content="{loc:Loc 'Save Template'}"
                                            Command="{Binding SaveCommand}" />
                                </StackPanel>
                            </Grid>
                        </Border>
                    </Grid>
                </Border>
            </controls:ModalOverlay.ModalContent>
        </controls:ModalOverlay>
    </Panel>
</UserControl>
