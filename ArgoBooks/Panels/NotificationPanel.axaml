<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ArgoBooks.ViewModels"
             xmlns:loc="using:ArgoBooks.Localization"
             xmlns:local="using:ArgoBooks"
             mc:Ignorable="d" d:DesignWidth="360" d:DesignHeight="500"
             x:Class="ArgoBooks.Panels.NotificationPanel"
             x:DataType="vm:NotificationPanelViewModel">

    <Design.DataContext>
        <vm:NotificationPanelViewModel />
    </Design.DataContext>

    <Panel IsVisible="{Binding IsOpen}">
        <!-- Transparent backdrop for click-away -->
        <Border Background="Transparent"
                PointerPressed="Backdrop_PointerPressed" />

        <!-- Notification Panel Container with animation -->
        <Border x:Name="NotificationBorder"
                Background="{DynamicResource SurfaceBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Width="360"
                MaxHeight="480"
                HorizontalAlignment="Right"
                VerticalAlignment="Top"
                Margin="0,60,20,0"
                BoxShadow="0 4 16 0 #30000000"
                Opacity="0"
                RenderTransformOrigin="1,0">
            <Border.RenderTransform>
                <TranslateTransform Y="-8" />
            </Border.RenderTransform>
            <Border.Transitions>
                <Transitions>
                    <DoubleTransition Property="Opacity" Duration="0:0:0.15" Easing="CubicEaseOut" />
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.15" Easing="CubicEaseOut" />
                </Transitions>
            </Border.Transitions>
            <Grid RowDefinitions="Auto,*,Auto">
                <!-- Header -->
                <Border Grid.Row="0"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="0,0,0,1"
                        Padding="16,12">
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBlock Grid.Column="0"
                                   Text="{loc:Loc Notifications}"
                                   FontSize="16"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                   VerticalAlignment="Center" />
                        <Button Grid.Column="1"
                                Classes="text-button"
                                Content="{loc:Loc 'Mark all read'}"
                                Command="{Binding MarkAllAsReadCommand}"
                                IsVisible="{Binding HasUnreadNotifications}" />
                    </Grid>
                </Border>

                <!-- Notification List -->
                <ScrollViewer Grid.Row="1"
                              VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled">
                    <Panel>
                        <!-- Empty State -->
                        <StackPanel IsVisible="{Binding !HasNotifications}"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    Margin="0,60">
                            <PathIcon Data="{x:Static local:Icons.Notification}"
                                      Width="48" Height="48"
                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                      HorizontalAlignment="Center"
                                      Margin="0,0,0,12" />
                            <TextBlock Text="{loc:Loc 'No notifications'}"
                                       FontSize="14"
                                       Foreground="{DynamicResource TextTertiaryBrush}"
                                       HorizontalAlignment="Center" />
                            <TextBlock Text="{loc:Loc 'You''re all caught up!'}"
                                       FontSize="12"
                                       Foreground="{DynamicResource TextTertiaryBrush}"
                                       HorizontalAlignment="Center"
                                       Margin="0,4,0,0" />
                        </StackPanel>

                        <!-- Notifications List -->
                        <ItemsControl ItemsSource="{Binding Notifications}"
                                      IsVisible="{Binding HasNotifications}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="vm:NotificationItem">
                                    <Button Classes="notification-item"
                                            Classes.unread="{Binding !IsRead}"
                                            Classes.last="{Binding IsLast}"
                                            Command="{Binding $parent[UserControl].((vm:NotificationPanelViewModel)DataContext).NotificationClickedCommand}"
                                            CommandParameter="{Binding}">
                                        <Grid ColumnDefinitions="Auto,*,Auto">
                                            <!-- Type Indicator -->
                                            <Border Grid.Column="0"
                                                    Width="36" Height="36"
                                                    CornerRadius="18"
                                                    Margin="0,0,12,0"
                                                    VerticalAlignment="Top">
                                                <Border.Styles>
                                                    <Style Selector="Border">
                                                        <Setter Property="Background" Value="{DynamicResource SurfaceAltBrush}" />
                                                    </Style>
                                                </Border.Styles>
                                                <Panel>
                                                    <!-- Info Icon -->
                                                    <PathIcon Data="{x:Static local:Icons.Info}"
                                                              Width="18" Height="18"
                                                              Foreground="{DynamicResource PrimaryBrush}"
                                                              IsVisible="{Binding Type, Converter={x:Static vm:NotificationTypeConverters.IsInfo}}" />
                                                    <!-- Success Icon -->
                                                    <PathIcon Data="{x:Static local:Icons.CircleCheck}"
                                                              Width="18" Height="18"
                                                              Foreground="{DynamicResource SuccessBrush}"
                                                              IsVisible="{Binding Type, Converter={x:Static vm:NotificationTypeConverters.IsSuccess}}" />
                                                    <!-- Warning Icon -->
                                                    <PathIcon Data="{x:Static local:Icons.LostDamaged}"
                                                              Width="18" Height="18"
                                                              Foreground="{DynamicResource WarningBrush}"
                                                              IsVisible="{Binding Type, Converter={x:Static vm:NotificationTypeConverters.IsWarning}}" />
                                                    <!-- Error Icon -->
                                                    <PathIcon Data="{x:Static local:Icons.Info}"
                                                              Width="18" Height="18"
                                                              Foreground="{DynamicResource DangerBrush}"
                                                              IsVisible="{Binding Type, Converter={x:Static vm:NotificationTypeConverters.IsError}}" />
                                                    <!-- System Icon -->
                                                    <PathIcon Data="{x:Static local:Icons.Settings}"
                                                              Width="18" Height="18"
                                                              Foreground="{DynamicResource TextSecondaryBrush}"
                                                              IsVisible="{Binding Type, Converter={x:Static vm:NotificationTypeConverters.IsSystem}}" />
                                                </Panel>
                                            </Border>

                                            <!-- Content -->
                                            <StackPanel Grid.Column="1" Spacing="2" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding Title}"
                                                           FontSize="13"
                                                           FontWeight="{Binding IsRead, Converter={x:Static vm:NotificationTypeConverters.ReadToFontWeight}}"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                                           TextTrimming="CharacterEllipsis" />
                                                <TextBlock Text="{Binding Message}"
                                                           FontSize="12"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"
                                                           TextTrimming="CharacterEllipsis"
                                                           TextWrapping="Wrap"
                                                           MaxLines="2" />
                                                <TextBlock Text="{Binding Timestamp, Converter={x:Static vm:NotificationTypeConverters.RelativeTime}}"
                                                           FontSize="11"
                                                           Foreground="{DynamicResource TextTertiaryBrush}"
                                                           Margin="0,2,0,0" />
                                            </StackPanel>

                                            <!-- Action Buttons -->
                                            <StackPanel Grid.Column="2"
                                                        Orientation="Horizontal"
                                                        Spacing="4"
                                                        VerticalAlignment="Top"
                                                        Margin="8,0,0,0">
                                                <!-- Mark as Read Button (only for unread) -->
                                                <Button Classes="icon-button-small"
                                                        Command="{Binding $parent[UserControl].((vm:NotificationPanelViewModel)DataContext).MarkAsReadCommand}"
                                                        CommandParameter="{Binding}"
                                                        ToolTip.Tip="{loc:Loc 'Mark as read'}"
                                                        IsVisible="{Binding !IsRead}">
                                                    <PathIcon Data="{x:Static local:Icons.Check}"
                                                              Width="14" Height="14" />
                                                </Button>
                                                <!-- Dismiss Button -->
                                                <Button Classes="icon-button-small"
                                                        Command="{Binding $parent[UserControl].((vm:NotificationPanelViewModel)DataContext).RemoveNotificationCommand}"
                                                        CommandParameter="{Binding}"
                                                        ToolTip.Tip="{loc:Loc Dismiss}">
                                                    <PathIcon Data="{x:Static local:Icons.Close}"
                                                              Width="14" Height="14" />
                                                </Button>
                                            </StackPanel>
                                        </Grid>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Panel>
                </ScrollViewer>

                <!-- Footer -->
                <Border Grid.Row="2"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="0,1,0,0"
                        Padding="12,8">
                    <Grid ColumnDefinitions="*,Auto">
                        <Button Grid.Column="0"
                                Classes="text-button"
                                Content="{loc:Loc 'Clear all'}"
                                Command="{Binding ClearAllCommand}"
                                IsVisible="{Binding HasNotifications}"
                                HorizontalAlignment="Left" />
                        <Button Grid.Column="1"
                                Classes="text-button"
                                Command="{Binding OpenSettingsCommand}"
                                HorizontalAlignment="Right">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <PathIcon Data="{x:Static local:Icons.Settings}"
                                          Width="14" Height="14" />
                                <TextBlock Text="{loc:Loc Settings}" />
                            </StackPanel>
                        </Button>
                    </Grid>
                </Border>
            </Grid>
        </Border>
    </Panel>

    <UserControl.Styles>
        <!-- Notification Item Style -->
        <Style Selector="Button.notification-item">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Padding" Value="16,12" />
            <Setter Property="HorizontalAlignment" Value="Stretch" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="CornerRadius" Value="0" />
        </Style>
        <Style Selector="Button.notification-item /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0,0,0,1" />
            <Setter Property="BorderBrush" Value="{DynamicResource BorderLightBrush}" />
        </Style>
        <Style Selector="Button.notification-item.last /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="BorderThickness" Value="0" />
        </Style>
        <Style Selector="Button.notification-item:pointerover /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SurfaceHoverBrush}" />
        </Style>

        <!-- Unread Notification Style (subtle blue tint) -->
        <Style Selector="Button.notification-item.unread /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource PrimaryIconBgBrush}" />
        </Style>
        <Style Selector="Button.notification-item.unread:pointerover /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SurfacePressedBrush}" />
        </Style>

        <!-- Small Icon Button Style -->
        <Style Selector="Button.icon-button-small">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Width" Value="24" />
            <Setter Property="Height" Value="24" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Foreground" Value="{DynamicResource TextTertiaryBrush}" />
            <Setter Property="Opacity" Value="0" />
        </Style>
        <Style Selector="Button.icon-button-small /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="Transparent" />
        </Style>
        <Style Selector="Button.notification-item:pointerover Button.icon-button-small">
            <Setter Property="Opacity" Value="1" />
        </Style>
        <Style Selector="Button.icon-button-small:pointerover">
            <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}" />
        </Style>
        <Style Selector="Button.icon-button-small:pointerover /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SurfaceHoverBrush}" />
        </Style>
    </UserControl.Styles>
</UserControl>
