<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ArgoBooks.ViewModels"
             xmlns:controls="using:ArgoBooks.Controls"
             xmlns:loc="using:ArgoBooks.Localization"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="ArgoBooks.Views.InsightsPage"
             x:DataType="vm:InsightsPageViewModel">

    <Design.DataContext>
        <vm:InsightsPageViewModel />
    </Design.DataContext>

    <Panel>
    <!-- Main Content -->
    <ScrollViewer VerticalScrollBarVisibility="Auto"
                  HorizontalScrollBarVisibility="Disabled">
        <Grid RowDefinitions="Auto,Auto,Auto,*" Margin="24">
            <!-- Statistics Cards Row -->
            <controls:StatCardsRow Grid.Row="0" Margin="0,0,0,24">
                <controls:StatCard Label="{loc:Loc 'AI Insights'}"
                                   Value="{Binding TotalInsights}"
                                   Icon="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6C7.8 12.16 7 10.63 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"
                                   IconColor="Info" />
                <controls:StatCard Label="{loc:Loc 'Trends Detected'}"
                                   Value="{Binding TrendsDetected}"
                                   Icon="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"
                                   IconColor="Success" />
                <controls:StatCard Label="{loc:Loc Anomalies}"
                                   Value="{Binding AnomaliesDetected}"
                                   Icon="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"
                                   IconColor="Warning" />
                <controls:StatCard Label="{loc:Loc Opportunities}"
                                   Value="{Binding Opportunities}"
                                   Icon="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"
                                   IconColor="Primary" />
            </controls:StatCardsRow>

            <!-- Page Header (Row 1) -->
            <Border Grid.Row="1"
                    Background="{DynamicResource SurfaceBrush}"
                    CornerRadius="12"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1"
                    Padding="24,20"
                    Margin="0,0,0,24">
                <Grid ColumnDefinitions="Auto,*,Auto">
                    <!-- AI Icon and Title -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="16" VerticalAlignment="Center">
                        <Border Width="48" Height="48"
                                CornerRadius="10"
                                Background="{DynamicResource PrimaryLightBrush}">
                            <PathIcon Data="M21 10.12h-6.78l2.74-2.82c-2.73-2.7-7.15-2.8-9.88-.1-2.73 2.71-2.73 7.08 0 9.79s7.15 2.71 9.88 0C18.32 15.65 19 14.08 19 12.1h2c0 1.98-.88 4.55-2.64 6.29-3.51 3.48-9.21 3.48-12.72 0-3.5-3.47-3.53-9.11-.02-12.58s9.14-3.47 12.65 0L21 3v7.12zM12.5 8v4.25l3.5 2.08-.72 1.21L11 13V8h1.5z"
                                      Width="24" Height="24"
                                      Foreground="{DynamicResource PrimaryBrush}" />
                        </Border>
                        <StackPanel>
                            <TextBlock Text="{loc:Loc 'AI Business Insights'}"
                                       FontSize="20"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextPrimaryBrush}" />
                            <TextBlock Text="{loc:Loc 'Intelligent analysis of your business data'}"
                                       FontSize="13"
                                       Foreground="{DynamicResource TextSecondaryBrush}" />
                        </StackPanel>
                    </StackPanel>

                    <!-- Last Updated -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                        <TextBlock Text="{loc:Loc 'Last updated:'}"
                                   FontSize="13"
                                   Foreground="{DynamicResource TextTertiaryBrush}"
                                   VerticalAlignment="Center" />
                        <TextBlock Text="{Binding LastUpdated}"
                                   FontSize="13"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   VerticalAlignment="Center" />
                        <Button Classes="secondary-button"
                                Margin="16,0,0,0"
                                Command="{Binding RefreshInsightsCommand}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <PathIcon Classes.sync-spinning="{Binding IsRefreshing}"
                                          Data="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"
                                          Width="16" Height="16"
                                          RenderTransformOrigin="50%,50%">
                                    <PathIcon.RenderTransform>
                                        <RotateTransform />
                                    </PathIcon.RenderTransform>
                                </PathIcon>
                                <TextBlock Text="{loc:Loc Refresh}" />
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Forecasted Growth Section (Row 2) -->
            <Border Grid.Row="2"
                    Background="{DynamicResource SurfaceBrush}"
                    CornerRadius="12"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1"
                    Padding="24"
                    Margin="0,0,0,24">
                <StackPanel Spacing="20">
                    <!-- Section Header -->
                    <Grid ColumnDefinitions="Auto,*,Auto">
                        <Border Grid.Column="0"
                                Width="32" Height="32"
                                CornerRadius="8"
                                Background="#DBEAFE"
                                Margin="0,0,12,0">
                            <PathIcon Data="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"
                                      Width="16" Height="16"
                                      Foreground="#3B82F6" />
                        </Border>
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="{loc:Loc 'Forecasted Growth'}"
                                           FontSize="16"
                                           FontWeight="SemiBold"
                                           Foreground="{DynamicResource TextPrimaryBrush}" />
                                <!-- Info Button -->
                                <Button Classes="icon-button"
                                        Width="20" Height="20"
                                        Padding="0"
                                        VerticalAlignment="Center"
                                        Command="{Binding ShowPredictionInfoCommand}"
                                        ToolTip.Tip="How predictions are calculated">
                                    <PathIcon Data="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"
                                              Width="14" Height="14"
                                              Foreground="{DynamicResource TextTertiaryBrush}" />
                                </Button>
                            </StackPanel>
                            <TextBlock Text="{Binding ForecastDateRangeLabel}"
                                       FontSize="14"
                                       FontWeight="Medium"
                                       Foreground="{DynamicResource TextSecondaryBrush}" />
                        </StackPanel>
                        <!-- Date Range Selector -->
                        <controls:DateRangeSelector Grid.Column="2" VerticalAlignment="Top" />
                    </Grid>

                    <!-- Forecast Cards Row (visible when data is available) -->
                    <controls:StatCardsRow IsVisible="{Binding !HasInsufficientData}">
                        <controls:StatCard Label="{Binding RevenueLabel}"
                                           Value="{Binding ForecastedRevenue}"
                                           ChangeValue="{Binding RevenueGrowthValue}"
                                           ChangeText="{Binding RevenueGrowth}"
                                           ChangeLabel="{Binding ComparisonLabel}"
                                           UseAltBackground="True" />
                        <controls:StatCard Label="{Binding ExpensesLabel}"
                                           Value="{Binding ForecastedExpenses}"
                                           ChangeValue="{Binding ExpenseGrowthValue}"
                                           ChangeText="{Binding ExpenseGrowth}"
                                           ChangeLabel="{Binding ComparisonLabel}"
                                           UseAltBackground="True" />
                        <controls:StatCard Label="{Binding ProfitLabel}"
                                           Value="{Binding ForecastedProfit}"
                                           ChangeValue="{Binding ProfitGrowthValue}"
                                           ChangeText="{Binding ProfitGrowth}"
                                           ChangeLabel="{Binding ComparisonLabel}"
                                           ValueColor="Success"
                                           UseAltBackground="True" />
                        <controls:StatCard Label="{Binding CustomersLabel}"
                                           Value="{Binding ForecastedCustomers}"
                                           ChangeValue="{Binding CustomerGrowthValue}"
                                           ChangeText="{Binding CustomerGrowth}"
                                           ChangeLabel="{Binding ComparisonLabel}"
                                           UseAltBackground="True" />
                    </controls:StatCardsRow>

                    <!-- Insufficient Data Message (visible when no data) -->
                    <Border IsVisible="{Binding HasInsufficientData}"
                            Background="{DynamicResource SurfaceAltBrush}"
                            CornerRadius="8"
                            Padding="32">
                        <StackPanel HorizontalAlignment="Center" Spacing="12">
                            <Border Width="56" Height="56"
                                    CornerRadius="28"
                                    Background="{DynamicResource BackgroundBrush}"
                                    HorizontalAlignment="Center">
                                <PathIcon Data="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"
                                          Width="28" Height="28"
                                          Foreground="{DynamicResource TextTertiaryBrush}" />
                            </Border>
                            <TextBlock Text="Insufficient Data"
                                       FontSize="16"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                       HorizontalAlignment="Center" />
                            <TextBlock Text="{Binding InsufficientDataMessage}"
                                       FontSize="13"
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       HorizontalAlignment="Center"
                                       TextAlignment="Center"
                                       MaxWidth="400"
                                       TextWrapping="Wrap" />
                            <Button Classes="secondary-button"
                                    Margin="0,4,0,0"
                                    Command="{Binding RefreshInsightsCommand}"
                                    HorizontalAlignment="Center">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <PathIcon Data="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"
                                              Width="14" Height="14" />
                                    <TextBlock Text="Try Again" />
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </Border>

                    <!-- Confidence Indicator (visible when data is available) -->
                    <Border IsVisible="{Binding !HasInsufficientData}"
                            Background="{DynamicResource SurfaceAltBrush}"
                            CornerRadius="8"
                            Padding="16">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                <PathIcon Data="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
                                          Width="16" Height="16"
                                          Foreground="#22C55E" />
                                <TextBlock Text="{loc:Loc 'Prediction Confidence:'}"
                                           FontSize="13"
                                           Foreground="{DynamicResource TextSecondaryBrush}"
                                           VerticalAlignment="Center" />
                                <TextBlock Text="{Binding PredictionConfidence}"
                                           FontSize="13"
                                           FontWeight="SemiBold"
                                           Foreground="#22C55E"
                                           VerticalAlignment="Center" />
                            </StackPanel>
                            <TextBlock Grid.Column="2"
                                       Text="{Binding DataMonthsNote}"
                                       FontSize="12"
                                       Foreground="{DynamicResource TextTertiaryBrush}"
                                       VerticalAlignment="Center" />
                        </Grid>
                    </Border>
                </StackPanel>
            </Border>

            <!-- Insights Content (Row 3) - hidden when insufficient data -->
            <Grid Grid.Row="3" RowDefinitions="Auto,*" IsVisible="{Binding !HasInsufficientData}">
                <!-- Insights Period Header -->
                <Border Grid.Row="0"
                        Background="{DynamicResource SurfaceAltBrush}"
                        CornerRadius="8"
                        Padding="16"
                        Margin="0,0,0,16">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <PathIcon Data="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"
                                  Width="16" Height="16"
                                  Foreground="{DynamicResource TextTertiaryBrush}" />
                        <TextBlock Text="{loc:Loc 'Business Insights'}"
                                   FontSize="14"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                   VerticalAlignment="Center" />
                        <TextBlock Text="•"
                                   FontSize="14"
                                   Foreground="{DynamicResource TextTertiaryBrush}"
                                   VerticalAlignment="Center" />
                        <TextBlock Text="{Binding InsightsAnalysisPeriod}"
                                   FontSize="13"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   VerticalAlignment="Center" />
                    </StackPanel>
                </Border>

                <!-- Insights Grid -->
                <Grid Grid.Row="1" ColumnDefinitions="*,*">
                <!-- Left Column -->
                <StackPanel Grid.Column="0" Spacing="16" Margin="0,0,12,0">
                    <!-- Revenue Trends Section -->
                    <Border Background="{DynamicResource SurfaceBrush}"
                            CornerRadius="12"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1">
                        <StackPanel>
                            <Border Padding="20"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="0,0,0,1">
                                <Grid ColumnDefinitions="Auto,*">
                                    <Border Grid.Column="0"
                                            Width="32" Height="32"
                                            CornerRadius="8"
                                            Background="#DCFCE7"
                                            Margin="0,0,12,0">
                                        <PathIcon Data="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"
                                                  Width="16" Height="16"
                                                  Foreground="#22C55E" />
                                    </Border>
                                    <TextBlock Grid.Column="1"
                                               Text="{loc:Loc 'Revenue Trends'}"
                                               FontSize="16"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                               VerticalAlignment="Center" />
                                </Grid>
                            </Border>
                            <ItemsControl ItemsSource="{Binding RevenueTrends}" Margin="0">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="vm:InsightItemViewModel">
                                        <Border Padding="20"
                                                BorderBrush="{DynamicResource BorderBrush}"
                                                BorderThickness="0,0,0,1"
                                                Classes.last-item="{Binding IsLastItem}">
                                            <Border.Styles>
                                                <Style Selector="Border.last-item">
                                                    <Setter Property="BorderThickness" Value="0" />
                                                </Style>
                                            </Border.Styles>
                                            <Grid ColumnDefinitions="Auto,*">
                                                <Border Grid.Column="0"
                                                        Width="8" Height="8"
                                                        CornerRadius="4"
                                                        Background="{Binding StatusColor}"
                                                        Margin="0,6,12,0"
                                                        VerticalAlignment="Top" />
                                                <StackPanel Grid.Column="1" Spacing="4">
                                                    <TextBlock Text="{Binding Title}"
                                                               FontSize="14"
                                                               FontWeight="Medium"
                                                               Foreground="{DynamicResource TextPrimaryBrush}" />
                                                    <TextBlock Text="{Binding Description}"
                                                               FontSize="13"
                                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                                               TextWrapping="Wrap" />
                                                    <TextBlock Text="{Binding Recommendation}"
                                                               FontSize="12"
                                                               Foreground="{DynamicResource PrimaryBrush}"
                                                               Margin="0,4,0,0"
                                                               IsVisible="{Binding HasRecommendation}" />
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>

                    <!-- Forecasting Section -->
                    <Border Background="{DynamicResource SurfaceBrush}"
                            CornerRadius="12"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1">
                        <StackPanel>
                            <Border Padding="20"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="0,0,0,1">
                                <Grid ColumnDefinitions="Auto,*">
                                    <Border Grid.Column="0"
                                            Width="32" Height="32"
                                            CornerRadius="8"
                                            Background="#EDE9FE"
                                            Margin="0,0,12,0">
                                        <PathIcon Data="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"
                                                  Width="16" Height="16"
                                                  Foreground="#8B5CF6" />
                                    </Border>
                                    <TextBlock Grid.Column="1"
                                               Text="{loc:Loc Forecasting}"
                                               FontSize="16"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                               VerticalAlignment="Center" />
                                </Grid>
                            </Border>
                            <ItemsControl ItemsSource="{Binding Forecasts}" Margin="0">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="vm:InsightItemViewModel">
                                        <Border Padding="20"
                                                BorderBrush="{DynamicResource BorderBrush}"
                                                BorderThickness="0,0,0,1"
                                                Classes.last-item="{Binding IsLastItem}">
                                            <Border.Styles>
                                                <Style Selector="Border.last-item">
                                                    <Setter Property="BorderThickness" Value="0" />
                                                </Style>
                                            </Border.Styles>
                                            <Grid ColumnDefinitions="Auto,*">
                                                <Border Grid.Column="0"
                                                        Width="8" Height="8"
                                                        CornerRadius="4"
                                                        Background="{Binding StatusColor}"
                                                        Margin="0,6,12,0"
                                                        VerticalAlignment="Top" />
                                                <StackPanel Grid.Column="1" Spacing="4">
                                                    <TextBlock Text="{Binding Title}"
                                                               FontSize="14"
                                                               FontWeight="Medium"
                                                               Foreground="{DynamicResource TextPrimaryBrush}" />
                                                    <TextBlock Text="{Binding Description}"
                                                               FontSize="13"
                                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                                               TextWrapping="Wrap" />
                                                    <TextBlock Text="{Binding Recommendation}"
                                                               FontSize="12"
                                                               Foreground="{DynamicResource PrimaryBrush}"
                                                               Margin="0,4,0,0"
                                                               IsVisible="{Binding HasRecommendation}" />
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- Right Column -->
                <StackPanel Grid.Column="1" Spacing="16" Margin="12,0,0,0">
                    <!-- Anomalies Section -->
                    <Border Background="{DynamicResource SurfaceBrush}"
                            CornerRadius="12"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1">
                        <StackPanel>
                            <Border Padding="20"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="0,0,0,1">
                                <Grid ColumnDefinitions="Auto,*">
                                    <Border Grid.Column="0"
                                            Width="32" Height="32"
                                            CornerRadius="8"
                                            Background="#FEF3C7"
                                            Margin="0,0,12,0">
                                        <PathIcon Data="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"
                                                  Width="16" Height="16"
                                                  Foreground="#F59E0B" />
                                    </Border>
                                    <TextBlock Grid.Column="1"
                                               Text="{loc:Loc 'Anomaly Detection'}"
                                               FontSize="16"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                               VerticalAlignment="Center" />
                                </Grid>
                            </Border>
                            <ItemsControl ItemsSource="{Binding Anomalies}" Margin="0">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="vm:InsightItemViewModel">
                                        <Border Padding="20"
                                                BorderBrush="{DynamicResource BorderBrush}"
                                                BorderThickness="0,0,0,1"
                                                Classes.last-item="{Binding IsLastItem}">
                                            <Border.Styles>
                                                <Style Selector="Border.last-item">
                                                    <Setter Property="BorderThickness" Value="0" />
                                                </Style>
                                            </Border.Styles>
                                            <Grid ColumnDefinitions="Auto,*">
                                                <Border Grid.Column="0"
                                                        Width="8" Height="8"
                                                        CornerRadius="4"
                                                        Background="{Binding StatusColor}"
                                                        Margin="0,6,12,0"
                                                        VerticalAlignment="Top" />
                                                <StackPanel Grid.Column="1" Spacing="4">
                                                    <TextBlock Text="{Binding Title}"
                                                               FontSize="14"
                                                               FontWeight="Medium"
                                                               Foreground="{DynamicResource TextPrimaryBrush}" />
                                                    <TextBlock Text="{Binding Description}"
                                                               FontSize="13"
                                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                                               TextWrapping="Wrap" />
                                                    <TextBlock Text="{Binding Recommendation}"
                                                               FontSize="12"
                                                               Foreground="{DynamicResource PrimaryBrush}"
                                                               Margin="0,4,0,0"
                                                               IsVisible="{Binding HasRecommendation}" />
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>

                    <!-- Recommendations Section -->
                    <Border Background="{DynamicResource SurfaceBrush}"
                            CornerRadius="12"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1">
                        <StackPanel>
                            <Border Padding="20"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="0,0,0,1">
                                <Grid ColumnDefinitions="Auto,*">
                                    <Border Grid.Column="0"
                                            Width="32" Height="32"
                                            CornerRadius="8"
                                            Background="#DBEAFE"
                                            Margin="0,0,12,0">
                                        <PathIcon Data="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"
                                                  Width="16" Height="16"
                                                  Foreground="#3B82F6" />
                                    </Border>
                                    <TextBlock Grid.Column="1"
                                               Text="{loc:Loc Recommendations}"
                                               FontSize="16"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                               VerticalAlignment="Center" />
                                </Grid>
                            </Border>
                            <ItemsControl ItemsSource="{Binding Recommendations}" Margin="0">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="vm:InsightItemViewModel">
                                        <Border Padding="20"
                                                BorderBrush="{DynamicResource BorderBrush}"
                                                BorderThickness="0,0,0,1"
                                                Classes.last-item="{Binding IsLastItem}">
                                            <Border.Styles>
                                                <Style Selector="Border.last-item">
                                                    <Setter Property="BorderThickness" Value="0" />
                                                </Style>
                                            </Border.Styles>
                                            <Grid ColumnDefinitions="Auto,*">
                                                <Border Grid.Column="0"
                                                        Width="8" Height="8"
                                                        CornerRadius="4"
                                                        Background="{Binding StatusColor}"
                                                        Margin="0,6,12,0"
                                                        VerticalAlignment="Top" />
                                                <StackPanel Grid.Column="1" Spacing="4">
                                                    <TextBlock Text="{Binding Title}"
                                                               FontSize="14"
                                                               FontWeight="Medium"
                                                               Foreground="{DynamicResource TextPrimaryBrush}" />
                                                    <TextBlock Text="{Binding Description}"
                                                               FontSize="13"
                                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                                               TextWrapping="Wrap" />
                                                    <TextBlock Text="{Binding Recommendation}"
                                                               FontSize="12"
                                                               Foreground="{DynamicResource PrimaryBrush}"
                                                               Margin="0,4,0,0"
                                                               IsVisible="{Binding HasRecommendation}" />
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>
                </StackPanel>
                </Grid>
            </Grid>
        </Grid>
    </ScrollViewer>

    <!-- Prediction Info Modal Overlay -->
    <Border IsVisible="{Binding IsInfoModalVisible}"
            Background="#80000000"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Stretch">
        <Border Background="{DynamicResource SurfaceBrush}"
                CornerRadius="16"
                MaxWidth="600"
                MaxHeight="700"
                Margin="40"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                BoxShadow="0 8 32 0 #40000000">
            <Grid RowDefinitions="Auto,*,Auto">
                <!-- Modal Header -->
                <Border Grid.Row="0"
                        Padding="24,20"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="0,0,0,1">
                    <Grid ColumnDefinitions="*,Auto">
                        <StackPanel Grid.Column="0">
                            <TextBlock Text="How Predictions Work"
                                       FontSize="18"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextPrimaryBrush}" />
                            <TextBlock Text="Understanding the forecast methodology"
                                       FontSize="13"
                                       Foreground="{DynamicResource TextSecondaryBrush}" />
                        </StackPanel>
                        <Button Grid.Column="1"
                                Classes="icon-button"
                                Width="32" Height="32"
                                Command="{Binding CloseInfoModalCommand}">
                            <PathIcon Data="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                                      Width="16" Height="16"
                                      Foreground="{DynamicResource TextSecondaryBrush}" />
                        </Button>
                    </Grid>
                </Border>

                <!-- Modal Content -->
                <ScrollViewer Grid.Row="1"
                              Padding="24"
                              HorizontalScrollBarVisibility="Disabled">
                    <StackPanel Spacing="20">
                        <!-- Forecast Calculation -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Forecast Calculation"
                                       FontSize="14"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextPrimaryBrush}" />
                            <TextBlock TextWrapping="Wrap"
                                       FontSize="13"
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       Text="Forecasts are calculated using a weighted moving average of your historical monthly data:" />
                            <Border Background="{DynamicResource SurfaceAltBrush}"
                                    CornerRadius="8"
                                    Padding="16"
                                    Margin="0,8,0,0">
                                <StackPanel Spacing="8">
                                    <TextBlock Text="Avg = Sum(Values) / Months"
                                               FontFamily="Consolas,Monaco,monospace"
                                               FontSize="12"
                                               TextWrapping="Wrap"
                                               Foreground="{DynamicResource PrimaryBrush}" />
                                    <TextBlock Text="Forecast = Avg × Period"
                                               FontFamily="Consolas,Monaco,monospace"
                                               FontSize="12"
                                               TextWrapping="Wrap"
                                               Foreground="{DynamicResource PrimaryBrush}" />
                                </StackPanel>
                            </Border>
                            <TextBlock TextWrapping="Wrap"
                                       FontSize="12"
                                       Foreground="{DynamicResource TextTertiaryBrush}"
                                       Text="Period is calculated from actual days (days ÷ 30.44)." />
                        </StackPanel>

                        <!-- Confidence Score -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Confidence Score (0-100%)"
                                       FontSize="14"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextPrimaryBrush}" />
                            <TextBlock TextWrapping="Wrap"
                                       FontSize="13"
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       Text="The confidence score indicates data quality, not forecast accuracy. It's calculated from three components:" />

                            <!-- Data Quantity -->
                            <Border Background="{DynamicResource SurfaceAltBrush}"
                                    CornerRadius="8"
                                    Padding="16"
                                    Margin="0,8,0,0">
                                <StackPanel Spacing="4">
                                    <TextBlock Text="1. Data Quantity (0-40 pts)"
                                               FontSize="13"
                                               FontWeight="Medium"
                                               Foreground="{DynamicResource TextPrimaryBrush}" />
                                    <TextBlock Text="min(40, totalMonths × 3)"
                                               FontFamily="Consolas,Monaco,monospace"
                                               FontSize="11"
                                               TextWrapping="Wrap"
                                               Foreground="{DynamicResource PrimaryBrush}" />
                                    <TextBlock Text="More historical data = higher score"
                                               FontSize="12"
                                               TextWrapping="Wrap"
                                               Foreground="{DynamicResource TextTertiaryBrush}" />
                                </StackPanel>
                            </Border>

                            <!-- Stability Score -->
                            <Border Background="{DynamicResource SurfaceAltBrush}"
                                    CornerRadius="8"
                                    Padding="16">
                                <StackPanel Spacing="4">
                                    <TextBlock Text="2. Stability (10-40 pts)"
                                               FontSize="13"
                                               FontWeight="Medium"
                                               Foreground="{DynamicResource TextPrimaryBrush}" />
                                    <TextBlock Text="CV = StdDev / Mean"
                                               FontFamily="Consolas,Monaco,monospace"
                                               FontSize="11"
                                               TextWrapping="Wrap"
                                               Foreground="{DynamicResource PrimaryBrush}" />
                                    <TextBlock TextWrapping="Wrap"
                                               FontSize="12"
                                               Foreground="{DynamicResource TextTertiaryBrush}"
                                               Text="CV&lt;0.1=40 | CV&lt;0.3=30 | CV&lt;0.5=20 | else=10" />
                                </StackPanel>
                            </Border>

                            <!-- Recency Bonus -->
                            <Border Background="{DynamicResource SurfaceAltBrush}"
                                    CornerRadius="8"
                                    Padding="16">
                                <StackPanel Spacing="4">
                                    <TextBlock Text="3. Recency Bonus (0-20 pts)"
                                               FontSize="13"
                                               FontWeight="Medium"
                                               Foreground="{DynamicResource TextPrimaryBrush}" />
                                    <TextBlock TextWrapping="Wrap"
                                               FontSize="12"
                                               Foreground="{DynamicResource TextTertiaryBrush}"
                                               Text="3+ months=20 | 1-2 months=10 | 0=0" />
                                </StackPanel>
                            </Border>

                            <!-- Final Formula -->
                            <Border Background="{DynamicResource PrimaryLightBrush}"
                                    CornerRadius="8"
                                    Padding="16">
                                <StackPanel Spacing="4">
                                    <TextBlock Text="Final Score"
                                               FontSize="13"
                                               FontWeight="Medium"
                                               Foreground="{DynamicResource TextPrimaryBrush}" />
                                    <TextBlock Text="min(100, data + stability + recency)"
                                               FontFamily="Consolas,Monaco,monospace"
                                               FontSize="11"
                                               TextWrapping="Wrap"
                                               Foreground="{DynamicResource PrimaryBrush}" />
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <!-- Confidence Levels -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Confidence Levels"
                                       FontSize="14"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextPrimaryBrush}" />
                            <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,4,0,0">
                                <Border Background="#DCFCE7" CornerRadius="6" Padding="12,8">
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <TextBlock Text="High" FontWeight="SemiBold" Foreground="#22C55E" />
                                        <TextBlock Text="≥80%" FontSize="12" Foreground="#22C55E" Opacity="0.8" />
                                    </StackPanel>
                                </Border>
                                <Border Background="#FEF3C7" CornerRadius="6" Padding="12,8">
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <TextBlock Text="Medium" FontWeight="SemiBold" Foreground="#F59E0B" />
                                        <TextBlock Text="50-79%" FontSize="12" Foreground="#F59E0B" Opacity="0.8" />
                                    </StackPanel>
                                </Border>
                                <Border Background="#FEE2E2" CornerRadius="6" Padding="12,8">
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <TextBlock Text="Low" FontWeight="SemiBold" Foreground="#EF4444" />
                                        <TextBlock Text="&lt;50%" FontSize="12" Foreground="#EF4444" Opacity="0.8" />
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </StackPanel>

                        <!-- Important Note -->
                        <Border Background="{DynamicResource SurfaceAltBrush}"
                                CornerRadius="8"
                                Padding="16">
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <PathIcon Data="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"
                                          Width="20" Height="20"
                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                          VerticalAlignment="Top"
                                          Margin="0,2,0,0" />
                                <TextBlock TextWrapping="Wrap"
                                           FontSize="12"
                                           Foreground="{DynamicResource TextSecondaryBrush}"
                                           Text="Note: Confidence measures data quality, not prediction accuracy. A 'High' confidence means you have stable, plentiful data—the forecast may still differ from actual results due to unforeseen factors." />
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>

                <!-- Modal Footer -->
                <Border Grid.Row="2"
                        Padding="24,16"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="0,1,0,0">
                    <Button Classes="primary-button"
                            HorizontalAlignment="Right"
                            Command="{Binding CloseInfoModalCommand}">
                        <TextBlock Text="Got it" />
                    </Button>
                </Border>
            </Grid>
        </Border>
    </Border>
    </Panel>
</UserControl>
