<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ArgoBooks.ViewModels"
             xmlns:controls="using:ArgoBooks.Controls"
             xmlns:loc="using:ArgoBooks.Localization"
             mc:Ignorable="d" d:DesignWidth="550" d:DesignHeight="400"
             x:Class="ArgoBooks.Modals.PasswordPromptModal"
             x:DataType="vm:PasswordPromptModalViewModel">

    <Design.DataContext>
        <vm:PasswordPromptModalViewModel />
    </Design.DataContext>

    <!-- Modal Overlay -->
    <controls:ModalOverlay IsOpen="{Binding IsOpen}">
        <!-- Modal Content -->
        <Border Background="{DynamicResource SurfaceBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="1"
                CornerRadius="12"
                Width="420"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Padding="32"
                BoxShadow="0 8 32 0 #40000000">

            <Panel>
                <!-- Normal Password Entry View -->
                <StackPanel Spacing="24" IsVisible="{Binding !ShowWindowsHelloSuccess}">
                    <!-- Header -->
                    <StackPanel Spacing="8"
                                HorizontalAlignment="Center">
                        <!-- Lock Icon -->
                        <Border Width="56" Height="56"
                                CornerRadius="28"
                                Background="{DynamicResource PrimaryLightBrush}"
                                HorizontalAlignment="Center">
                            <PathIcon Data="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"
                                      Width="28" Height="28"
                                      Foreground="{DynamicResource PrimaryBrush}" />
                        </Border>

                        <TextBlock Text="{loc:Loc 'Password Required'}"
                                   FontSize="20"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                   HorizontalAlignment="Center" />

                        <TextBlock Text="{Binding CompanyName, StringFormat='Enter password for {0}'}"
                                   FontSize="14"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   HorizontalAlignment="Center"
                                   TextWrapping="Wrap"
                                   TextAlignment="Center" />
                    </StackPanel>

                    <!-- Windows Hello Button (shown when available) -->
                    <Button Classes="windows-hello-button"
                            Command="{Binding UseWindowsHelloCommand}"
                            IsVisible="{Binding WindowsHelloAvailable}"
                            IsEnabled="{Binding !IsWindowsHelloAuthenticating}"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Center">
                        <StackPanel Orientation="Horizontal" Spacing="12" HorizontalAlignment="Center">
                            <!-- Windows Hello / Fingerprint Icon -->
                            <PathIcon Data="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28zM3.5 9.72a.499.499 0 0 1-.41-.79c.99-1.4 2.25-2.5 3.75-3.27C9.98 4.04 14 4.03 17.15 5.65c1.5.77 2.76 1.86 3.75 3.25a.5.5 0 0 1-.12.7.5.5 0 0 1-.7-.12 9.388 9.388 0 0 0-3.39-2.94c-2.87-1.47-6.54-1.47-9.4.01-1.36.7-2.5 1.7-3.4 2.96-.08.14-.23.21-.39.21zm6.25 12.07a.47.47 0 0 1-.35-.15c-.87-.87-1.34-1.43-2.01-2.64-.69-1.23-1.05-2.73-1.05-4.34 0-2.97 2.54-5.39 5.66-5.39s5.66 2.42 5.66 5.39c0 .28-.22.5-.5.5s-.5-.22-.5-.5c0-2.42-2.09-4.39-4.66-4.39-2.57 0-4.66 1.97-4.66 4.39 0 1.44.32 2.77.93 3.85.64 1.15 1.08 1.64 1.85 2.42.19.2.19.51 0 .71-.11.1-.24.15-.37.15zm7.17-1.85c-1.19 0-2.24-.3-3.1-.89-1.49-1.01-2.38-2.65-2.38-4.39 0-.28.22-.5.5-.5s.5.22.5.5c0 1.41.72 2.74 1.94 3.56.71.48 1.54.71 2.54.71.24 0 .64-.03 1.04-.1.27-.05.53.13.58.41.05.27-.13.53-.41.58-.57.11-1.07.12-1.21.12zM14.91 22c-.04 0-.09-.01-.13-.02-1.59-.44-2.63-1.03-3.72-2.1a7.297 7.297 0 0 1-2.17-5.22c0-1.62 1.38-2.94 3.08-2.94 1.7 0 3.08 1.32 3.08 2.94 0 1.07.93 1.94 2.08 1.94s2.08-.87 2.08-1.94c0-3.77-3.25-6.83-7.25-6.83-2.84 0-5.44 1.58-6.61 4.03-.39.81-.59 1.76-.59 2.8 0 .78.07 2.01.67 3.61.1.26-.03.55-.29.64-.26.1-.55-.04-.64-.29a11.14 11.14 0 0 1-.73-3.96c0-1.2.23-2.29.68-3.24 1.33-2.79 4.28-4.6 7.51-4.6 4.55 0 8.25 3.51 8.25 7.83 0 1.62-1.38 2.94-3.08 2.94s-3.08-1.32-3.08-2.94c0-1.07-.93-1.94-2.08-1.94s-2.08.87-2.08 1.94c0 1.71.66 3.31 1.87 4.51.95.94 1.86 1.46 3.27 1.85.27.07.42.35.35.61-.05.23-.26.38-.47.38z"
                                      Width="24" Height="24"
                                      IsVisible="{Binding !IsWindowsHelloAuthenticating}" />
                            <!-- Loading spinner when authenticating -->
                            <controls:LoadingSpinner SizePreset="Small"
                                                     IsVisible="{Binding IsWindowsHelloAuthenticating}" />
                            <TextBlock Text="{loc:Loc 'Use Windows Hello'}"
                                       IsVisible="{Binding !IsWindowsHelloAuthenticating}"
                                       VerticalAlignment="Center" />
                            <TextBlock Text="{loc:Loc 'Authenticating...'}"
                                       IsVisible="{Binding IsWindowsHelloAuthenticating}"
                                       VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>

                    <!-- Divider with "or" (shown when Windows Hello is available) -->
                    <Grid ColumnDefinitions="*,Auto,*"
                          IsVisible="{Binding WindowsHelloAvailable}"
                          Margin="0,-8,0,-8">
                        <Border Grid.Column="0"
                                Height="1"
                                Background="{DynamicResource BorderBrush}"
                                VerticalAlignment="Center"
                                Margin="0,0,16,0" />
                        <TextBlock Grid.Column="1"
                                   Text="{loc:Loc 'or enter password'}"
                                   FontSize="12"
                                   Foreground="{DynamicResource TextTertiaryBrush}"
                                   VerticalAlignment="Center" />
                        <Border Grid.Column="2"
                                Height="1"
                                Background="{DynamicResource BorderBrush}"
                                VerticalAlignment="Center"
                                Margin="16,0,0,0" />
                    </Grid>

                    <!-- Password Input -->
                    <StackPanel Spacing="8">
                        <Border Background="{DynamicResource SurfaceBrush}"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="1"
                                CornerRadius="8"
                                Padding="0">
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBox Grid.Column="0"
                                         x:Name="PasswordTextBox"
                                         Text="{Binding Password, Mode=TwoWay}"
                                         Watermark="{loc:Loc 'Enter password'}"
                                         RevealPassword="{Binding IsPasswordVisible}"
                                         Classes="password-input"
                                         IsEnabled="{Binding !IsLoading}"
                                         KeyDown="PasswordTextBox_KeyDown" />
                                <Button Grid.Column="1"
                                        Classes="eye-button"
                                        Command="{Binding TogglePasswordVisibilityCommand}"
                                        ToolTip.Tip="{loc:Loc 'Toggle password visibility'}">
                                    <PathIcon Data="{Binding PasswordVisibilityIcon}"
                                              Width="18" Height="18" />
                                </Button>
                            </Grid>
                        </Border>

                        <!-- Error Message -->
                        <TextBlock Text="{Binding ErrorMessage}"
                                   FontSize="13"
                                   Foreground="{DynamicResource ErrorBrush}"
                                   IsVisible="{Binding HasError}"
                                   TextWrapping="Wrap" />
                    </StackPanel>

                    <!-- Buttons -->
                    <Grid ColumnDefinitions="*,*"
                          Margin="0,8,0,0">
                        <Button Grid.Column="0"
                                Content="{loc:Loc Cancel}"
                                Classes="secondary"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Center"
                                Margin="0,0,8,0"
                                Command="{Binding CancelCommand}"
                                IsEnabled="{Binding !IsLoading}" />
                        <Button Grid.Column="1"
                                Classes="primary"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Center"
                                Margin="8,0,0,0"
                                Command="{Binding SubmitCommand}"
                                IsEnabled="{Binding !IsLoading}">
                            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                                <!-- Loading spinner icon (static) -->
                                <PathIcon IsVisible="{Binding IsLoading}"
                                          Data="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"
                                          Width="16" Height="16"
                                          Foreground="White" />
                                <TextBlock Text="{loc:Loc Unlock}"
                                           IsVisible="{Binding !IsLoading}" />
                                <TextBlock Text="{loc:Loc 'Unlocking...'}"
                                           IsVisible="{Binding IsLoading}" />
                            </StackPanel>
                        </Button>
                    </Grid>

                    <!-- File Path Hint -->
                    <TextBlock Text="{Binding FilePath}"
                               FontSize="11"
                               Foreground="{DynamicResource TextTertiaryBrush}"
                               HorizontalAlignment="Center"
                               TextTrimming="CharacterEllipsis"
                               MaxWidth="400"
                               ToolTip.Tip="{Binding FilePath}" />
                </StackPanel>

                <!-- Windows Hello Success Animation View -->
                <controls:SuccessAnimation x:Name="SuccessAnimationControl"
                                           IsVisible="{Binding ShowWindowsHelloSuccess}"
                                           Title="{loc:Loc 'Identity Verified!'}"
                                           Message="{loc:Loc 'Windows Hello authentication successful'}"
                                           ContinueButtonText="{loc:Loc Continue}"
                                           ContinueCommand="{Binding ContinueAfterSuccessCommand}"
                                           ShowContinueButton="True"
                                           ContinueButtonDelayMs="1000" />
            </Panel>
        </Border>
    </controls:ModalOverlay>

    <UserControl.Styles>
        <Style Selector="TextBox.password-input">
            <Setter Property="FontSize" Value="14" />
            <Setter Property="Padding" Value="12" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="PasswordChar" Value="*" />
        </Style>
        <Style Selector="TextBox.password-input /template/ Border#PART_BorderElement">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
        </Style>

        <Style Selector="Button.eye-button">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Width" Value="44" />
            <Setter Property="Height" Value="44" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="CornerRadius" Value="0,8,8,0" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Margin" Value="0" />
        </Style>
        <Style Selector="Button.eye-button /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="Transparent" />
        </Style>
        <Style Selector="Button.eye-button:pointerover /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SurfaceHoverBrush}" />
        </Style>
        <Style Selector="Button.eye-button PathIcon">
            <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}" />
        </Style>

        <Style Selector="Button.primary">
            <Setter Property="Background" Value="{DynamicResource PrimaryBrush}" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="FontWeight" Value="Medium" />
            <Setter Property="Padding" Value="16,12" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Cursor" Value="Hand" />
        </Style>
        <Style Selector="Button.primary /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource PrimaryBrush}" />
        </Style>
        <Style Selector="Button.primary:pointerover /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource PrimaryHoverBrush}" />
        </Style>

        <Style Selector="Button.secondary">
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}" />
            <Setter Property="FontWeight" Value="Medium" />
            <Setter Property="Padding" Value="16,12" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Cursor" Value="Hand" />
        </Style>
        <Style Selector="Button.secondary /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}" />
        </Style>
        <Style Selector="Button.secondary:pointerover /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SurfaceHoverBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource BorderHoverBrush}" />
        </Style>
        <Style Selector="Button.secondary:pointerover">
            <Setter Property="BorderBrush" Value="{DynamicResource BorderHoverBrush}" />
        </Style>

        <!-- Windows Hello Button Style -->
        <Style Selector="Button.windows-hello-button">
            <Setter Property="Background" Value="{DynamicResource SurfaceAltBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}" />
            <Setter Property="FontWeight" Value="Medium" />
            <Setter Property="Padding" Value="16,14" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Cursor" Value="Hand" />
        </Style>
        <Style Selector="Button.windows-hello-button /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SurfaceAltBrush}" />
        </Style>
        <Style Selector="Button.windows-hello-button:pointerover /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SurfaceHoverBrush}" />
        </Style>
        <Style Selector="Button.windows-hello-button PathIcon">
            <Setter Property="Foreground" Value="{DynamicResource PrimaryBrush}" />
        </Style>
    </UserControl.Styles>
</UserControl>
