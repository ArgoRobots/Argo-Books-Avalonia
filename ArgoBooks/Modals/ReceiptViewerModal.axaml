<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ArgoBooks.ViewModels"
             xmlns:loc="using:ArgoBooks.Localization"
             xmlns:local="using:ArgoBooks.Converters"
             xmlns:controls="using:ArgoBooks.Controls"
             xmlns:icons="using:ArgoBooks"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="ArgoBooks.Modals.ReceiptViewerModal"
             x:DataType="vm:ReceiptViewerModalViewModel"
             IsVisible="{Binding IsOpen}"
             HorizontalAlignment="Stretch"
             VerticalAlignment="Stretch">

    <Design.DataContext>
        <vm:ReceiptViewerModalViewModel />
    </Design.DataContext>

    <Panel>
        <controls:ModalOverlay IsOpen="{Binding IsOpen}">
            <controls:ModalOverlay.ModalContent>
                <!-- Modal Content -->
                <Border Background="{DynamicResource SurfaceBrush}"
                CornerRadius="12"
                Width="{Binding IsFullscreen, Converter={x:Static local:BoolConverters.ToFullscreenWidth}}"
                Height="{Binding IsFullscreen, Converter={x:Static local:BoolConverters.ToFullscreenHeight}}"
                Margin="{Binding IsFullscreen, Converter={x:Static local:BoolConverters.ToFullscreenMargin}}"
                HorizontalAlignment="{Binding IsFullscreen, Converter={x:Static local:BoolConverters.ToFullscreenHorizontalAlignment}}"
                VerticalAlignment="{Binding IsFullscreen, Converter={x:Static local:BoolConverters.ToFullscreenVerticalAlignment}}"
                KeyDown="Modal_KeyDown">

            <Grid RowDefinitions="Auto,*,Auto">
                <!-- Modal Header -->
                <Border Grid.Row="0"
                        Padding="24,16"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="0,0,0,1">
                    <Grid ColumnDefinitions="*,Auto">
                        <StackPanel>
                            <TextBlock Text="{Binding Title}"
                                       FontSize="18"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextPrimaryBrush}" />
                        </StackPanel>
                        <Button Grid.Column="1"
                                Classes="icon-button"
                                Command="{Binding CloseCommand}">
                            <PathIcon Data="{x:Static icons:Icons.Close}"
                                      Width="20" Height="20" />
                        </Button>
                    </Grid>
                </Border>

                <!-- Receipt Image Preview -->
                <Border Grid.Row="1"
                        Background="{DynamicResource SurfaceAltBrush}"
                        ClipToBounds="True">
                    <Panel>
                        <!-- Scrollable/Zoomable Image Container -->
                        <ScrollViewer x:Name="ImageScrollViewer"
                                      HorizontalScrollBarVisibility="Auto"
                                      VerticalScrollBarVisibility="Auto"
                                      Padding="16">
                            <LayoutTransformControl x:Name="ZoomTransformControl"
                                                    HorizontalAlignment="Center"
                                                    VerticalAlignment="Center">
                                <Image x:Name="ReceiptImage"
                                       Source="{Binding ReceiptPath, Converter={x:Static local:BoolConverters.ToImageSource}}"
                                       Stretch="Uniform" />
                            </LayoutTransformControl>
                        </ScrollViewer>

                        <!-- Fallback for when image can't load -->
                        <StackPanel HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    Spacing="16"
                                    IsVisible="{Binding ReceiptPath, Converter={x:Static StringConverters.IsNullOrEmpty}}">
                            <PathIcon Data="{x:Static icons:Icons.Receipts}"
                                      Width="48" Height="48"
                                      Foreground="{DynamicResource TextTertiaryBrush}" />
                            <TextBlock Text="{loc:Loc 'Receipt preview not available'}"
                                       FontSize="14"
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       HorizontalAlignment="Center" />
                        </StackPanel>
                    </Panel>
                </Border>

                <!-- Modal Footer -->
                <Border Grid.Row="2"
                        Padding="24,12"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="0,1,0,0">
                    <Grid ColumnDefinitions="Auto,Auto,*,Auto">
                        <!-- Left: Fullscreen toggle -->
                        <Button Grid.Column="0"
                                Classes="icon-button"
                                ToolTip.Tip="{loc:Loc 'Toggle Fullscreen (F)'}"
                                Command="{Binding ToggleFullscreenCommand}">
                            <PathIcon Data="{Binding IsFullscreen, Converter={x:Static local:BoolConverters.ToFullscreenIcon}}"
                                      Width="16" Height="16" />
                        </Button>

                        <!-- Download button -->
                        <Button Grid.Column="1"
                                Classes="icon-button"
                                Margin="8,0,0,0"
                                ToolTip.Tip="{loc:Loc 'Download'}"
                                Command="{Binding DownloadCommand}">
                            <PathIcon Data="{x:Static icons:Icons.ExportData}"
                                      Width="16" Height="16" />
                        </Button>

                        <!-- Center: Zoom Controls -->
                        <StackPanel Grid.Column="2"
                                    Orientation="Horizontal"
                                    Spacing="4"
                                    HorizontalAlignment="Center">
                            <Button Classes="icon-button"
                                    Click="ZoomOut_Click"
                                    ToolTip.Tip="{loc:Loc 'Zoom Out (-)'}">
                                <!-- Magnifying glass with minus -->
                                <PathIcon Data="{x:Static icons:Icons.ZoomOut}"
                                          Width="16" Height="16" />
                            </Button>
                            <Slider x:Name="ZoomSlider"
                                    Minimum="0.25"
                                    Maximum="4.0"
                                    Width="120"
                                    VerticalAlignment="Center"
                                    ValueChanged="ZoomSlider_ValueChanged" />
                            <Button Classes="icon-button"
                                    Click="ZoomIn_Click"
                                    ToolTip.Tip="{loc:Loc 'Zoom In (+)'}">
                                <!-- Magnifying glass with plus -->
                                <PathIcon Data="{x:Static icons:Icons.ZoomIn}"
                                          Width="16" Height="16" />
                            </Button>
                            <TextBlock x:Name="ZoomPercentText"
                                       Text="100%"
                                       VerticalAlignment="Center"
                                       FontSize="12"
                                       Width="45"
                                       TextAlignment="Center"
                                       Foreground="{DynamicResource TextSecondaryBrush}" />
                            <Button Classes="icon-button"
                                    Margin="8,0,0,0"
                                    Click="FitToWindow_Click"
                                    ToolTip.Tip="{loc:Loc 'Fit to Window (W)'}">
                                <!-- Fit to window icon: corners with center focus dot -->
                                <PathIcon Data="{x:Static icons:Icons.ScanFocus}"
                                          Width="16" Height="16" />
                            </Button>
                        </StackPanel>

                        <!-- Right: Close button -->
                        <Button Grid.Column="3"
                                Content="{loc:Loc 'Close'}"
                                Classes="secondary-button"
                                Command="{Binding CloseCommand}" />
                    </Grid>
                </Border>
            </Grid>
                </Border>
            </controls:ModalOverlay.ModalContent>
        </controls:ModalOverlay>
    </Panel>
</UserControl>
